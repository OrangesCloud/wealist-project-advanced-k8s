# =============================================================================
# Frontend Rollback Workflow
# =============================================================================
# ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
#
# ì§€ì›í•˜ëŠ” ë¡¤ë°± ë°©ì‹:
#   1. S3 ë¡¤ë°± - ì´ì „ ë²„ì „ í´ë”ë¥¼ ë£¨íŠ¸ë¡œ ë³µì‚¬
#   2. K8s ë¡¤ë°± - ì´ì „ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ë³€ê²½ (ì„ íƒ)
#   3. ë‘˜ ë‹¤ - S3 + K8s ë™ì‹œ ë¡¤ë°±
#
# ì‚¬ìš© ë°©ë²•:
#   1. GitHub Actions â†’ Frontend Rollback â†’ Run workflow
#   2. í™˜ê²½ ì„ íƒ (dev/prod)
#   3. ë¡¤ë°±í•  ë²„ì „ ìž…ë ¥ (ì˜ˆ: v1.0.0, v1.0.0-abc1234)
#   4. ë¡¤ë°± íƒ€ìž… ì„ íƒ (s3, k8s, both)
#   5. Run!
# =============================================================================

name: Frontend Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "ë¡¤ë°±í•  í™˜ê²½"
        required: true
        type: choice
        options:
          - dev
          - prod
      version:
        description: "ë¡¤ë°±í•  ë²„ì „ (ì˜ˆ: v1.0.0, v1.0.0-abc1234)"
        required: true
        type: string
      rollback_type:
        description: "ë¡¤ë°± íƒ€ìž…"
        required: true
        type: choice
        default: "s3"
        options:
          - s3        # S3ë§Œ ë¡¤ë°±
          - k8s       # K8së§Œ ë¡¤ë°± (ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½)
          - both      # S3 + K8s ë‘˜ ë‹¤
      k8s_namespace:
        description: "K8s ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤ (k8s ë¡¤ë°± ì‹œ í•„ìš”)"
        required: false
        default: "wealist-dev"
        type: string
      dry_run:
        description: "Dry Run (ì‹¤ì œ ë¡¤ë°± ì—†ì´ í™•ì¸ë§Œ)"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/frontend

permissions:
  contents: read
  packages: read
  id-token: write

jobs:
  # ===========================================================================
  # Job 1: Validate & Prepare
  # ===========================================================================
  validate:
    name: Validate Rollback Target
    runs-on: ubuntu-latest
    outputs:
      s3_bucket: ${{ steps.config.outputs.s3_bucket }}
      cloudfront_id: ${{ steps.config.outputs.cloudfront_id }}
      version_exists: ${{ steps.check.outputs.version_exists }}

    steps:
      - name: Set environment config
        id: config
        run: |
          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "s3_bucket=${{ secrets.AWS_S3_BUCKET_PROD }}" >> $GITHUB_OUTPUT
            echo "cloudfront_id=${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "s3_bucket=${{ secrets.AWS_S3_BUCKET_DEV }}" >> $GITHUB_OUTPUT
            echo "cloudfront_id=${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials (OIDC)
        if: inputs.rollback_type == 's3' || inputs.rollback_type == 'both'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_FRONTEND }}
          aws-region: ap-northeast-2

      - name: Check S3 version exists
        id: check
        if: inputs.rollback_type == 's3' || inputs.rollback_type == 'both'
        run: |
          VERSION="${{ inputs.version }}"
          BUCKET="${{ steps.config.outputs.s3_bucket }}"

          echo "ðŸ” Checking if version exists: s3://${BUCKET}/${VERSION}/"

          if aws s3 ls "s3://${BUCKET}/${VERSION}/" > /dev/null 2>&1; then
            echo "âœ… Version found!"
            echo "version_exists=true" >> $GITHUB_OUTPUT

            echo "ðŸ“ Files in version folder:"
            aws s3 ls "s3://${BUCKET}/${VERSION}/" --human-readable
          else
            echo "âŒ Version not found: ${VERSION}"
            echo "version_exists=false" >> $GITHUB_OUTPUT

            echo "ðŸ“‹ Available versions:"
            aws s3 ls "s3://${BUCKET}/" | grep -E "PRE v" | head -20
            exit 1
          fi

      - name: Check Docker image exists
        if: inputs.rollback_type == 'k8s' || inputs.rollback_type == 'both'
        run: |
          VERSION="${{ inputs.version }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"

          echo "ðŸ” Checking if image exists: ${IMAGE}"

          # GHCR APIë¡œ í™•ì¸
          if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
            echo "âœ… Image found!"
          else
            echo "âŒ Image not found: ${IMAGE}"
            echo "Available tags can be found at: https://github.com/${{ github.repository }}/pkgs/container/frontend"
            exit 1
          fi
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

      - name: Validation Summary
        run: |
          echo "## ðŸ” Rollback Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Rollback Type** | \`${{ inputs.rollback_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dry Run** | \`${{ inputs.dry_run }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | \`${{ steps.config.outputs.s3_bucket }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: S3 Rollback
  # ===========================================================================
  rollback-s3:
    name: Rollback S3
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.rollback_type == 's3' || inputs.rollback_type == 'both'
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_FRONTEND }}
          aws-region: ap-northeast-2

      - name: Rollback S3 (Dry Run)
        if: inputs.dry_run == true
        run: |
          VERSION="${{ inputs.version }}"
          BUCKET="${{ needs.validate.outputs.s3_bucket }}"

          echo "ðŸ” [DRY RUN] Would sync: s3://${BUCKET}/${VERSION}/ â†’ s3://${BUCKET}/"
          echo ""
          echo "ðŸ“ Source files:"
          aws s3 ls "s3://${BUCKET}/${VERSION}/" --recursive --human-readable | head -20

          echo ""
          echo "ðŸ“ Current root files:"
          aws s3 ls "s3://${BUCKET}/" --human-readable | head -20

      - name: Rollback S3
        if: inputs.dry_run == false
        run: |
          VERSION="${{ inputs.version }}"
          BUCKET="${{ needs.validate.outputs.s3_bucket }}"

          echo "ðŸ”„ Rolling back to version: ${VERSION}"
          echo "ðŸ“¦ Source: s3://${BUCKET}/${VERSION}/"
          echo "ðŸ“¦ Target: s3://${BUCKET}/"

          # ë²„ì „ í´ë”ì—ì„œ ë£¨íŠ¸ë¡œ ë³µì‚¬ (ì‚­ì œ í¬í•¨)
          aws s3 sync "s3://${BUCKET}/${VERSION}/" "s3://${BUCKET}/" \
            --delete \
            --exclude "v*/*" \
            --cache-control "public, max-age=31536000, immutable"

          # index.html, config.js ìºì‹œ ì„¤ì • ë³€ê²½
          aws s3 cp "s3://${BUCKET}/index.html" "s3://${BUCKET}/index.html" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE

          if aws s3 ls "s3://${BUCKET}/config.js" > /dev/null 2>&1; then
            aws s3 cp "s3://${BUCKET}/config.js" "s3://${BUCKET}/config.js" \
              --cache-control "no-cache, no-store, must-revalidate" \
              --metadata-directive REPLACE
          fi

          echo "âœ… S3 rollback complete!"

      - name: Invalidate CloudFront Cache
        if: inputs.dry_run == false
        run: |
          DIST_ID="${{ needs.validate.outputs.cloudfront_id }}"

          echo "ðŸ”„ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${DIST_ID}" \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "ðŸ“‹ Invalidation ID: ${INVALIDATION_ID}"

          # ë¬´íš¨í™” ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id "${DIST_ID}" \
            --id "${INVALIDATION_ID}" || true

          echo "âœ… CloudFront cache invalidated!"

      - name: S3 Rollback Summary
        run: |
          echo "## ðŸ”„ S3 Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **This was a DRY RUN - no changes were made**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Rollback successful!**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | \`${{ needs.validate.outputs.s3_bucket }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **CloudFront** | Cache invalidated |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: K8s Rollback (Image Tag Update)
  # ===========================================================================
  rollback-k8s:
    name: Rollback K8s
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.rollback_type == 'k8s' || inputs.rollback_type == 'both'
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tags for rollback
        if: inputs.dry_run == false
        run: |
          VERSION="${{ inputs.version }}"
          SOURCE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          ENV_TAG="${{ inputs.environment == 'prod' && 'latest' || 'latest-dev' }}"

          echo "ðŸ”„ Rolling back image tags..."
          echo "ðŸ“¦ Source: ${SOURCE}"
          echo "ðŸ·ï¸ Target tag: ${ENV_TAG}"

          # ì´ì „ ë²„ì „ ì´ë¯¸ì§€ë¥¼ pull
          docker pull "${SOURCE}"

          # í™˜ê²½ë³„ latest íƒœê·¸ë¡œ ìž¬ì§€ì •
          docker tag "${SOURCE}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ENV_TAG}"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ENV_TAG}"

          echo "âœ… Image tag updated: ${ENV_TAG} â†’ ${VERSION}"

      - name: K8s Rollback Summary
        run: |
          echo "## ðŸ”„ K8s Image Rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **This was a DRY RUN - no changes were made**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Image tag updated!**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag Updated** | \`${{ inputs.environment == 'prod' && 'latest' || 'latest-dev' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps (Manual)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "K8sì—ì„œ ìƒˆ ì´ë¯¸ì§€ë¥¼ pullí•˜ë ¤ë©´:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout restart deployment/frontend -n ${{ inputs.k8s_namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë˜ëŠ” Helmìœ¼ë¡œ ì§ì ‘ íƒœê·¸ ì§€ì •:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm upgrade frontend ./helm/charts/frontend --set image.tag=${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Final Summary
  # ===========================================================================
  summary:
    name: Rollback Summary
    runs-on: ubuntu-latest
    needs: [validate, rollback-s3, rollback-k8s]
    if: always()

    steps:
      - name: Final Summary
        run: |
          echo "## ðŸŽ‰ Frontend Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Rollback Type** | \`${{ inputs.rollback_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dry Run** | \`${{ inputs.dry_run }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | \`${{ needs.validate.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Rollback | \`${{ needs.rollback-s3.result || 'skipped' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Rollback | \`${{ needs.rollback-k8s.result || 'skipped' }}\` |" >> $GITHUB_STEP_SUMMARY
