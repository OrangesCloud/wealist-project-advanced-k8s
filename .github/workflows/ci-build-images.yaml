# .github/workflows/ci-build-images.yaml
name: Build and Push Images to ECR

on:
  push:
    branches:
      - service-deploy-dev # dev ÌôòÍ≤Ω Î∞∞Ìè¨
      - service-deploy-prod # prod ÌôòÍ≤Ω Î∞∞Ìè¨
    paths:
      - "services/**"
      - "packages/wealist-advanced-go-pkg/**" # Í≥µÌÜµ Î™®Îìà Î≥ÄÍ≤Ω Í∞êÏßÄ
  workflow_dispatch:
    inputs:
      services:
        description: "Services to build (comma-separated, e.g., user-service,board-service). Leave empty for all services."
        required: false
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
      skip_gitops:
        description: "Skip GitOps update trigger"
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-2

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      branch: ${{ steps.branch.outputs.name }}
      environment: ${{ steps.env-config.outputs.environment }}
      ecr_registry: ${{ steps.env-config.outputs.ecr_registry }}
      k8s_branch: ${{ steps.env-config.outputs.k8s_branch }}
      namespace: ${{ steps.env-config.outputs.namespace }}
    steps:
      - uses: actions/checkout@v4

      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      # ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï
      - name: Set environment config
        id: env-config
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"

          # workflow_dispatchÏù∏ Í≤ΩÏö∞ ÏûÖÎ†•Í∞í ÏÇ¨Ïö©
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            # Î∏åÎûúÏπòÎ™ÖÏóêÏÑú ÌôòÍ≤Ω Ï∂îÏ∂ú
            case "${BRANCH}" in
              "service-deploy-dev")
                ENV="dev"
                ;;
              "service-deploy-prod")
                ENV="prod"
                ;;
              *)
                echo "Error: Unknown branch ${BRANCH}"
                exit 1
                ;;
            esac
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT
          echo "k8s_branch=k8s-deploy-${ENV}" >> $GITHUB_OUTPUT

          if [ "${ENV}" = "dev" ]; then
            echo "namespace=wealist-dev" >> $GITHUB_OUTPUT
          else
            echo "namespace=wealist-prod" >> $GITHUB_OUTPUT
          fi

          echo "=== Environment Config ==="
          echo "Environment: ${ENV}"
          echo "K8s Branch: k8s-deploy-${ENV}"

      # Push Ïù¥Î≤§Ìä∏: ÏûêÎèô Í∞êÏßÄ (pushÎêú Ïª§Î∞ãÏùò Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÎπÑÍµê)
      - uses: dorny/paths-filter@v2
        if: github.event_name == 'push'
        id: filter
        with:
          # push Ïù¥Î≤§Ìä∏ÏóêÏÑúÎäî before...after Ïª§Î∞ã ÎπÑÍµê (merge ÏãúÏóêÎèÑ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞êÏßÄ)
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            common-package:
              - 'packages/wealist-advanced-go-pkg/**'
            auth-service:
              - 'services/auth-service/**'
            board-service:
              - 'services/board-service/**'
            chat-service:
              - 'services/chat-service/**'
            noti-service:
              - 'services/noti-service/**'
            storage-service:
              - 'services/storage-service/**'
            user-service:
              - 'services/user-service/**'
            video-service:
              - 'services/video-service/**'

      # ÏàòÎèô Ïã§Ìñâ ÎòêÎäî ÏûêÎèô Í∞êÏßÄ Í≤∞Í≥º ÏÑ§Ï†ï
      - name: Set services to build
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.services }}" ]; then
              # frontend Ï†úÏô∏ (S3/CloudFrontÎ°ú Î≥ÑÎèÑ Î∞∞Ìè¨)
              SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -cR 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(. != "frontend"))')
              echo "Manual trigger with services: ${SERVICES}"
            else
              SERVICES='["auth-service","board-service","chat-service","noti-service","storage-service","user-service","video-service"]'
              echo "Manual trigger: building all services"
            fi
          # Í≥µÌÜµ Ìå®ÌÇ§ÏßÄ Î≥ÄÍ≤Ω Ïãú Î™®Îì† Go ÏÑúÎπÑÏä§ ÎπåÎìú
          elif [ "${{ steps.filter.outputs.common-package }}" = "true" ]; then
            # Í≥µÌÜµ Ìå®ÌÇ§ÏßÄÎßå Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Î™®Îì† Go ÏÑúÎπÑÏä§
            GO_SERVICES='["board-service","chat-service","noti-service","storage-service","user-service","video-service"]'
            # Îã§Î•∏ ÏÑúÎπÑÏä§ÎèÑ Î≥ÄÍ≤ΩÎêòÏóàÏúºÎ©¥ Î≥ëÌï©
            OTHER_CHANGES='${{ steps.filter.outputs.changes }}'
            if [ "${OTHER_CHANGES}" != "[]" ] && [ -n "${OTHER_CHANGES}" ]; then
              # common-package Ï†úÏô∏ÌïòÍ≥† Î≥ëÌï©
              SERVICES=$(echo "${GO_SERVICES}" "${OTHER_CHANGES}" | jq -sc 'add | unique | map(select(. != "common-package"))')
            else
              SERVICES="${GO_SERVICES}"
            fi
            echo "Common package changed - building Go services: ${SERVICES}"
          else
            # common-package Ï†úÏô∏
            SERVICES=$(echo '${{ steps.filter.outputs.changes }}' | jq -c 'map(select(. != "common-package"))')
            echo "Auto-detected services: ${SERVICES}"
          fi

          echo "services=${SERVICES}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != '' }}
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-changes.outputs.environment }}

    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
      fail-fast: false

    permissions:
      id-token: write # OIDC Ïù∏Ï¶ùÏö©
      contents: read
      security-events: write # Trivy Í≤∞Í≥ºÎ•º Security ÌÉ≠Ïóê Ïò¨Î¶¨Í∏∞ ÏúÑÌï¥ ÌïÑÏöî

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # AWS ÏûêÍ≤© Ï¶ùÎ™Ö ÏÑ§Ï†ï (Backend Ï†ÑÏö© Role)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR Î°úÍ∑∏Ïù∏
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ECR Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Ïù¥Î¶Ñ ÏÑ§Ï†ï (prodÎäî prod/ prefix)
      - name: Set ECR repository name
        id: ecr-repo
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          SERVICE="${{ matrix.service }}"

          if [ "${ENV}" = "prod" ]; then
            REPO_NAME="prod/${SERVICE}"
          else
            REPO_NAME="${SERVICE}"
          fi

          echo "name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "ECR Repository: ${REPO_NAME}"

      # ECR Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names ${{ steps.ecr-repo.outputs.name }} 2>/dev/null || \
          aws ecr create-repository \
            --repository-name ${{ steps.ecr-repo.outputs.name }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      # ÏÑúÎπÑÏä§Î≥Ñ Dockerfile Í≤ΩÎ°ú Î∞è ÎπåÎìú Ïª®ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
      - name: Set build configuration
        id: build-config
        run: |
          SERVICE="${{ matrix.service }}"

          case "${SERVICE}" in
            "auth-service")
              # Java/Gradle ÏÑúÎπÑÏä§
              DOCKERFILE="services/${SERVICE}/Dockerfile"
              CONTEXT="services/${SERVICE}"
              ;;
            "board-service"|"chat-service"|"noti-service"|"storage-service"|"user-service"|"video-service")
              # Go ÏÑúÎπÑÏä§Îì§
              DOCKERFILE="services/${SERVICE}/docker/Dockerfile"
              CONTEXT="."
              ;;
            *)
              echo "Error: Unknown service ${SERVICE}"
              exit 1
              ;;
          esac

          echo "dockerfile=${DOCKERFILE}" >> $GITHUB_OUTPUT
          echo "context=${CONTEXT}" >> $GITHUB_OUTPUT
          echo "Service: ${SERVICE}"
          echo "Dockerfile: ${DOCKERFILE}"
          echo "Context: ${CONTEXT}"

      - name: Generate image tags
        id: tags
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          ENV="${{ needs.detect-changes.outputs.environment }}"
          BUILD_NUMBER="${{ github.run_number }}"
          # ECR registryÎ•º ÏßÅÏ†ë Íµ¨ÏÑ± (outputsÏúºÎ°ú Ï†ÑÎã¨ Ïãú secret ÎßàÏä§ÌÇπ Î¨∏Ï†ú ÌöåÌîº)
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          REPO_NAME="${{ steps.ecr-repo.outputs.name }}"

          # ÌÉúÍ∑∏ ÏÉùÏÑ±: Build Number + SHA (Ïòà: 42-abc1234)
          TAG="${BUILD_NUMBER}-${SHORT_SHA}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image_uri=${ECR_REGISTRY}/${REPO_NAME}" >> $GITHUB_OUTPUT

          # prodÎäî IMMUTABLEÏù¥ÎØÄÎ°ú latest ÌÉúÍ∑∏ Î∂àÍ∞Ä
          if [ "${ENV}" = "prod" ]; then
            echo "is_immutable=true" >> $GITHUB_OUTPUT
            TAGS="${ECR_REGISTRY}/${REPO_NAME}:${TAG}"
          else
            echo "is_immutable=false" >> $GITHUB_OUTPUT
            TAGS="${ECR_REGISTRY}/${REPO_NAME}:${TAG},${ECR_REGISTRY}/${REPO_NAME}:latest"
          fi

          echo "all_tags=${TAGS}" >> $GITHUB_OUTPUT

          echo "=== Image Tags ==="
          echo "Environment: ${ENV}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "Tag: ${TAG}"
          echo "Image URI: ${ECR_REGISTRY}/${REPO_NAME}"
          echo "All Tags: ${TAGS}"

      # -------------------------------------------------------------------------
      # Î©ÄÌã∞ ÏïÑÌÇ§ÌÖçÏ≤ò ÎπåÎìú Î∞è ECR Ìë∏Ïãú
      # (Trivy Ïä§Ï∫îÏùÄ PR ValidationÏóêÏÑú ÏôÑÎ£åÎê®)
      # -------------------------------------------------------------------------
      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.all_tags }}
          cache-from: type=gha,scope=${{ matrix.service }}-${{ needs.detect-changes.outputs.environment }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-${{ needs.detect-changes.outputs.environment }}

      - name: Output image info
        run: |
          echo "### üöÄ Image Published to ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-changes.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Repository:** ${{ steps.ecr-repo.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image URI:** ${{ steps.tags.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tags.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

      - name: List recent images and send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_CI_URL }}
        run: |
          SERVICE="${{ matrix.service }}"
          ENV="${{ needs.detect-changes.outputs.environment }}"
          REPO_NAME="${{ steps.ecr-repo.outputs.name }}"
          NEW_TAG="${{ steps.tags.outputs.tag }}"
          
          echo "üì¶ Fetching recent images for ${REPO_NAME}..."
          
          # ECRÏóêÏÑú ÏµúÍ∑º Ïù¥ÎØ∏ÏßÄ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
          RECENT_IMAGES=$(aws ecr describe-images \
            --repository-name "${REPO_NAME}" \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-10:]' \
            --output json | \
            jq -r '.[] | select(.imageTags != null and (.imageTags | length > 0) and (.imageTags[0] != "-")) | 
                  {tag: .imageTags[0], pushed: .imagePushedAt, size: .imageSizeInBytes} | 
                  "\(.tag) | \(.pushed) | \((.size / 1024 / 1024 | floor))MB"' | \
            tail -5)
          
          # Ïù¥ÎØ∏ÏßÄ Í∞úÏàò ÌôïÏù∏
          IMAGE_COUNT=$(echo "$RECENT_IMAGES" | wc -l)
          if [ -z "$RECENT_IMAGES" ] || [ "$IMAGE_COUNT" -eq 0 ]; then
            RECENT_IMAGES="No valid images found"
            IMAGE_COUNT=0
          fi
          
          echo "Found ${IMAGE_COUNT} recent images:"
          echo "$RECENT_IMAGES"
          
          # Discord ÏïåÎ¶º Ï†ÑÏÜ°
          if [ -n "$DISCORD_WEBHOOK" ]; then
            # Ïù¥ÎØ∏ÏßÄ Î™©Î°ùÏùÑ Discord ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            IMAGES_FORMATTED=""
            if [ "$IMAGE_COUNT" -gt 0 ]; then
              IMAGES_FORMATTED=$(echo "$RECENT_IMAGES" | while IFS='|' read -r tag pushed size; do
                tag=$(echo "$tag" | xargs)
                pushed=$(echo "$pushed" | xargs)
                size=$(echo "$size" | xargs)
                
                # ÏÉàÎ°ú ÎπåÎìúÎêú Ïù¥ÎØ∏ÏßÄÎäî ‚ú® ÌëúÏãú
                if [ "$tag" = "$NEW_TAG" ]; then
                  echo "‚ú® \`$tag\` - $pushed ($size)"
                else
                  echo "üì¶ \`$tag\` - $pushed ($size)"
                fi
              done | head -5 | paste -sd '\n' -)
            else
              IMAGES_FORMATTED="No valid images found"
            fi
            
            # ÌôòÍ≤ΩÎ≥Ñ Ïù¥Î™®ÏßÄ
            ENV_EMOJI="üîß"
            if [ "$ENV" = "prod" ]; then
              ENV_EMOJI="üöÄ"
            fi
            
            # jqÎ°ú JSON ÌéòÏù¥Î°úÎìú ÏÉùÏÑ± (--argÎ°ú Ï†ÑÎã¨ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑÎê®)
            PAYLOAD=$(jq -n \
              --arg service "$SERVICE" \
              --arg env "$ENV" \
              --arg env_emoji "$ENV_EMOJI" \
              --arg new_tag "$NEW_TAG" \
              --arg repo_name "$REPO_NAME" \
              --arg images "$IMAGES_FORMATTED" \
              --arg image_count "$IMAGE_COUNT" \
              --arg build_num "${{ github.run_number }}" \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
              '{
                embeds: [{
                  title: "\($env_emoji) Image Build Complete",
                  description: "**Service**: `\($service)`\n**Environment**: `\($env)`\n**New Tag**: `\($new_tag)`",
                  color: 3447003,
                  fields: [
                    {
                      name: "üì¶ Recent Images (Latest 5)",
                      value: $images,
                      inline: false
                    },
                    {
                      name: "üîó ECR Repository",
                      value: "`\($repo_name)`",
                      inline: true
                    },
                    {
                      name: "üìä Total Images",
                      value: "\($image_count) available",
                      inline: true
                    }
                  ],
                  footer: {
                    text: "GitHub Actions ‚Ä¢ Build #\($build_num)"
                  },
                  timestamp: $timestamp
                }]
              }')
            
            curl -H "Content-Type: application/json" \
                -X POST \
                -d "$PAYLOAD" \
                "$DISCORD_WEBHOOK"
            
            echo "‚úÖ Discord notification sent for ${SERVICE}"
          else
            echo "‚ö†Ô∏è Discord webhook not configured (DISCORD_WEBHOOK_CI_URL secret missing)"
          fi
  update-gitops-manifests:
    needs: [detect-changes, build-and-push]
    if: |
      needs.detect-changes.outputs.services != '[]' &&
      needs.detect-changes.outputs.services != '' &&
      needs.detect-changes.outputs.branch != 'service-deploy-prod' &&  
      success() &&
      github.event.inputs.skip_gitops != 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-changes.outputs.environment }}

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Set environment variables
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          ENV="${{ needs.detect-changes.outputs.environment }}"
          BUILD_NUMBER="${{ github.run_number }}"
          # ÌÉúÍ∑∏ ÌòïÏãù: Build Number + SHA (Ïòà: 42-abc1234)
          NEW_TAG="${BUILD_NUMBER}-${SHORT_SHA}"
          K8S_BRANCH="${{ needs.detect-changes.outputs.k8s_branch }}"
          # ECR registryÎ•º ÏßÅÏ†ë Íµ¨ÏÑ± (outputsÏúºÎ°ú Ï†ÑÎã¨ Ïãú secret ÎßàÏä§ÌÇπ Î¨∏Ï†ú ÌöåÌîº)
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
          echo "K8S_BRANCH=${K8S_BRANCH}" >> $GITHUB_ENV
          echo "ECR_REGISTRY=${ECR_REGISTRY}" >> $GITHUB_ENV
          echo "NAMESPACE=${{ needs.detect-changes.outputs.namespace }}" >> $GITHUB_ENV
          echo "ENV=${ENV}" >> $GITHUB_ENV

          echo "=== GitOps Config ==="
          echo "Environment: ${ENV}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "New Tag: ${NEW_TAG}"
          echo "K8s Branch: ${K8S_BRANCH}"
          echo "ECR Registry: ${ECR_REGISTRY}"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

      - name: Checkout or create k8s branch
        run: |
          if git ls-remote --heads origin ${K8S_BRANCH} | grep -q ${K8S_BRANCH}; then
            echo "Branch ${K8S_BRANCH} exists"
            git fetch origin ${K8S_BRANCH}
            git checkout ${K8S_BRANCH}
          else
            echo "Branch ${K8S_BRANCH} does not exist. Creating it..."
            git checkout -b ${K8S_BRANCH}
            git push origin ${K8S_BRANCH}
          fi

      - name: Update manifest files
        run: |
          SERVICES='${{ needs.detect-changes.outputs.services }}'

          echo "Updating image tags to: ${NEW_TAG}"
          echo "ECR Registry: ${ECR_REGISTRY}"
          echo "Environment: ${ENV}"
          echo "Services to update: ${SERVICES}"

          for service in $(echo $SERVICES | jq -r '.[]'); do
            # ÌôòÍ≤ΩÎ≥Ñ Í≤ΩÎ°ú ÏÇ¨Ïö© (dev/ ÎòêÎäî prod/)
            MANIFEST_FILE="k8s/argocd/apps/${ENV}/${service}.yaml"

            if [ -f "$MANIFEST_FILE" ]; then
              echo "Updating ${MANIFEST_FILE}"

              # image.repository ÏóÖÎç∞Ïù¥Ìä∏ (prodÎäî prod/ prefix Ï∂îÍ∞Ä)
              if [ "${ENV}" = "prod" ]; then
                REPO_NAME="prod/${service}"
              else
                REPO_NAME="${service}"
              fi

              sed -i.bak '/- name: image\.repository/{
                n
                s|value: ".*"|value: "'"${REPO_NAME}"'"|
              }' "$MANIFEST_FILE"

              # image.tag ÏóÖÎç∞Ïù¥Ìä∏
              sed -i.bak '/- name: image\.tag/{
                n
                s|value: ".*"|value: "'"${NEW_TAG}"'"|
              }' "$MANIFEST_FILE"

              # global.imageRegistry ÏóÖÎç∞Ïù¥Ìä∏ (ECR Î†àÏßÄÏä§Ìä∏Î¶¨)
              sed -i.bak '/- name: global\.imageRegistry/{
                n
                s|value: ".*"|value: "'"${ECR_REGISTRY}"'"|
              }' "$MANIFEST_FILE"

              rm -f "${MANIFEST_FILE}.bak"

              echo "Updated ${service}:"
              echo "  - Repository: ${REPO_NAME}"
              echo "  - Tag: ${NEW_TAG}"
              echo "=== Changes in ${MANIFEST_FILE} ==="
              git diff "$MANIFEST_FILE" || true
              echo "=================================="
            else
              echo "Warning: Manifest file not found: ${MANIFEST_FILE}"
            fi
          done

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          echo "Changed files:"
          git diff --name-only

          git add .

          # Î©ÄÌã∞ÎùºÏù∏ Ïª§Î∞ã Î©îÏãúÏßÄ
          COMMIT_MSG="üöÄ [${NAMESPACE}] Update image tags (Build #${BUILD_NUMBER})"
          COMMIT_MSG="${COMMIT_MSG}"$'\n\n'"Services: ${{ needs.detect-changes.outputs.services }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Environment: ${{ needs.detect-changes.outputs.environment }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Build: #${BUILD_NUMBER}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Tag: ${NEW_TAG}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Commit: ${{ github.sha }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n\n'"Updated by: ${{ github.actor }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Triggered by: ${{ github.event_name }}"

          git commit -m "${COMMIT_MSG}"

          git push origin ${K8S_BRANCH}

          echo "‚úÖ Successfully updated manifests in ${K8S_BRANCH} branch"

      - name: Create deployment summary
        run: |
          echo "## üöÄ GitOps Manifest Update (ECR)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-changes.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Updated Services:** ${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${K8S_BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${NAMESPACE}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** #${BUILD_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${NEW_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD will automatically sync these changes.**" >> $GITHUB_STEP_SUMMARY

  # Ï†ÑÏ≤¥ ÎπåÎìú ÏôÑÎ£å ÏïåÎ¶º
  build-complete-notification:
    needs: [detect-changes, build-and-push]
    if: always() && needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    
    steps:
      - name: Send build completion summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_CI_URL }}
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          SERVICES='${{ needs.detect-changes.outputs.services }}'
          BUILD_STATUS="${{ needs.build-and-push.result }}"
          
          # ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï
          if [ "$ENV" = "prod" ]; then
            ENV_EMOJI="üöÄ"
            ENV_COLOR=15158332  # Red for production
          else
            ENV_EMOJI="üîß"
            ENV_COLOR=3447003   # Blue for dev
          fi
          
          # ÎπåÎìú ÏÉÅÌÉúÎ≥Ñ ÏÑ§Ï†ï
          if [ "$BUILD_STATUS" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="Build Successful"
            STATUS_COLOR=3066993  # Green
          elif [ "$BUILD_STATUS" = "failure" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Build Failed"
            STATUS_COLOR=15158332  # Red
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="Build Completed with Issues"
            STATUS_COLOR=16776960  # Yellow
          fi
          
          # ÏÑúÎπÑÏä§ Î™©Î°ù Ìè¨Îß∑ÌåÖ
          SERVICES_LIST=$(echo "$SERVICES" | jq -r '.[]' | sed 's/^/‚Ä¢ `/' | sed 's/$/`/' | tr '\n' '\n')
          SERVICE_COUNT=$(echo "$SERVICES" | jq -r '. | length')
          
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"${STATUS_EMOJI} ${STATUS_TEXT}\",
                     \"description\": \"**Environment**: ${ENV_EMOJI} \`${ENV}\`\\n**Build**: #${{ github.run_number }}\\n**Trigger**: ${{ github.event_name }}\",
                     \"color\": ${STATUS_COLOR},
                     \"fields\": [
                       {
                         \"name\": \"üì¶ Built Services (${SERVICE_COUNT})\",
                         \"value\": \"${SERVICES_LIST}\",
                         \"inline\": false
                       },
                       {
                         \"name\": \"üë§ Triggered by\",
                         \"value\": \"${{ github.actor }}\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"üåø Branch\",
                         \"value\": \"\`${{ github.ref_name }}\`\",
                         \"inline\": true
                       }
                     ],
                     \"footer\": {
                       \"text\": \"GitHub Actions ‚Ä¢ wealist-project-advanced-k8s\"
                     },
                     \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                   }]
                 }" \
                 "$DISCORD_WEBHOOK"
            
            echo "‚úÖ Build completion notification sent to Discord"
          else
            echo "‚ö†Ô∏è Discord webhook not configured"
          fi
