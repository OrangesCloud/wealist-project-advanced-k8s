# .github/workflows/ci-build-images.yaml
name: Build and Push Images to ECR

on:
  push:
    branches:
      - service-deploy-dev # dev í™˜ê²½ ë°°í¬
      - service-deploy-prod # prod í™˜ê²½ ë°°í¬
    paths:
      - "services/**"
      - "packages/wealist-advanced-go-pkg/**" # ê³µí†µ ëª¨ë“ˆ ë³€ê²½ ê°ì§€
  workflow_dispatch:
    inputs:
      services:
        description: "Services to build (comma-separated, e.g., user-service,board-service). Leave empty for all services."
        required: false
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
      skip_gitops:
        description: "Skip GitOps update trigger"
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-2

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      branch: ${{ steps.branch.outputs.name }}
      environment: ${{ steps.env-config.outputs.environment }}
      ecr_registry: ${{ steps.env-config.outputs.ecr_registry }}
      k8s_branch: ${{ steps.env-config.outputs.k8s_branch }}
      namespace: ${{ steps.env-config.outputs.namespace }}
    steps:
      - uses: actions/checkout@v4

      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      # í™˜ê²½ë³„ ì„¤ì •
      - name: Set environment config
        id: env-config
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"

          # workflow_dispatchì¸ ê²½ìš° ìž…ë ¥ê°’ ì‚¬ìš©
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            # ë¸Œëžœì¹˜ëª…ì—ì„œ í™˜ê²½ ì¶”ì¶œ
            case "${BRANCH}" in
              "service-deploy-dev")
                ENV="dev"
                ;;
              "service-deploy-prod")
                ENV="prod"
                ;;
              *)
                echo "Error: Unknown branch ${BRANCH}"
                exit 1
                ;;
            esac
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT
          echo "k8s_branch=k8s-deploy-${ENV}" >> $GITHUB_OUTPUT

          if [ "${ENV}" = "dev" ]; then
            echo "namespace=wealist-dev" >> $GITHUB_OUTPUT
          else
            echo "namespace=wealist-prod" >> $GITHUB_OUTPUT
          fi

          echo "=== Environment Config ==="
          echo "Environment: ${ENV}"
          echo "K8s Branch: k8s-deploy-${ENV}"

      # Push ì´ë²¤íŠ¸: ìžë™ ê°ì§€ (pushëœ ì»¤ë°‹ì˜ ë³€ê²½ì‚¬í•­ ë¹„êµ)
      - uses: dorny/paths-filter@v2
        if: github.event_name == 'push'
        id: filter
        with:
          # push ì´ë²¤íŠ¸ì—ì„œëŠ” before...after ì»¤ë°‹ ë¹„êµ (merge ì‹œì—ë„ ë³€ê²½ì‚¬í•­ ê°ì§€)
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            common-package:
              - 'packages/wealist-advanced-go-pkg/**'
            auth-service:
              - 'services/auth-service/**'
            board-service:
              - 'services/board-service/**'
            chat-service:
              - 'services/chat-service/**'
            noti-service:
              - 'services/noti-service/**'
            storage-service:
              - 'services/storage-service/**'
            user-service:
              - 'services/user-service/**'
            video-service:
              - 'services/video-service/**'

      # ìˆ˜ë™ ì‹¤í–‰ ë˜ëŠ” ìžë™ ê°ì§€ ê²°ê³¼ ì„¤ì •
      - name: Set services to build
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.services }}" ]; then
              # frontend ì œì™¸ (S3/CloudFrontë¡œ ë³„ë„ ë°°í¬)
              SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -cR 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(. != "frontend"))')
              echo "Manual trigger with services: ${SERVICES}"
            else
              SERVICES='["auth-service","board-service","chat-service","noti-service","storage-service","user-service","video-service"]'
              echo "Manual trigger: building all services"
            fi
          # ê³µí†µ íŒ¨í‚¤ì§€ ë³€ê²½ ì‹œ ëª¨ë“  Go ì„œë¹„ìŠ¤ ë¹Œë“œ
          elif [ "${{ steps.filter.outputs.common-package }}" = "true" ]; then
            # ê³µí†µ íŒ¨í‚¤ì§€ë§Œ ë³€ê²½ëœ ê²½ìš° ëª¨ë“  Go ì„œë¹„ìŠ¤
            GO_SERVICES='["board-service","chat-service","noti-service","storage-service","user-service","video-service"]'
            # ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë„ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë³‘í•©
            OTHER_CHANGES='${{ steps.filter.outputs.changes }}'
            if [ "${OTHER_CHANGES}" != "[]" ] && [ -n "${OTHER_CHANGES}" ]; then
              # common-package ì œì™¸í•˜ê³  ë³‘í•©
              SERVICES=$(echo "${GO_SERVICES}" "${OTHER_CHANGES}" | jq -sc 'add | unique | map(select(. != "common-package"))')
            else
              SERVICES="${GO_SERVICES}"
            fi
            echo "Common package changed - building Go services: ${SERVICES}"
          else
            # common-package ì œì™¸
            SERVICES=$(echo '${{ steps.filter.outputs.changes }}' | jq -c 'map(select(. != "common-package"))')
            echo "Auto-detected services: ${SERVICES}"
          fi

          echo "services=${SERVICES}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '[]' && needs.detect-changes.outputs.services != '' }}
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-changes.outputs.environment }}

    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
      fail-fast: false

    permissions:
      id-token: write # OIDC ì¸ì¦ìš©
      contents: read
      security-events: write # Trivy ê²°ê³¼ë¥¼ Security íƒ­ì— ì˜¬ë¦¬ê¸° ìœ„í•´ í•„ìš”

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # AWS ìžê²© ì¦ëª… ì„¤ì • (Backend ì „ìš© Role)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ì„¤ì • (prodëŠ” prod/ prefix)
      - name: Set ECR repository name
        id: ecr-repo
        run: |
          ENV="${{ needs.detect-changes.outputs.environment }}"
          SERVICE="${{ matrix.service }}"

          if [ "${ENV}" = "prod" ]; then
            REPO_NAME="prod/${SERVICE}"
          else
            REPO_NAME="${SERVICE}"
          fi

          echo "name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "ECR Repository: ${REPO_NAME}"

      # ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names ${{ steps.ecr-repo.outputs.name }} 2>/dev/null || \
          aws ecr create-repository \
            --repository-name ${{ steps.ecr-repo.outputs.name }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      # ì„œë¹„ìŠ¤ë³„ Dockerfile ê²½ë¡œ ë° ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
      - name: Set build configuration
        id: build-config
        run: |
          SERVICE="${{ matrix.service }}"

          case "${SERVICE}" in
            "auth-service")
              # Java/Gradle ì„œë¹„ìŠ¤
              DOCKERFILE="services/${SERVICE}/Dockerfile"
              CONTEXT="services/${SERVICE}"
              ;;
            "board-service"|"chat-service"|"noti-service"|"storage-service"|"user-service"|"video-service")
              # Go ì„œë¹„ìŠ¤ë“¤
              DOCKERFILE="services/${SERVICE}/docker/Dockerfile"
              CONTEXT="."
              ;;
            *)
              echo "Error: Unknown service ${SERVICE}"
              exit 1
              ;;
          esac

          echo "dockerfile=${DOCKERFILE}" >> $GITHUB_OUTPUT
          echo "context=${CONTEXT}" >> $GITHUB_OUTPUT
          echo "Service: ${SERVICE}"
          echo "Dockerfile: ${DOCKERFILE}"
          echo "Context: ${CONTEXT}"

      - name: Generate image tags
        id: tags
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          ENV="${{ needs.detect-changes.outputs.environment }}"
          BUILD_NUMBER="${{ github.run_number }}"
          # ECR registryë¥¼ ì§ì ‘ êµ¬ì„± (outputsìœ¼ë¡œ ì „ë‹¬ ì‹œ secret ë§ˆìŠ¤í‚¹ ë¬¸ì œ íšŒí”¼)
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          REPO_NAME="${{ steps.ecr-repo.outputs.name }}"

          # íƒœê·¸ ìƒì„±: Build Number + SHA (ì˜ˆ: 42-abc1234)
          TAG="${BUILD_NUMBER}-${SHORT_SHA}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image_uri=${ECR_REGISTRY}/${REPO_NAME}" >> $GITHUB_OUTPUT

          # prodëŠ” IMMUTABLEì´ë¯€ë¡œ latest íƒœê·¸ ë¶ˆê°€
          if [ "${ENV}" = "prod" ]; then
            echo "is_immutable=true" >> $GITHUB_OUTPUT
            TAGS="${ECR_REGISTRY}/${REPO_NAME}:${TAG}"
          else
            echo "is_immutable=false" >> $GITHUB_OUTPUT
            TAGS="${ECR_REGISTRY}/${REPO_NAME}:${TAG},${ECR_REGISTRY}/${REPO_NAME}:latest"
          fi

          echo "all_tags=${TAGS}" >> $GITHUB_OUTPUT

          echo "=== Image Tags ==="
          echo "Environment: ${ENV}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "Tag: ${TAG}"
          echo "Image URI: ${ECR_REGISTRY}/${REPO_NAME}"
          echo "All Tags: ${TAGS}"

      # -------------------------------------------------------------------------
      # ë©€í‹° ì•„í‚¤í…ì²˜ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      # (Trivy ìŠ¤ìº”ì€ PR Validationì—ì„œ ì™„ë£Œë¨)
      # -------------------------------------------------------------------------
      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.all_tags }}
          cache-from: type=gha,scope=${{ matrix.service }}-${{ needs.detect-changes.outputs.environment }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-${{ needs.detect-changes.outputs.environment }}

      - name: Output image info
        run: |
          echo "### ðŸš€ Image Published to ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-changes.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Repository:** ${{ steps.ecr-repo.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image URI:** ${{ steps.tags.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tags.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  update-gitops-manifests:
    needs: [detect-changes, build-and-push]
    if: |
      needs.detect-changes.outputs.services != '[]' &&
      needs.detect-changes.outputs.services != '' &&
      needs.detect-changes.outputs.branch != 'service-deploy-prod' &&  
      success() &&
      github.event.inputs.skip_gitops != 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-changes.outputs.environment }}

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Set environment variables
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          ENV="${{ needs.detect-changes.outputs.environment }}"
          BUILD_NUMBER="${{ github.run_number }}"
          # íƒœê·¸ í˜•ì‹: Build Number + SHA (ì˜ˆ: 42-abc1234)
          NEW_TAG="${BUILD_NUMBER}-${SHORT_SHA}"
          K8S_BRANCH="${{ needs.detect-changes.outputs.k8s_branch }}"
          # ECR registryë¥¼ ì§ì ‘ êµ¬ì„± (outputsìœ¼ë¡œ ì „ë‹¬ ì‹œ secret ë§ˆìŠ¤í‚¹ ë¬¸ì œ íšŒí”¼)
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
          echo "K8S_BRANCH=${K8S_BRANCH}" >> $GITHUB_ENV
          echo "ECR_REGISTRY=${ECR_REGISTRY}" >> $GITHUB_ENV
          echo "NAMESPACE=${{ needs.detect-changes.outputs.namespace }}" >> $GITHUB_ENV
          echo "ENV=${ENV}" >> $GITHUB_ENV

          echo "=== GitOps Config ==="
          echo "Environment: ${ENV}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "New Tag: ${NEW_TAG}"
          echo "K8s Branch: ${K8S_BRANCH}"
          echo "ECR Registry: ${ECR_REGISTRY}"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

      - name: Checkout or create k8s branch
        run: |
          if git ls-remote --heads origin ${K8S_BRANCH} | grep -q ${K8S_BRANCH}; then
            echo "Branch ${K8S_BRANCH} exists"
            git fetch origin ${K8S_BRANCH}
            git checkout ${K8S_BRANCH}
          else
            echo "Branch ${K8S_BRANCH} does not exist. Creating it..."
            git checkout -b ${K8S_BRANCH}
            git push origin ${K8S_BRANCH}
          fi

      - name: Update manifest files
        run: |
          SERVICES='${{ needs.detect-changes.outputs.services }}'

          echo "Updating image tags to: ${NEW_TAG}"
          echo "ECR Registry: ${ECR_REGISTRY}"
          echo "Environment: ${ENV}"
          echo "Services to update: ${SERVICES}"

          for service in $(echo $SERVICES | jq -r '.[]'); do
            # í™˜ê²½ë³„ ê²½ë¡œ ì‚¬ìš© (dev/ ë˜ëŠ” prod/)
            MANIFEST_FILE="k8s/argocd/apps/${ENV}/${service}.yaml"

            if [ -f "$MANIFEST_FILE" ]; then
              echo "Updating ${MANIFEST_FILE}"

              # image.repository ì—…ë°ì´íŠ¸ (prodëŠ” prod/ prefix ì¶”ê°€)
              if [ "${ENV}" = "prod" ]; then
                REPO_NAME="prod/${service}"
              else
                REPO_NAME="${service}"
              fi

              sed -i.bak '/- name: image\.repository/{
                n
                s|value: ".*"|value: "'"${REPO_NAME}"'"|
              }' "$MANIFEST_FILE"

              # image.tag ì—…ë°ì´íŠ¸
              sed -i.bak '/- name: image\.tag/{
                n
                s|value: ".*"|value: "'"${NEW_TAG}"'"|
              }' "$MANIFEST_FILE"

              # global.imageRegistry ì—…ë°ì´íŠ¸ (ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬)
              sed -i.bak '/- name: global\.imageRegistry/{
                n
                s|value: ".*"|value: "'"${ECR_REGISTRY}"'"|
              }' "$MANIFEST_FILE"

              rm -f "${MANIFEST_FILE}.bak"

              echo "Updated ${service}:"
              echo "  - Repository: ${REPO_NAME}"
              echo "  - Tag: ${NEW_TAG}"
              echo "=== Changes in ${MANIFEST_FILE} ==="
              git diff "$MANIFEST_FILE" || true
              echo "=================================="
            else
              echo "Warning: Manifest file not found: ${MANIFEST_FILE}"
            fi
          done

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          echo "Changed files:"
          git diff --name-only

          git add .

          # ë©€í‹°ë¼ì¸ ì»¤ë°‹ ë©”ì‹œì§€
          COMMIT_MSG="ðŸš€ [${NAMESPACE}] Update image tags (Build #${BUILD_NUMBER})"
          COMMIT_MSG="${COMMIT_MSG}"$'\n\n'"Services: ${{ needs.detect-changes.outputs.services }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Environment: ${{ needs.detect-changes.outputs.environment }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Build: #${BUILD_NUMBER}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Tag: ${NEW_TAG}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Commit: ${{ github.sha }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n\n'"Updated by: ${{ github.actor }}"
          COMMIT_MSG="${COMMIT_MSG}"$'\n'"Triggered by: ${{ github.event_name }}"

          git commit -m "${COMMIT_MSG}"

          git push origin ${K8S_BRANCH}

          echo "âœ… Successfully updated manifests in ${K8S_BRANCH} branch"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ GitOps Manifest Update (ECR)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.detect-changes.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Updated Services:** ${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${K8S_BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${NAMESPACE}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** #${BUILD_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${NEW_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD will automatically sync these changes.**" >> $GITHUB_STEP_SUMMARY
