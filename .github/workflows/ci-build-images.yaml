name: Build and Push Images to ECR

on:
  push:
    branches:
      - service-deploy-dev
      - service-deploy-prod
    paths:
      - "services/**"
      - "packages/wealist-advanced-go-pkg/**"
  workflow_dispatch:
    inputs:
      services:
        description: "Services to build (comma-separated)"
        required: false
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - develop
          - prod
        default: develop

env:
  AWS_REGION: ap-northeast-2

jobs:
  validate-branch:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run
        id: check
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${BRANCH}" = "service-deploy-dev" ] || [ "${BRANCH}" = "service-deploy-prod" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    needs: validate-branch
    if: needs.validate-branch.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      environment: ${{ steps.env-config.outputs.environment }}
      ecr_registry: ${{ steps.env-config.outputs.ecr_registry }}
      k8s_branch: ${{ steps.env-config.outputs.k8s_branch }}
      namespace: ${{ steps.env-config.outputs.namespace }}
    steps:
      - uses: actions/checkout@v4
      - name: Set environment config
        id: env-config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            [[ "${GITHUB_REF#refs/heads/}" == "service-deploy-prod" ]] && ENV="prod" || ENV="develop"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT
          [ "${ENV}" = "prod" ] && echo "k8s_branch=k8s-deploy-prod" >> $GITHUB_OUTPUT || echo "k8s_branch=k8s-deploy-dev" >> $GITHUB_OUTPUT
          [ "${ENV}" = "prod" ] && echo "namespace=wealist-prod" >> $GITHUB_OUTPUT || echo "namespace=wealist-dev" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            common-package: ['packages/wealist-advanced-go-pkg/**']
            auth-service: ['services/auth-service/**']
            board-service: ['services/board-service/**']
            chat-service: ['services/chat-service/**']
            noti-service: ['services/noti-service/**']
            storage-service: ['services/storage-service/**']
            user-service: ['services/user-service/**']
            ops-service: ['services/ops-service/**']
            ops-portal: ['services/ops-portal/**']

      - name: Set services to build
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.services }}" ]; then
            SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -cR 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          elif [ "${{ steps.filter.outputs.common-package }}" = "true" ]; then
            SERVICES='["board-service","chat-service","noti-service","storage-service","user-service","ops-service"]'
          else
            SERVICES='${{ steps.filter.outputs.changes }}'
          fi
          echo "services=${SERVICES}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: [validate-branch, detect-changes]
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    # environment를 명시하여 해당 환경의 secrets를 우선 참조하게 함
    environment: ${{ needs.detect-changes.outputs.environment }}
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
      fail-fast: false
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Repository Secrets로 옮긴 ARN 사용
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service == 'auth-service' && format('services/{0}', matrix.service) || (matrix.service == 'ops-portal' && format('services/{0}', matrix.service) || '.') }}
          file: ${{ matrix.service == 'auth-service' && format('services/{0}/Dockerfile', matrix.service) || format('services/{0}/docker/Dockerfile', matrix.service) }}
          push: true
          # matrix 기반 태그 생성
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ needs.detect-changes.outputs.environment == 'prod' && 'prod/' || '' }}${{ matrix.service }}:${{ github.run_number }}-${{ github.sha }}
            ${{ needs.detect-changes.outputs.environment != 'prod' && format('{0}/{1}:latest', steps.login-ecr.outputs.registry, matrix.service) || '' }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
