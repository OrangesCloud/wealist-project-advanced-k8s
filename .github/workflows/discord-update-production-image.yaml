name: Discord Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to update (comma-separated, e.g., auth-service,board-service or "all" for all services)'
        required: true
        type: string
        default: 'all'
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  list-available-images:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      services_to_update: ${{ steps.parse-services.outputs.services }}
    steps:
      - name: Parse services input
        id: parse-services
        run: |
          ALL_SERVICES="auth-service,board-service,chat-service,noti-service,storage-service,user-service,video-service"
          
          if [ "${{ inputs.services }}" = "all" ]; then
            SERVICES="$ALL_SERVICES"
          else
            SERVICES="${{ inputs.services }}"
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Services to update: $SERVICES"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List recent prod images and verify
        run: |
          IFS=',' read -ra SERVICES_ARRAY <<< "${{ steps.parse-services.outputs.services }}"
          
          echo "### üì¶ Recent Images and Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for service in "${SERVICES_ARRAY[@]}"; do
            service=$(echo "$service" | xargs) # trim whitespace
            echo "#### Service: $service" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # List recent images
            aws ecr describe-images \
              --repository-name "prod/$service" \
              --region ${{ env.AWS_REGION }} \
              --query 'sort_by(imageDetails,& imagePushedAt)[-5:].[imageTags[0],imagePushedAt]' \
              --output table >> $GITHUB_STEP_SUMMARY || echo "No images found for $service" >> $GITHUB_STEP_SUMMARY
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Verify selected image exists
            echo "Verifying image: prod/$service:${{ inputs.image_tag }}"
            if aws ecr describe-images \
              --repository-name "prod/$service" \
              --region ${{ env.AWS_REGION }} \
              --image-ids imageTag=${{ inputs.image_tag }} > /dev/null 2>&1; then
              echo "‚úÖ Image verified for $service"
            else
              echo "‚ùå Image not found for $service: prod/$service:${{ inputs.image_tag }}"
              exit 1
            fi
          done

  update-manifest:
    needs: list-available-images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Checkout k8s-deploy-prod branch
        run: |
          git fetch origin k8s-deploy-prod
          git checkout k8s-deploy-prod

      - name: Update ArgoCD Application manifests
        id: update-manifest
        run: |
          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.list-available-images.outputs.services_to_update }}"
          TAG="${{ inputs.image_tag }}"
          
          UPDATED_SERVICES=""
          
          for service in "${SERVICES_ARRAY[@]}"; do
            service=$(echo "$service" | xargs) # trim whitespace
            
            # ArgoCD Application manifest Í≤ΩÎ°ú
            MANIFEST="k8s/argocd/apps/prod/${service}.yaml"
            
            if [ ! -f "$MANIFEST" ]; then
              echo "‚ùå Manifest file not found: ${MANIFEST}"
              continue
            fi
            
            echo "üìù Updating ${MANIFEST}"
            echo "New tag: ${TAG}"
            
            # image.tag ÌååÎùºÎØ∏ÌÑ∞Îßå ÏóÖÎç∞Ïù¥Ìä∏
            sed -i.bak '/- name: image\.tag/{n;s|value: ".*"|value: "'"${TAG}"'"|}' "$MANIFEST"
            rm -f "${MANIFEST}.bak"
            
            echo ""
            echo "=== Updated section for $service ==="
            grep -A 1 "name: image.tag" "$MANIFEST"
            echo "=================================="
            echo ""
            
            if [ -n "$UPDATED_SERVICES" ]; then
              UPDATED_SERVICES="$UPDATED_SERVICES,$service"
            else
              UPDATED_SERVICES="$service"
            fi
          done
          
          echo "updated_services=$UPDATED_SERVICES" >> $GITHUB_OUTPUT
          
          # Ï†ÑÏ≤¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          git diff

      - name: Create PR or commit
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
        run: |
          UPDATED_SERVICES="${{ steps.update-manifest.outputs.updated_services }}"
          TAG="${{ inputs.image_tag }}"
          
          if [ "${{ inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="deploy/multi-service-${TAG}-$(date +%s)"
            
            # ÏÉà Î∏åÎûúÏπò ÏÉùÏÑ±
            git checkout -b "$BRANCH_NAME"
            git add .
            git commit -m "üöÄ [PROD] Deploy Multiple Services - ${TAG}

Services: ${UPDATED_SERVICES}"
            git push origin "$BRANCH_NAME"
            
            # PR body ÏÉùÏÑ±
            PR_BODY="## Production Multi-Service Deployment Request

**Image Tag:** \`${TAG}\`  
**Updated Services:** \`${UPDATED_SERVICES}\`

### Services and Manifests
"
            
            IFS=',' read -ra SERVICES_ARRAY <<< "$UPDATED_SERVICES"
            for service in "${SERVICES_ARRAY[@]}"; do
              service=$(echo "$service" | xargs)
              PR_BODY="${PR_BODY}
- **${service}**: \`prod/${service}:${TAG}\` ‚Üí \`k8s/argocd/apps/prod/${service}.yaml\`"
            done
            
            PR_BODY="${PR_BODY}

### Pre-deployment Checklist
- [ ] Dev/Staging ÌÖåÏä§Ìä∏ ÏôÑÎ£å
- [ ] ÏÑ±Îä• Î∞è Î¶¨ÏÜåÏä§ Í≤ÄÌÜ† ÏôÑÎ£å
- [ ] ÌåÄÏõê ÏäπÏù∏ ÏôÑÎ£å

### Deployment Steps
1. Ïù¥ PR Î¶¨Î∑∞ Î∞è ÏäπÏù∏
2. PR Merge
3. ArgoCD UIÏóêÏÑú Í∞Å ÏÑúÎπÑÏä§Ïùò **-prod** Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÎì§ÏùÑ **Sync**
4. Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ (Discord ÏïåÎ¶º ÌôïÏù∏)

### ArgoCD Applications to Sync
"
            
            for service in "${SERVICES_ARRAY[@]}"; do
              service=$(echo "$service" | xargs)
              PR_BODY="${PR_BODY}
- \`${service}-prod\`"
            done
            
            PR_BODY="${PR_BODY}

---
‚ö†Ô∏è **Ï£ºÏùò**: ÏûêÎèô Î∞∞Ìè¨ÎêòÏßÄ ÏïäÏäµÎãàÎã§. ArgoCDÏóêÏÑú ÏàòÎèô Sync ÌïÑÏöî

Requested by: @${{ github.triggering_actor }} via Discord Bot"
            
            # PR ÏÉùÏÑ±
            gh pr create \
              --title "üöÄ [PROD] Deploy Multiple Services - ${TAG}" \
              --body "$PR_BODY" \
              --base k8s-deploy-prod \
              --head "$BRANCH_NAME"
            
            # PR URL Í∞ÄÏ†∏Ïò§Í∏∞
            PR_URL="https://github.com/${{ github.repository }}/pull/$(gh pr list --head $BRANCH_NAME --json number --jq '.[0].number')"
            
            echo "‚úÖ PR created: ${PR_URL}"
            echo "PR_URL=${PR_URL}" >> $GITHUB_OUTPUT
            
            echo ""
            echo "### üîó Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. [Review the PR](${PR_URL})" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge after approval" >> $GITHUB_STEP_SUMMARY
            echo "3. Sync all services in ArgoCD" >> $GITHUB_STEP_SUMMARY
          else
            # ÏßÅÏ†ë Ïª§Î∞ã (ÎπÑÍ∂åÏû•)
            git add .
            git commit -m "üöÄ [PROD] Deploy Multiple Services - ${TAG}

Services: ${UPDATED_SERVICES}
Updated by: ${{ github.triggering_actor }} via Discord Bot
Manual deployment trigger"
            git push origin k8s-deploy-prod
            echo "‚ö†Ô∏è Changes pushed directly to k8s-deploy-prod"
            echo "Go to ArgoCD and manually sync all updated services"
          fi

      - name: Send Discord notification
        if: inputs.create_pr == true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            PR_URL="${{ steps.create-pr.outputs.PR_URL }}"
            UPDATED_SERVICES="${{ steps.update-manifest.outputs.updated_services }}"
            
            curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "embeds": [{
                  "title": "üì¶ Production Multi-Service Deployment PR Created",
                  "description": "New production deployment PR has been created for multiple services.",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "üîß Services",
                      "value": "'"${UPDATED_SERVICES}"'",
                      "inline": false
                    },
                    {
                      "name": "üè∑Ô∏è Image Tag", 
                      "value": "'"${{ inputs.image_tag }}"'",
                      "inline": true
                    },
                    {
                      "name": "üë§ Requested by",
                      "value": "'"${{ github.triggering_actor }}"'",
                      "inline": true
                    },
                    {
                      "name": "üîó PR Link",
                      "value": "[Review and Merge]('"${PR_URL}"')",
                      "inline": false
                    },
                    {
                      "name": "üìã Next Steps",
                      "value": "1. Review PR\\n2. Merge after approval\\n3. Sync all services in ArgoCD\\n4. Monitor deployment",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions ‚Ä¢ Multi-Service Production Deployment"
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              "$DISCORD_WEBHOOK"
          else
            echo "Discord webhook not configured"
          fi

      - name: Deployment summary
        run: |
          UPDATED_SERVICES="${{ steps.update-manifest.outputs.updated_services }}"
          
          echo "## üöÄ Production Multi-Service Image Tag Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updated Services:** ${UPDATED_SERVICES}" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ ECR Images:" >> $GITHUB_STEP_SUMMARY
          
          IFS=',' read -ra SERVICES_ARRAY <<< "$UPDATED_SERVICES"
          for service in "${SERVICES_ARRAY[@]}"; do
            service=$(echo "$service" | xargs)
            echo "- \`prod/${service}:${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. üîÑ Go to ArgoCD UI" >> $GITHUB_STEP_SUMMARY
          echo "3. üéØ Find and sync these applications:" >> $GITHUB_STEP_SUMMARY
          
          for service in "${SERVICES_ARRAY[@]}"; do
            service=$(echo "$service" | xargs)
            echo "   - **${service}-prod**" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "4. üöÄ Click **Sync** button for each" >> $GITHUB_STEP_SUMMARY
          echo "5. üëÄ Monitor deployment" >> $GITHUB_STEP_SUMMARY