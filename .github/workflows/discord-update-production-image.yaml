name: Discord Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: false
        type: string
      services:
        description: 'Multiple services (comma-separated)'
        required: false
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.services }}" ] && [ -z "${{ inputs.service }}" ]; then
            echo "âŒ Error: Either 'service' or 'services' must be provided"
            exit 1
          fi

      - name: Process services
        run: |
          if [ -n "${{ inputs.services }}" ]; then
            echo "SERVICES_LIST=${{ inputs.services }}" >> $GITHUB_ENV
          else
            echo "SERVICES_LIST=${{ inputs.service }}" >> $GITHUB_ENV
          fi

      - name: Update manifests
        id: update
        run: |
          TAG="${{ inputs.image_tag }}"
          IFS=',' read -ra SERVICES <<< "$SERVICES_LIST"
          
          UPDATED_SERVICES=()
          FAILED_SERVICES=()
          
          for SERVICE in "${SERVICES[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs)
            echo "================================================"
            echo "Processing: $SERVICE"
            
            MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
            
            if [ ! -f "$MANIFEST" ]; then
              echo "âŒ Manifest not found: $MANIFEST"
              FAILED_SERVICES+=("$SERVICE (file not found)")
              continue
            fi
            
            # ë°±ì—… ìƒì„±
            cp "$MANIFEST" "${MANIFEST}.bak"
            
            # ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ êµ¬ì¡°ì— ë”°ë¼ ì ì ˆí•œ sed ëª…ë ¹ ì„ íƒ
            # ë°©ë²• 1: image: ë’¤ì— ì „ì²´ ì´ë¯¸ì§€ ê²½ë¡œê°€ ìžˆëŠ” ê²½ìš°
            if grep -q "image:.*${SERVICE}" "$MANIFEST"; then
              sed -i "s|image:.*${SERVICE}:.*|image: prod/${SERVICE}:${TAG}|g" "$MANIFEST"
            # ë°©ë²• 2: tag: ë§Œ ë³„ë„ë¡œ ìžˆëŠ” ê²½ìš° (Helm values ìŠ¤íƒ€ì¼)
            elif grep -q "tag:" "$MANIFEST"; then
              sed -i "s|tag:.*|tag: ${TAG}|g" "$MANIFEST"
            else
              echo "âš ï¸  Warning: Could not find image pattern in $MANIFEST"
              rm "${MANIFEST}.bak"
              FAILED_SERVICES+=("$SERVICE (pattern not found)")
              continue
            fi
            
            # ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if ! diff -q "$MANIFEST" "${MANIFEST}.bak" > /dev/null 2>&1; then
              echo "âœ… Updated $SERVICE to $TAG"
              UPDATED_SERVICES+=("$SERVICE")
              rm "${MANIFEST}.bak"
            else
              echo "âš ï¸  No changes made to $SERVICE"
              mv "${MANIFEST}.bak" "$MANIFEST"
              FAILED_SERVICES+=("$SERVICE (no changes)")
            fi
          done
          
          # ê²°ê³¼ ìš”ì•½
          echo "================================================"
          echo "ðŸ“Š Update Summary:"
          echo "Updated: ${UPDATED_SERVICES[*]}"
          echo "Failed: ${FAILED_SERVICES[*]}"
          
          # í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ìž¥
          echo "UPDATED_SERVICES=${UPDATED_SERVICES[*]}" >> $GITHUB_ENV
          echo "FAILED_SERVICES=${FAILED_SERVICES[*]}" >> $GITHUB_ENV
          
          # ì—…ë°ì´íŠ¸ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìœ¼ë©´ ì‹¤íŒ¨
          if [ ${#UPDATED_SERVICES[@]} -eq 0 ]; then
            echo "âŒ No services were updated"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi

      - name: Create PR
        if: inputs.create_pr == true && steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
        run: |
          TAG="${{ inputs.image_tag }}"
          BRANCH_NAME="deploy/multi-service-${TAG}-$(date +%s)"
          
          git checkout -b "$BRANCH_NAME"
          git add k8s/
          git commit -m "ðŸš€ [PROD] Deploy services - ${TAG}

          Updated services: $UPDATED_SERVICES
          Failed services: $FAILED_SERVICES"
          
          git push origin "$BRANCH_NAME"
          
          # PR ë³¸ë¬¸ ìƒì„±
          PR_BODY="## ðŸš€ Production Deployment
          
          **Image Tag:** \`${TAG}\`
          
          ### âœ… Updated Services
          $(echo "$UPDATED_SERVICES" | tr ' ' '\n' | sed 's/^/- /')
          
          ### âŒ Failed Services
          $(echo "$FAILED_SERVICES" | tr ' ' '\n' | sed 's/^/- /')
          
          ---
          Triggered via Discord Bot"
          
          gh pr create \
            --title "ðŸš€ [PROD] Deploy Services - ${TAG}" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Direct commit (no PR)
        if: inputs.create_pr == false && steps.check_changes.outputs.has_changes == 'true'
        run: |
          TAG="${{ inputs.image_tag }}"
          git add k8s/
          git commit -m "ðŸš€ [PROD] Deploy services - ${TAG}

          Updated: $UPDATED_SERVICES"
          git push origin main

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Services" >> $GITHUB_STEP_SUMMARY
          echo "$UPDATED_SERVICES" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$FAILED_SERVICES" ]; then
            echo "### Failed Services" >> $GITHUB_STEP_SUMMARY
            echo "$FAILED_SERVICES" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi