name: Discord Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Service names (comma-separated, e.g., auth-service,board-service)'
        required: true
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  list-available-images:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List and verify images for all services
        run: |
          IFS=',' read -ra SERVICES <<< "${{ inputs.services }}"
          
          echo "### üì¶ Image Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for SERVICE in "${SERVICES[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs)  # trim whitespace
            echo "#### Service: $SERVICE" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # ÏµúÍ∑º Ïù¥ÎØ∏ÏßÄ Î™©Î°ù
            echo "Recent images:" >> $GITHUB_STEP_SUMMARY
            aws ecr describe-images \
              --repository-name "prod/$SERVICE" \
              --region ${{ env.AWS_REGION }} \
              --query 'sort_by(imageDetails,& imagePushedAt)[-5:].[imageTags[0],imagePushedAt]' \
              --output table >> $GITHUB_STEP_SUMMARY || echo "No images found"
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ÏÑ†ÌÉùÌïú Ïù¥ÎØ∏ÏßÄ Í≤ÄÏ¶ù
            echo "Verifying image: prod/$SERVICE:${{ inputs.image_tag }}"
            if aws ecr describe-images \
              --repository-name "prod/$SERVICE" \
              --region ${{ env.AWS_REGION }} \
              --image-ids imageTag=${{ inputs.image_tag }} > /dev/null 2>&1; then
              echo "‚úÖ $SERVICE: Image verified"
            else
              echo "‚ùå $SERVICE: Image not found"
              exit 1
            fi
          done

  update-manifest:
    needs: list-available-images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Checkout k8s-deploy-prod branch
        run: |
          git fetch origin k8s-deploy-prod
          git checkout k8s-deploy-prod

      - name: Update ArgoCD Application manifests
        id: update_manifests
        run: |
          IFS=',' read -ra SERVICES <<< "${{ inputs.services }}"
          TAG="${{ inputs.image_tag }}"
          
          UPDATED_SERVICES=""
          FAILED_SERVICES=""
          
          for SERVICE in "${SERVICES[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs)  # trim whitespace
            
            # ArgoCD Application manifest Í≤ΩÎ°ú
            MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
            
            if [ ! -f "$MANIFEST" ]; then
              echo "‚ùå Manifest file not found: ${MANIFEST}"
              FAILED_SERVICES="${FAILED_SERVICES}${SERVICE} "
              continue
            fi
            
            echo "üìù Updating ${MANIFEST}"
            echo "New tag: ${TAG}"
            
            # image.tag ÌååÎùºÎØ∏ÌÑ∞Îßå ÏóÖÎç∞Ïù¥Ìä∏
            sed -i.bak '/- name: image\.tag/{n;s|value: ".*"|value: "'"${TAG}"'"|}' "$MANIFEST"
            rm -f "${MANIFEST}.bak"
            
            echo ""
            echo "=== Updated section for ${SERVICE} ==="
            grep -A 1 "name: image.tag" "$MANIFEST"
            echo "======================================="
            echo ""
            
            UPDATED_SERVICES="${UPDATED_SERVICES}${SERVICE} "
          done
          
          # Ï†ÑÏ≤¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          echo "üìã All changes:"
          git diff
          
          # Í≤∞Í≥ºÎ•º outputÏúºÎ°ú Ï†ÄÏû•
          echo "updated_services=${UPDATED_SERVICES}" >> $GITHUB_OUTPUT
          echo "failed_services=${FAILED_SERVICES}" >> $GITHUB_OUTPUT
          
          if [ -n "$FAILED_SERVICES" ]; then
            echo "‚ö†Ô∏è Some services failed to update: ${FAILED_SERVICES}"
          fi

      - name: Create PR or commit
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
        run: |
          TAG="${{ inputs.image_tag }}"
          UPDATED_SERVICES="${{ steps.update_manifests.outputs.updated_services }}"
          SERVICE_COUNT=$(echo $UPDATED_SERVICES | wc -w)
          
          if [ "${{ inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="deploy/multi-service-${TAG}-$(date +%s)"
            
            # ÏÉà Î∏åÎûúÏπò ÏÉùÏÑ±
            git checkout -b "$BRANCH_NAME"
            git add .
            
            # Ïª§Î∞ã Î©îÏãúÏßÄ ÏÉùÏÑ±
            if [ $SERVICE_COUNT -eq 1 ]; then
              git commit -m "üöÄ [PROD] Deploy ${UPDATED_SERVICES// /} - ${TAG}"
            else
              git commit -m "üöÄ [PROD] Deploy ${SERVICE_COUNT} services - ${TAG}

          Services:
          $(echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/- /')"
            fi
            
            git push origin "$BRANCH_NAME"
            
            # PR body ÏÉùÏÑ±
            PR_BODY="## Production Deployment Request

**Image Tag:** \`${TAG}\`  
**Services:** ${SERVICE_COUNT}

### Services to Deploy
$(echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/- **/' | sed 's/$/**/')

### Updated Manifests
$(echo $UPDATED_SERVICES | tr ' ' '\n' | sed "s|^|- \`k8s/argocd/apps/prod/|" | sed 's|$|.yaml`|')

### Pre-deployment Checklist
- [ ] Dev/Staging ÌÖåÏä§Ìä∏ ÏôÑÎ£å
- [ ] ÏÑ±Îä• Î∞è Î¶¨ÏÜåÏä§ Í≤ÄÌÜ† ÏôÑÎ£å
- [ ] ÌåÄÏõê ÏäπÏù∏ ÏôÑÎ£å

### Deployment Steps
1. Ïù¥ PR Î¶¨Î∑∞ Î∞è ÏäπÏù∏
2. PR Merge
3. ArgoCD UIÏóêÏÑú Í∞Å Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏùò **Sync** Î≤ÑÌäº ÌÅ¥Î¶≠:
$(echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/   - **/' | sed 's/$/-prod**/')
4. Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ (Discord ÏïåÎ¶º ÌôïÏù∏)

---
‚ö†Ô∏è **Ï£ºÏùò**: ÏûêÎèô Î∞∞Ìè¨ÎêòÏßÄ ÏïäÏäµÎãàÎã§. ArgoCDÏóêÏÑú ÏàòÎèô Sync ÌïÑÏöî

Requested by: @${{ github.triggering_actor }} via Discord Bot"
            
            # PR ÏÉùÏÑ±
            gh pr create \
              --title "üöÄ [PROD] Deploy ${SERVICE_COUNT} services - ${TAG}" \
              --body "$PR_BODY" \
              --base k8s-deploy-prod \
              --head "$BRANCH_NAME"
            
            # PR URL Í∞ÄÏ†∏Ïò§Í∏∞
            PR_URL="https://github.com/${{ github.repository }}/pull/$(gh pr list --head $BRANCH_NAME --json number --jq '.[0].number')"
            
            echo "‚úÖ PR created: ${PR_URL}"
            echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
            
            echo ""
            echo "### üîó Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. [Review the PR](${PR_URL})" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge after approval" >> $GITHUB_STEP_SUMMARY
            echo "3. Sync in ArgoCD" >> $GITHUB_STEP_SUMMARY
          else
            # ÏßÅÏ†ë Ïª§Î∞ã
            git add .
            git commit -m "üöÄ [PROD] Deploy ${SERVICE_COUNT} services - ${TAG}

Services:
$(echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/- /')

Updated by: ${{ github.triggering_actor }} via Discord Bot"
            git push origin k8s-deploy-prod
            echo "‚ö†Ô∏è Changes pushed directly to k8s-deploy-prod"
          fi

      - name: Send Discord notification
        if: inputs.create_pr == true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            PR_URL="${{ steps.create_pr.outputs.pr_url }}"
            UPDATED_SERVICES="${{ steps.update_manifests.outputs.updated_services }}"
            SERVICE_COUNT=$(echo $UPDATED_SERVICES | wc -w)
            SERVICE_LIST=$(echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/‚Ä¢ /' | sed 's/$/\\n/' | tr -d '\n')
            
            curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "embeds": [{
                  "title": "üì¶ Production Deployment PR Created",
                  "description": "New production deployment PR has been created for '"${SERVICE_COUNT}"' service(s).",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "üîß Services",
                      "value": "'"${SERVICE_LIST}"'",
                      "inline": false
                    },
                    {
                      "name": "üè∑Ô∏è Image Tag", 
                      "value": "`'"${{ inputs.image_tag }}"'`",
                      "inline": true
                    },
                    {
                      "name": "üë§ Requested by",
                      "value": "'"${{ github.triggering_actor }}"'",
                      "inline": true
                    },
                    {
                      "name": "üîó PR Link",
                      "value": "[Review and Merge]('"${PR_URL}"')",
                      "inline": false
                    },
                    {
                      "name": "üìã Next Steps",
                      "value": "1. Review PR\\n2. Merge after approval\\n3. Sync in ArgoCD\\n4. Monitor deployment",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions ‚Ä¢ Production Deployment"
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              "$DISCORD_WEBHOOK"
          else
            echo "Discord webhook not configured"
          fi

      - name: Deployment summary
        run: |
          UPDATED_SERVICES="${{ steps.update_manifests.outputs.updated_services }}"
          SERVICE_COUNT=$(echo $UPDATED_SERVICES | wc -w)
          
          echo "## üöÄ Production Image Tag Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Updated:** ${SERVICE_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Services:" >> $GITHUB_STEP_SUMMARY
          echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/- **/' | sed 's/$/**/' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. üîÑ Go to ArgoCD UI" >> $GITHUB_STEP_SUMMARY
          echo "3. üéØ Find and sync each service:" >> $GITHUB_STEP_SUMMARY
          echo $UPDATED_SERVICES | tr ' ' '\n' | sed 's/^/   - **/' | sed 's/$/-prod**/' >> $GITHUB_STEP_SUMMARY
          echo "4. üëÄ Monitor deployment" >> $GITHUB_STEP_SUMMARY