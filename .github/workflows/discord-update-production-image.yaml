name: Discord Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: false
        type: string
      services:
        description: 'Multiple services (comma-separated)'
        required: false
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Process services
        run: |
          # ë‹¨ì¼ ì„œë¹„ìŠ¤ ë˜ëŠ” ë©€í‹° ì„œë¹„ìŠ¤ ì²˜ë¦¬
          if [ -n "${{ inputs.services }}" ]; then
            echo "SERVICES_LIST=${{ inputs.services }}" >> $GITHUB_ENV
          else
            echo "SERVICES_LIST=${{ inputs.service }}" >> $GITHUB_ENV
          fi

      - name: Update manifests
        run: |
          TAG="${{ inputs.image_tag }}"
          IFS=',' read -ra SERVICES <<< "$SERVICES_LIST"
          
          for SERVICE in "${SERVICES[@]}"; do
            SERVICE=$(echo "$SERVICE" | xargs) # trim whitespace
            echo "Processing $SERVICE..."
            
            # ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ íŒŒì¼ ê²½ë¡œ (ì‹¤ì œ ê²½ë¡œì— ë§žê²Œ ìˆ˜ì •)
            MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
            
            if [ -f "$MANIFEST" ]; then
              echo "ðŸ“ Updating ${MANIFEST}"
              # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ êµ¬ì¡°ì— ë§žê²Œ ìˆ˜ì •)
              sed -i "s/image: .*/image: prod\/${SERVICE}:${TAG}/" "$MANIFEST"
              echo "âœ… Updated $SERVICE to $TAG"
            else
              echo "âŒ Manifest not found: $MANIFEST"
            fi
          done

      - name: Create PR
        if: inputs.create_pr == true
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
        run: |
          TAG="${{ inputs.image_tag }}"
          BRANCH_NAME="deploy/multi-service-${TAG}-$(date +%s)"
          
          git checkout -b "$BRANCH_NAME"
          git add .
          git commit -m "ðŸš€ [PROD] Deploy services - ${TAG}"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "ðŸš€ [PROD] Deploy Services - ${TAG}" \
            --body "Automated deployment via Discord Bot" \
            --base main \
            --head "$BRANCH_NAME"
