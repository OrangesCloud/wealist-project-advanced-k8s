# =============================================================================
# Frontend CI/CD - Production Environment
# =============================================================================
# íŠ¸ë¦¬ê±°:
#   - v* íƒœê·¸ push (ì˜ˆ: v1.0.0)
#   - ìˆ˜ë™ íŠ¸ë¦¬ê±° (íŠ¹ì • ë²„ì „ ì§€ì • ê°€ëŠ¥)
#
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. Devì—ì„œ ê²€ì¦ëœ ì´ë¯¸ì§€ì— :latest íƒœê·¸ ì¶”ê°€
#   2. S3 ë²„ì „ë³„ í´ë”ì— ë°°í¬ (prod)
#   3. CloudFront ìºì‹œ ë¬´íš¨í™”
#
# âš ï¸ ì¤‘ìš”: ì´ë¯¸ì§€ëŠ” ìƒˆë¡œ ë¹Œë“œí•˜ì§€ ì•ŠìŒ! Devì—ì„œ ê²€ì¦ëœ ì´ë¯¸ì§€ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
#
# Required Secrets:
#   AWS_ROLE_ARN, AWS_S3_BUCKET_PROD, AWS_CLOUDFRONT_DISTRIBUTION_ID_PROD
# Optional Secrets:
#   VITE_API_BASE_URL, API_DOMAIN_PROD
# =============================================================================

name: Frontend CI/CD (Prod)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy (e.g., sha-abc1234, v1.0.0)"
        required: true
        type: string
      version:
        description: "Version label for S3 folder (e.g., 1.0.0)"
        required: true
        type: string
      mark_as_stable:
        description: "Mark this version as stable (adds :stable tag)"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/frontend

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # ===========================================================================
  # Job 1: Validate & Prepare
  # ===========================================================================
  validate:
    name: Validate Image Exists
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.prepare.outputs.image_tag }}
      version: ${{ steps.prepare.outputs.version }}
      short_sha: ${{ steps.prepare.outputs.short_sha }}

    steps:
      - name: Prepare version info
        id: prepare
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # íƒœê·¸ pushì¸ ê²½ìš° (v1.0.0 í˜•ì‹)
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG_NAME#v}"
            IMAGE_TAG="${TAG_NAME}"
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          else
            # ìˆ˜ë™ íŠ¸ë¦¬ê±°ì¸ ê²½ìš°
            VERSION="${{ inputs.version }}"
            IMAGE_TAG="${{ inputs.image_tag }}"
            SHORT_SHA="${IMAGE_TAG#sha-}"
          fi

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Image Tag: ${IMAGE_TAG}"
          echo "ðŸ“‹ Version: ${VERSION}"
          echo "ðŸ”– Short SHA: ${SHORT_SHA}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists in GHCR
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.prepare.outputs.image_tag }}"
          echo "ðŸ” Checking if image exists: ${IMAGE}"

          if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
            echo "âœ… Image found!"
          else
            echo "âŒ Image not found: ${IMAGE}"
            echo "Please ensure the image was built in the dev pipeline first."
            exit 1
          fi

  # ===========================================================================
  # Job 2: Tag Image for Production
  # ===========================================================================
  tag-image-prod:
    name: Tag Image as Latest
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Add production tags to image
        run: |
          SOURCE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.image_tag }}"

          # Pull the source image
          docker pull "${SOURCE}"

          # Tag as :latest (production)
          docker tag "${SOURCE}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

          # Tag as v{version} if not already
          docker tag "${SOURCE}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ needs.validate.outputs.version }}"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ needs.validate.outputs.version }}"

          echo "âœ… Tagged image as :latest and :v${{ needs.validate.outputs.version }}"

      - name: Add stable tag (if requested)
        if: inputs.mark_as_stable == true
        run: |
          SOURCE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.image_tag }}"

          # Tag as :stable
          docker tag "${SOURCE}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable"

          echo "ðŸ† Tagged image as :stable"

      - name: Image Tag Summary
        run: |
          echo "## ðŸ·ï¸ Production Image Tags Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`:latest\` | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`:v${{ needs.validate.outputs.version }}\` | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ needs.validate.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.mark_as_stable }}" == "true" ]; then
            echo "| \`:stable\` ðŸ† | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable\` |" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 3: Deploy to S3 (Prod)
  # ===========================================================================
  deploy-s3-prod:
    name: Deploy to S3 (Prod)
    runs-on: ubuntu-latest
    needs: [validate, tag-image-prod]
    # environment: prod

    defaults:
      run:
        working-directory: services/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.ref || format('v{0}', needs.validate.outputs.version) }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: services/frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for production
        run: pnpm build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '' }}

      - name: Inject runtime config (Production)
        env:
          API_DOMAIN_RAW: ${{ secrets.API_DOMAIN_PROD }}
          VERSION: ${{ needs.validate.outputs.version }}
          SHORT_SHA: ${{ needs.validate.outputs.short_sha }}
        run: |
          API_DOMAIN=$(echo "$API_DOMAIN_RAW" | tr -d '[:space:]')
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > dist/config.js << EOF
          window.__ENV__ = {
            API_BASE_URL: "",
            API_DOMAIN: "${API_DOMAIN}",
            VERSION: "v${VERSION}",
            BUILD_SHA: "${SHORT_SHA}",
            BUILD_TIME: "${BUILD_TIME}",
            ENVIRONMENT: "prod"
          };
          EOF

          echo "ðŸ“ Generated config.js (Production):"
          cat dist/config.js

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to S3 (versioned folder)
        env:
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET_PROD }}
          VERSION: v${{ needs.validate.outputs.version }}
        run: |
          # ë²„ì „ë³„ í´ë”ì— ë°°í¬ (ì˜êµ¬ ë³´ê´€ - ë¡¤ë°±ìš©)
          echo "ðŸ“¦ Deploying to versioned folder: /${VERSION}/"
          aws s3 sync dist/ "s3://${S3_BUCKET}/${VERSION}/" \
            --cache-control "public, max-age=31536000, immutable"

          # ìµœì‹  ë²„ì „ì„ ë£¨íŠ¸ì— ë°°í¬ (í˜„ìž¬ ì„œë¹™ìš©)
          echo "ðŸš€ Deploying to root (current version)"
          aws s3 sync dist/ "s3://${S3_BUCKET}/" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "config.js" \
            --exclude "v*/"

          # index.html, config.jsëŠ” ìºì‹œ ì—†ì´
          aws s3 cp dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "no-cache, no-store, must-revalidate"

          aws s3 cp dist/config.js "s3://${S3_BUCKET}/config.js" \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_PROD }} \
            --paths "/*"

      - name: Production Deployment Summary
        env:
          VERSION: v${{ needs.validate.outputs.version }}
          SHORT_SHA: ${{ needs.validate.outputs.short_sha }}
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${SHORT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | \`${{ secrets.AWS_S3_BUCKET_PROD }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Versioned Path** | \`/${VERSION}/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Docker Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Rollback Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Rollback:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± (ì˜ˆ: v1.0.0)" >> $GITHUB_STEP_SUMMARY
          echo "aws s3 sync s3://\${BUCKET}/v1.0.0/ s3://\${BUCKET}/ --delete" >> $GITHUB_STEP_SUMMARY
          echo "aws cloudfront create-invalidation --distribution-id \${DIST_ID} --paths '/*'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**K8s Rollback:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Helmìœ¼ë¡œ ì´ì „ ì´ë¯¸ì§€ íƒœê·¸ ì§€ì •" >> $GITHUB_STEP_SUMMARY
          echo "helm upgrade frontend ./helm/charts/frontend --set image.tag=v1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Create GitHub Release
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, deploy-s3-prod]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Frontend ${{ github.ref_name }}
          body: |
            ## Frontend Release ${{ github.ref_name }}

            ### Docker Image
            ```
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ```

            ### Deployment
            - **S3 Path:** `/${{ github.ref_name }}/`
            - **Commit:** `${{ github.sha }}`

            ### Rollback
            ```bash
            # S3 ë¡¤ë°±
            aws s3 sync s3://${BUCKET}/${{ github.ref_name }}/ s3://${BUCKET}/ --delete

            # K8s ë¡¤ë°±
            helm upgrade frontend ./helm/charts/frontend --set image.tag=${{ github.ref_name }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
