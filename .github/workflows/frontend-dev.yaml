# =============================================================================
# Frontend CI/CD - Development Environment
# =============================================================================
# íŠ¸ë¦¬ê±°: dev ë¸Œëœì¹˜ push (services/frontend/** ë³€ê²½ ì‹œ)
#
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. íƒ€ì… ì²´í¬ ë° ë¹Œë“œ
#   2. Docker ì´ë¯¸ì§€ ë¹Œë“œ â†’ GHCR Push
#   3. S3 ë²„ì „ë³„ í´ë”ì— ë°°í¬
#   4. CloudFront ìºì‹œ ë¬´íš¨í™”
#
# ì´ë¯¸ì§€ íƒœê·¸ ì „ëµ:
#   - :sha-{commit} - ì»¤ë°‹ë³„ ê³ ì • íƒœê·¸ (ì˜êµ¬ ë³´ê´€)
#   - :v{version}   - ë¦´ë¦¬ìŠ¤ ë²„ì „ (package.json ê¸°ë°˜)
#   - :latest-dev   - dev í™˜ê²½ ìµœì‹  (ë§¤ ë°°í¬ë§ˆë‹¤ ì—…ë°ì´íŠ¸)
#
# Required Secrets:
#   AWS_ROLE_ARN_FRONTEND, AWS_S3_BUCKET_DEV, AWS_CLOUDFRONT_DISTRIBUTION_ID_DEV
# Optional Secrets:
#   VITE_API_BASE_URL, API_DOMAIN_DEV
# =============================================================================

name: Frontend CI/CD (Dev)

on:
  push:
    branches:
      - dev
      - dev-frontend
    paths:
      - "services/frontend/**"
  workflow_dispatch:
    inputs:
      skip_s3_deploy:
        description: "Skip S3 deployment (image build only)"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/frontend

permissions:
  contents: write # semantic-releaseê°€ package.json, CHANGELOG ìˆ˜ì •
  packages: write
  id-token: write

jobs:
  # ===========================================================================
  # Job 0: Discord Notification - CI Started
  # ===========================================================================
  notify-start:
    name: Notify CI Started
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification - CI Started
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1457744189000257671/5k1vpbTuJY9fOVYiRCiZ7E3hzAiD_VK-o8aXcurar2shAJsqmryfXSgTn4A61wY0k72v"
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1 | sed 's/"/\\"/g')

            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d '{
                   "embeds": [{
                     "title": "ğŸš€ Frontend CI Started",
                     "description": "ë¹Œë“œ ë° ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤",
                     "color": 3447003,
                     "fields": [
                       {
                         "name": "ğŸŒ Environment",
                         "value": "Development",
                         "inline": true
                       },
                       {
                         "name": "ğŸ”— Commit",
                         "value": "[`'"${SHORT_SHA}"'`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                         "inline": true
                       },
                       {
                         "name": "ğŸ‘¤ Triggered by",
                         "value": "${{ github.actor }}",
                         "inline": true
                       },
                       {
                         "name": "ğŸ’¬ Commit Message",
                         "value": "'"${COMMIT_MSG}"'",
                         "inline": false
                       }
                     ],
                     "footer": {
                       "text": "GitHub Actions â€¢ Run #${{ github.run_number }}"
                     },
                     "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                   }]
                 }' \
                 "$DISCORD_WEBHOOK"
          fi

  # ===========================================================================
  # Job 1: Semantic Release (ìë™ ë²„ì „ì—…)
  # ===========================================================================
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.release.outputs.new_version }}
      released: ${{ steps.release.outputs.released }}

    defaults:
      run:
        working-directory: services/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (ì»¤ë°‹ ë¶„ì„ìš©)
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: services/frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Semantic Release
        id: release
        run: |
          # semantic-release ì‹¤í–‰
          npx semantic-release --dry-run 2>&1 | tee release-output.txt || true

          # ë‹¤ìŒ ë²„ì „ ì¶”ì¶œ
          NEXT_VERSION=$(grep -oP "The next release version is \K[0-9]+\.[0-9]+\.[0-9]+" release-output.txt || echo "")

          if [ -n "$NEXT_VERSION" ]; then
            echo "ğŸš€ New version will be: ${NEXT_VERSION}"
            echo "new_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
            echo "released=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ No new release needed"
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "new_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
            echo "released=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ğŸ“¦ Semantic Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.release.outputs.released }}" == "true" ]; then
            echo "ğŸš€ **New version detected:** \`v${{ steps.release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“¦ **Current version:** \`v${{ steps.release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No front-fix/front-feat commits found since last release." >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 2: Build & Test
  # ===========================================================================
  build-and-test:
    name: Build & Type Check
    runs-on: ubuntu-latest
    needs: semantic-release
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}

    defaults:
      run:
        working-directory: services/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: services/frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Build (for validation)
        run: pnpm build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '' }}

      - name: Extract version info
        id: version
        run: |
          # semantic-releaseì—ì„œ ê²°ì •ëœ ë²„ì „ ì‚¬ìš© (ë˜ëŠ” í˜„ì¬ ë²„ì „)
          VERSION="${{ needs.semantic-release.outputs.new_version }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"
          echo "ğŸ”– Short SHA: ${SHORT_SHA}"
          if [ "${{ needs.semantic-release.outputs.released }}" == "true" ]; then
            echo "ğŸš€ New release detected!"
          fi

  # ===========================================================================
  # Job 3: Docker Build & Push to GHCR
  # ===========================================================================
  docker-build-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [semantic-release, build-and-test]
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # SHA íƒœê·¸ (ì˜êµ¬ ë³´ê´€)
            type=sha,prefix=sha-,format=short
            # ë²„ì „ íƒœê·¸
            type=raw,value=v${{ needs.build-and-test.outputs.version }}
            # latest-dev íƒœê·¸ (dev ìµœì‹ )
            type=raw,value=latest-dev

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/frontend
          file: ./services/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Image Summary
        run: |
          echo "## ğŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Deploy to S3 (Dev)
  # ===========================================================================
  deploy-s3-dev:
    name: Deploy to S3 (Dev)
    runs-on: ubuntu-latest
    needs: [semantic-release, build-and-test, docker-build-push]
    if: ${{ !inputs.skip_s3_deploy }}
    environment: develop

    defaults:
      run:
        working-directory: services/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: services/frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for production
        run: pnpm build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '' }}

      - name: Inject runtime config
        env:
          API_DOMAIN_RAW: ${{ secrets.API_DOMAIN_DEV }}
        run: |
          API_DOMAIN=$(echo "$API_DOMAIN_RAW" | tr -d '[:space:]')
          VERSION="v${{ needs.build-and-test.outputs.version }}"
          SHORT_SHA="${{ needs.build-and-test.outputs.short_sha }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > dist/config.js << EOF
          window.__ENV__ = {
            API_BASE_URL: "",
            API_DOMAIN: "${API_DOMAIN}",
            VERSION: "${VERSION}",
            BUILD_SHA: "${SHORT_SHA}",
            BUILD_TIME: "${BUILD_TIME}",
            ENVIRONMENT: "dev"
          };
          EOF

          echo "ğŸ“ Generated config.js:"
          cat dist/config.js

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_FRONTEND }}
          aws-region: ap-northeast-2

      - name: Deploy to S3 (versioned folder)
        env:
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET_DEV }}
          VERSION: v${{ needs.build-and-test.outputs.version }}
          SHORT_SHA: ${{ needs.build-and-test.outputs.short_sha }}
        run: |
          # ë²„ì „ë³„ í´ë”ì— ë°°í¬ (ì˜êµ¬ ë³´ê´€)
          echo "ğŸ“¦ Deploying to versioned folder: /${VERSION}-${SHORT_SHA}/"
          aws s3 sync dist/ "s3://${S3_BUCKET}/${VERSION}-${SHORT_SHA}/" \
            --cache-control "public, max-age=31536000, immutable"

          # ìµœì‹  ë²„ì „ì„ ë£¨íŠ¸ì—ë„ ë°°í¬ (í˜„ì¬ ì„œë¹™ìš©)
          echo "ğŸš€ Deploying to root (current version)"
          aws s3 sync dist/ "s3://${S3_BUCKET}/" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "config.js"

          # index.html, config.jsëŠ” ìºì‹œ ì—†ì´
          aws s3 cp dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "no-cache, no-store, must-revalidate"

          aws s3 cp dist/config.js "s3://${S3_BUCKET}/config.js" \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"

      - name: Deployment Summary
        env:
          VERSION: v${{ needs.build-and-test.outputs.version }}
          SHORT_SHA: ${{ needs.build-and-test.outputs.short_sha }}
        run: |
          echo "## ğŸš€ Dev Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${SHORT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | \`${{ secrets.AWS_S3_BUCKET_DEV }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Versioned Path** | \`/${VERSION}-${SHORT_SHA}/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Docker Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${SHORT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ Rollback Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# S3ì—ì„œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±" >> $GITHUB_STEP_SUMMARY
          echo "aws s3 sync s3://\${BUCKET}/${VERSION}-${SHORT_SHA}/ s3://\${BUCKET}/ --delete" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 5: Create Release (ì‹¤ì œ ë²„ì „ì—…)
  # ===========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [semantic-release, build-and-test, docker-build-push, deploy-s3-dev]
    if: needs.semantic-release.outputs.released == 'true'

    defaults:
      run:
        working-directory: services/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: services/frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Semantic Release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ğŸ‰ New Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`v${{ needs.semantic-release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes:" >> $GITHUB_STEP_SUMMARY
          echo "- package.json updated" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md generated" >> $GITHUB_STEP_SUMMARY
          echo "- Git tag created: \`frontend-v${{ needs.semantic-release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release created" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 6: Discord Notification - Deployment Complete
  # ===========================================================================
  notify-complete:
    name: Notify Deployment Complete
    runs-on: ubuntu-latest
    needs: [semantic-release, build-and-test, docker-build-push, deploy-s3-dev]
    if: always() # ğŸ”¥ í•­ìƒ ì‹¤í–‰ (ì‹¤íŒ¨ ì•Œë¦¼ì„ ìœ„í•´)
    steps:
      - name: Send Discord notification - Success
        if: needs.deploy-s3-dev.result == 'success'
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1457744189000257671/5k1vpbTuJY9fOVYiRCiZ7E3hzAiD_VK-o8aXcurar2shAJsqmryfXSgTn4A61wY0k72v"
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION="v${{ needs.build-and-test.outputs.version }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âœ… Frontend ë°°í¬ ì™„ë£Œ",
                   "description": "S3-CDN ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
                   "color": 3066993,
                   "fields": [
                     {
                       "name": "ğŸŒ Environment",
                       "value": "Development",
                       "inline": true
                     },
                     {
                       "name": "ğŸ“¦ Version",
                       "value": "`'"${VERSION}"'`",
                       "inline": true
                     },
                     {
                       "name": "ğŸ”— Commit",
                       "value": "[`'"${SHORT_SHA}"'`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                       "inline": true
                     },
                     {
                       "name": "ğŸŒ URL",
                       "value": "[dev.wealist.co.kr](https://dev.wealist.co.kr)",
                       "inline": true
                     },
                     {
                       "name": "ğŸ‘¤ Triggered by",
                       "value": "${{ github.actor }}",
                       "inline": true
                     }
                   ],
                   "footer": {
                     "text": "GitHub Actions â€¢ Run #${{ github.run_number }}"
                   },
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               "$DISCORD_WEBHOOK"

      - name: Send Discord notification - Failure
        if: needs.deploy-s3-dev.result == 'failure' || needs.build-and-test.result == 'failure' || needs.docker-build-push.result == 'failure'
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1457744189000257671/5k1vpbTuJY9fOVYiRCiZ7E3hzAiD_VK-o8aXcurar2shAJsqmryfXSgTn4A61wY0k72v"
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âŒ Frontend ë°°í¬ ì‹¤íŒ¨",
                   "description": "CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
                   "color": 15158332,
                   "fields": [
                     {
                       "name": "ğŸŒ Environment",
                       "value": "Development",
                       "inline": true
                     },
                     {
                       "name": "ğŸ”— Commit",
                       "value": "[`'"${SHORT_SHA}"'`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                       "inline": true
                     },
                     {
                       "name": "ğŸ‘¤ Triggered by",
                       "value": "${{ github.actor }}",
                       "inline": true
                     },
                     {
                       "name": "ğŸ” Details",
                       "value": "[View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                       "inline": false
                     }
                   ],
                   "footer": {
                     "text": "GitHub Actions â€¢ Run #${{ github.run_number }}"
                   },
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               "$DISCORD_WEBHOOK"
