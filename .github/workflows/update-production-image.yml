name: Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: true
        type: choice
        options:
          - auth-service
          - board-service
          - chat-service
          - noti-service
          - storage-service
          - user-service
          - video-service
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  list-available-images:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List recent prod images
        run: |
          echo "### üì¶ Recent Images for prod/${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ecr describe-images \
            --repository-name "prod/${{ inputs.service }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-10:].[imageTags[0],imagePushedAt]' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "No images found"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify selected image exists
        run: |
          echo "Verifying image: prod/${{ inputs.service }}:${{ inputs.image_tag }}"
          aws ecr describe-images \
            --repository-name "prod/${{ inputs.service }}" \
            --region ${{ env.AWS_REGION }} \
            --image-ids imageTag=${{ inputs.image_tag }}
          echo "‚úÖ Image verified"

  update-manifest:
    needs: list-available-images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

      - name: Checkout k8s-deploy-prod branch
        run: |
          git fetch origin k8s-deploy-prod
          git checkout k8s-deploy-prod

      - name: Update ArgoCD Application manifest
        run: |
          SERVICE="${{ inputs.service }}"
          TAG="${{ inputs.image_tag }}"
          
          # ArgoCD Application manifest Í≤ΩÎ°ú
          MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
          
          if [ ! -f "$MANIFEST" ]; then
            echo "‚ùå Manifest file not found: ${MANIFEST}"
            exit 1
          fi
          
          echo "üìù Updating ${MANIFEST}"
          echo "New tag: ${TAG}"
          
          # image.tag ÌååÎùºÎØ∏ÌÑ∞Îßå ÏóÖÎç∞Ïù¥Ìä∏
          sed -i.bak '/- name: image\.tag/{n;s|value: ".*"|value: "'"${TAG}"'"|}' "$MANIFEST"
          rm -f "${MANIFEST}.bak"
          
          echo ""
          echo "=== Updated section ==="
          grep -A 1 "name: image.tag" "$MANIFEST"
          echo "======================="
          echo ""
          
          # Ï†ÑÏ≤¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          git diff "$MANIFEST"

      - name: Create PR or commit
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
        run: |
          SERVICE="${{ inputs.service }}"
          TAG="${{ inputs.image_tag }}"
          
          if [ "${{ inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="deploy/${SERVICE}-${TAG}-$(date +%s)"
            
            # ÏÉà Î∏åÎûúÏπò ÏÉùÏÑ±
            git checkout -b "$BRANCH_NAME"
            git add .
            git commit -m "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}"
            git push origin "$BRANCH_NAME"
            
            # PR bodyÎ•º heredocÏúºÎ°ú Ï†ÄÏû•
            PR_BODY=$(cat <<'EOF'
          ## Production Deployment Request
          
          **Service:** `SERVICE_PLACEHOLDER`  
          **Image Tag:** `TAG_PLACEHOLDER`  
          **ECR Image:** `prod/SERVICE_PLACEHOLDER:TAG_PLACEHOLDER`  
          **Manifest:** `k8s/argocd/apps/prod/SERVICE_PLACEHOLDER.yaml`
          
          ### Pre-deployment Checklist
          - [ ] Dev/Staging ÌÖåÏä§Ìä∏ ÏôÑÎ£å
          - [ ] ÏÑ±Îä• Î∞è Î¶¨ÏÜåÏä§ Í≤ÄÌÜ† ÏôÑÎ£å
          - [ ] ÌåÄÏõê ÏäπÏù∏ ÏôÑÎ£å
          
          ### Deployment Steps
          1. Ïù¥ PR Î¶¨Î∑∞ Î∞è ÏäπÏù∏
          2. PR Merge
          3. ArgoCD UIÏóêÏÑú **SERVICE_PLACEHOLDER-prod** Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏùò **Sync** Î≤ÑÌäº ÌÅ¥Î¶≠
          4. Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ (Discord ÏïåÎ¶º ÌôïÏù∏)
          
          ---
          ‚ö†Ô∏è **Ï£ºÏùò**: ÏûêÎèô Î∞∞Ìè¨ÎêòÏßÄ ÏïäÏäµÎãàÎã§. ArgoCDÏóêÏÑú ÏàòÎèô Sync ÌïÑÏöî
          
          Requested by: @ACTOR_PLACEHOLDER via Discord Bot
          EOF
          )
            
            # Placeholder ÏπòÌôò
            PR_BODY="${PR_BODY//SERVICE_PLACEHOLDER/$SERVICE}"
            PR_BODY="${PR_BODY//TAG_PLACEHOLDER/$TAG}"
            PR_BODY="${PR_BODY//ACTOR_PLACEHOLDER/${{ github.triggering_actor }}}"
            
            # PR ÏÉùÏÑ±
            PR_URL=$(gh pr create \
              --title "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}" \
              --body "$PR_BODY" \
              --base k8s-deploy-prod \
              --head "$BRANCH_NAME" \
              --json url \
              --jq '.url')
            
            echo "‚úÖ PR created: ${PR_URL}"
            echo "PR_URL=${PR_URL}" >> $GITHUB_OUTPUT
            
            echo ""
            echo "### üîó Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. [Review the PR](${PR_URL})" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge after approval" >> $GITHUB_STEP_SUMMARY
            echo "3. Sync in ArgoCD" >> $GITHUB_STEP_SUMMARY
          else
            # ÏßÅÏ†ë Ïª§Î∞ã (ÎπÑÍ∂åÏû•)
            git add .
            git commit -m "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}

          Updated by: ${{ github.triggering_actor }} via Discord Bot
          Manual deployment trigger"
            git push origin k8s-deploy-prod
            echo "‚ö†Ô∏è Changes pushed directly to k8s-deploy-prod"
            echo "Go to ArgoCD and manually sync ${SERVICE}-prod"
          fi

      - name: Send Discord notification
        if: inputs.create_pr == true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            PR_URL="${{ steps.update-manifest.outputs.PR_URL }}"
            
            curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "embeds": [{
                  "title": "üì¶ Production Deployment PR Created",
                  "description": "New production deployment PR has been created and is ready for review.",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "üîß Service",
                      "value": "'"${{ inputs.service }}"'",
                      "inline": true
                    },
                    {
                      "name": "üè∑Ô∏è Image Tag", 
                      "value": "'"${{ inputs.image_tag }}"'",
                      "inline": true
                    },
                    {
                      "name": "üë§ Requested by",
                      "value": "'"${{ github.triggering_actor }}"'",
                      "inline": true
                    },
                    {
                      "name": "üîó PR Link",
                      "value": "[Review and Merge]('"${PR_URL}"')",
                      "inline": false
                    },
                    {
                      "name": "üìã Next Steps",
                      "value": "1. Review PR\\n2. Merge after approval\\n3. Sync in ArgoCD\\n4. Monitor deployment",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions ‚Ä¢ Production Deployment"
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                }]
              }' \
              "$DISCORD_WEBHOOK"
          else
            echo "Discord webhook not configured"
          fi

      - name: Deployment summary
        run: |
          echo "## üöÄ Production Image Tag Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Image:** \`prod/${{ inputs.service }}:${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Manifest:** \`k8s/argocd/apps/prod/${{ inputs.service }}.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. üîÑ Go to ArgoCD UI" >> $GITHUB_STEP_SUMMARY
          echo "3. üéØ Find **${{ inputs.service }}-prod** application" >> $GITHUB_STEP_SUMMARY
          echo "4. üöÄ Click **Sync** button" >> $GITHUB_STEP_SUMMARY
          echo "5. üëÄ Monitor deployment" >> $GITHUB_STEP_SUMMARY