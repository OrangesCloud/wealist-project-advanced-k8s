# =============================================================================
# Update Production Image Tag (ÌòÑÏû¨ ÎπÑÌôúÏÑ±Ìôî)
# =============================================================================
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Îäî ÌòÑÏû¨ ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉúÏûÖÎãàÎã§.
# ÌôúÏÑ±ÌôîÌïòÎ†§Î©¥ ÏïÑÎûò Ï£ºÏÑùÏùÑ Ìï¥Ï†úÌïòÏÑ∏Ïöî.
#
# Ïö©ÎèÑ: Production Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ ÏàòÎèô ÏóÖÎç∞Ïù¥Ìä∏
# Ìä∏Î¶¨Í±∞: workflow_dispatch (ÏàòÎèô)
# =============================================================================

name: Update Production Image Tag (Disabled)

# ÏàòÎèô Ìä∏Î¶¨Í±∞Îßå - ÏûêÎèô Ïã§Ìñâ Ïïà Îê®
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'This workflow is disabled. Set to true to run placeholder.'
        required: true
        type: boolean
        default: false

jobs:
  disabled-placeholder:
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Disabled Notice
        run: |
          echo "‚ö†Ô∏è This workflow is currently disabled."
          echo ""
          echo "To enable this workflow:"
          echo "1. Edit .github/workflows/ci-prod-images.yaml"
          echo "2. Uncomment the full workflow content below"
          echo "3. Remove this placeholder job"
          echo ""
          echo "See the commented section below for the full implementation."

# =============================================================================
# ÏïÑÎûòÎäî ÏõêÎ≥∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏûÖÎãàÎã§. ÌôúÏÑ±ÌôîÌïòÎ†§Î©¥ Ï£ºÏÑùÏùÑ Ìï¥Ï†úÌïòÏÑ∏Ïöî.
# =============================================================================

# name: Update Production Image Tag
#
# on:
#   workflow_dispatch:
#     inputs:
#       service:
#         description: 'Service name'
#         required: true
#         type: choice
#         options:
#           - auth-service
#           - board-service
#           - chat-service
#           - noti-service
#           - storage-service
#           - user-service
#           - video-service
#       image_tag:
#         description: 'Image tag to deploy (e.g., 42-abc1234)'
#         required: true
#         type: string
#       create_pr:
#         description: 'Create PR instead of direct update'
#         required: false
#         type: boolean
#         default: true
#
# env:
#   AWS_REGION: ap-northeast-2
#
# jobs:
#   list-available-images:
#     runs-on: ubuntu-latest
#     permissions:
#       id-token: write
#       contents: read
#
#     steps:
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
#           aws-region: ${{ env.AWS_REGION }}
#
#       - name: List recent prod images
#         run: |
#           echo "### üì¶ Recent Images for prod/${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
#
#           aws ecr describe-images \
#             --repository-name "prod/${{ inputs.service }}" \
#             --region ${{ env.AWS_REGION }} \
#             --query 'sort_by(imageDetails,& imagePushedAt)[-10:].[imageTags[0],imagePushedAt]' \
#             --output table >> $GITHUB_STEP_SUMMARY || echo "No images found"
#
#           echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
#
#       - name: Verify selected image exists
#         run: |
#           echo "Verifying image: prod/${{ inputs.service }}:${{ inputs.image_tag }}"
#
#           aws ecr describe-images \
#             --repository-name "prod/${{ inputs.service }}" \
#             --region ${{ env.AWS_REGION }} \
#             --image-ids imageTag=${{ inputs.image_tag }}
#
#           echo "‚úÖ Image verified"
#
#   update-manifest:
#     needs: list-available-images
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
#       pull-requests: write
#       issues: write
#       repository-projects: read
#
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           token: ${{ secrets.GITOPS_PAT || github.token }}
#           fetch-depth: 0
#
#       - name: Configure Git
#         run: |
#           git config user.name "GitHub Action Bot"
#           git config user.email "action@github.com"
#
#       - name: Checkout k8s-deploy-prod branch
#         run: |
#           git fetch origin k8s-deploy-prod
#           git checkout k8s-deploy-prod
#
#       - name: Update ArgoCD Application manifest
#         run: |
#           SERVICE="${{ inputs.service }}"
#           TAG="${{ inputs.image_tag }}"
#
#           MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
#
#           if [ ! -f "$MANIFEST" ]; then
#             echo "‚ùå Manifest file not found: ${MANIFEST}"
#             exit 1
#           fi
#
#           echo "üìù Updating ${MANIFEST}"
#           echo "New tag: ${TAG}"
#
#           sed -i.bak '/- name: image\.tag/{
#             n
#             s|value: ".*"|value: "'"${TAG}"'"|
#           }' "$MANIFEST"
#
#           rm -f "${MANIFEST}.bak"
#
#           echo ""
#           echo "=== Updated section ==="
#           grep -A 1 "name: image.tag" "$MANIFEST"
#           echo "======================="
#
#           git diff "$MANIFEST"
#
#       - name: Create PR or commit
#         env:
#           GH_TOKEN: ${{ secrets.GITOPS_PAT || github.token }}
#         run: |
#           SERVICE="${{ inputs.service }}"
#           TAG="${{ inputs.image_tag }}"
#
#           if [ "${{ inputs.create_pr }}" = "true" ]; then
#             BRANCH_NAME="deploy/${SERVICE}-${TAG}"
#             git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
#             git checkout -b "$BRANCH_NAME"
#             git add .
#             git commit -m "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}"
#             git push origin "$BRANCH_NAME"
#
#             gh pr create \
#               --title "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}" \
#               --body "Production deployment for ${SERVICE} with tag ${TAG}" \
#               --base k8s-deploy-prod \
#               --head "$BRANCH_NAME"
#
#             echo "‚úÖ PR created: ${BRANCH_NAME}"
#           else
#             git add .
#             git commit -m "üöÄ [PROD] Deploy ${SERVICE} - ${TAG}"
#             git push origin k8s-deploy-prod
#             echo "‚ö†Ô∏è Changes pushed directly to k8s-deploy-prod"
#           fi
