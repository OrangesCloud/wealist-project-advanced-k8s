name: Update Production Image Tag

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: true
        type: choice
        options:
          - auth-service
          - board-service
          - chat-service
          - noti-service
          - storage-service
          - user-service
          - video-service
      image_tag:
        description: 'Image tag to deploy (e.g., 42-abc1234)'
        required: true
        type: string
      create_pr:
        description: 'Create PR instead of direct update'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  list-available-images:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_BACKEND }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: List recent prod images
        run: |
          echo "### ğŸ“¦ Recent Images for prod/${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          aws ecr describe-images \
            --repository-name "prod/${{ inputs.service }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-10:].[imageTags[0],imagePushedAt]' \
            --output table >> $GITHUB_STEP_SUMMARY || echo "No images found"
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Verify selected image exists
        run: |
          echo "Verifying image: prod/${{ inputs.service }}:${{ inputs.image_tag }}"
          
          aws ecr describe-images \
            --repository-name "prod/${{ inputs.service }}" \
            --region ${{ env.AWS_REGION }} \
            --image-ids imageTag=${{ inputs.image_tag }}
          
          echo "âœ… Image verified"

  update-manifest:
    needs: list-available-images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"
      
      - name: Checkout k8s-deploy-prod branch
        run: |
          git fetch origin k8s-deploy-prod
          git checkout k8s-deploy-prod
      
      - name: Update ArgoCD Application manifest
        run: |
          SERVICE="${{ inputs.service }}"
          TAG="${{ inputs.image_tag }}"
          
          # ArgoCD Application manifest ê²½ë¡œ
          MANIFEST="k8s/argocd/apps/prod/${SERVICE}.yaml"
          
          if [ ! -f "$MANIFEST" ]; then
            echo "âŒ Manifest file not found: ${MANIFEST}"
            exit 1
          fi
          
          echo "ğŸ“ Updating ${MANIFEST}"
          echo "New tag: ${TAG}"
          
          # image.tag íŒŒë¼ë¯¸í„°ë§Œ ì—…ë°ì´íŠ¸
          sed -i.bak '/- name: image\.tag/{
            n
            s|value: ".*"|value: "'"${TAG}"'"|
          }' "$MANIFEST"
          
          rm -f "${MANIFEST}.bak"
          
          echo ""
          echo "=== Updated section ==="
          grep -A 1 "name: image.tag" "$MANIFEST"
          echo "======================="
          echo ""
          
          # ì „ì²´ ë³€ê²½ì‚¬í•­ í™•ì¸
          git diff "$MANIFEST"
      
      - name: Create PR or commit
        env:
          GH_TOKEN: ${{ secrets.GITOPS_PAT }}
        run: |
          SERVICE="${{ inputs.service }}"
          TAG="${{ inputs.image_tag }}"
          
          if [ "${{ inputs.create_pr }}" = "true" ]; then
            BRANCH_NAME="deploy/${SERVICE}-${TAG}"
            
            # ê¸°ì¡´ ë¸Œëœì¹˜ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
            
            # ìƒˆ ë¸Œëœì¹˜ ìƒì„±
            git checkout -b "$BRANCH_NAME"
            git add .
            git commit -m "ğŸš€ [PROD] Deploy ${SERVICE} - ${TAG}"
            git push origin "$BRANCH_NAME"
            
            # PR bodyë¥¼ heredocìœ¼ë¡œ ì €ì¥
            PR_BODY=$(cat <<'EOF'
          ## Production Deployment Request
          
          **Service:** `SERVICE_PLACEHOLDER`  
          **Image Tag:** `TAG_PLACEHOLDER`  
          **ECR Image:** `prod/SERVICE_PLACEHOLDER:TAG_PLACEHOLDER`  
          **Manifest:** `k8s/argocd/apps/prod/SERVICE_PLACEHOLDER.yaml`
          
          ### Pre-deployment Checklist
          - [ ] Dev/Staging í…ŒìŠ¤íŠ¸ ì™„ë£Œ
          - [ ] ì„±ëŠ¥ ë° ë¦¬ì†ŒìŠ¤ ê²€í†  ì™„ë£Œ
          - [ ] íŒ€ì› ìŠ¹ì¸ ì™„ë£Œ
          
          ### Deployment Steps
          1. ì´ PR ë¦¬ë·° ë° ìŠ¹ì¸
          2. PR Merge
          3. ArgoCD UIì—ì„œ **SERVICE_PLACEHOLDER-prod** ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **Sync** ë²„íŠ¼ í´ë¦­
          4. ë°°í¬ ëª¨ë‹ˆí„°ë§ (Discord ì•Œë¦¼ í™•ì¸)
          
          ---
          âš ï¸ **ì£¼ì˜**: ìë™ ë°°í¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ArgoCDì—ì„œ ìˆ˜ë™ Sync í•„ìš”
          
          Requested by: @ACTOR_PLACEHOLDER
          EOF
            )
            
            # Placeholder ì¹˜í™˜
            PR_BODY="${PR_BODY//SERVICE_PLACEHOLDER/$SERVICE}"
            PR_BODY="${PR_BODY//TAG_PLACEHOLDER/$TAG}"
            PR_BODY="${PR_BODY//ACTOR_PLACEHOLDER/${{ github.actor }}}"
            
            # PR ìƒì„±
            gh pr create \
              --title "ğŸš€ [PROD] Deploy ${SERVICE} - ${TAG}" \
              --body "$PR_BODY" \
              --base k8s-deploy-prod \
              --head "$BRANCH_NAME"
            
            echo "âœ… PR created: ${BRANCH_NAME}"
            echo ""
            echo "### ğŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge after approval" >> $GITHUB_STEP_SUMMARY
            echo "3. Sync in ArgoCD" >> $GITHUB_STEP_SUMMARY
          else
            # ì§ì ‘ ì»¤ë°‹ (ë¹„ê¶Œì¥)
            git add .
            git commit -m "ğŸš€ [PROD] Deploy ${SERVICE} - ${TAG}

          Updated by: ${{ github.actor }}
          Manual deployment trigger"
            
            git push origin k8s-deploy-prod
            
            echo "âš ï¸ Changes pushed directly to k8s-deploy-prod"
            echo "Go to ArgoCD and manually sync ${SERVICE}-prod"
          fi
      
      - name: Deployment summary
        run: |
          echo "## ğŸš€ Production Image Tag Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Image:** \`prod/${{ inputs.service }}:${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Manifest:** \`k8s/argocd/apps/prod/${{ inputs.service }}.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸ”„ Go to ArgoCD UI" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ¯ Find **${{ inputs.service }}-prod** application" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸš€ Click **Sync** button" >> $GITHUB_STEP_SUMMARY
          echo "5. ğŸ‘€ Monitor deployment" >> $GITHUB_STEP_SUMMARY