# Auth Service - Standalone Docker Compose
# 인프라(redis)가 외부에서 실행 중일 때 단독 실행용
#
# 사용법:
#   docker compose up
#
# 주의: 먼저 인프라를 시작하세요
#   cd ../../docker && ./scripts/dev.sh infra

services:
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: wealist/auth-service:local
    container_name: wealist-auth-service-standalone
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - SPRING_PROFILES_ACTIVE=dev
      # Redis
      - SPRING_REDIS_HOST=host.docker.internal
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=redis_password
      # JWT
      - JWT_SECRET=dev-jwt-secret-key-change-in-production
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=3600000
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000
      # OAuth (standalone 모드 - nginx 없이 직접 접근)
      # 전체 스택 사용 시: docker/compose/docker-compose.yml 사용 (nginx port 80)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-your-google-client-id}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-your-google-client-secret}
      - OAUTH2_CLIENT_REDIRECT_URI=http://localhost:8080/oauth2/callback/google
      - OAUTH2_REDIRECT_URL_ENV=http://localhost:3000/oauth/callback
      # User Service URL
      - USER_SERVICE_URL=http://host.docker.internal:8081
      # Java Options
      - JAVA_OPTS=-Xms128m -Xmx256m
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
