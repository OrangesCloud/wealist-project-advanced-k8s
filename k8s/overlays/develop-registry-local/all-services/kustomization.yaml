# =============================================================================
# Kustomization - All Services (Local Registry + local.wealist.co.kr)
# =============================================================================
# 로컬 레지스트리(localhost:5001)를 사용하고
# local.wealist.co.kr 도메인으로 접근하는 환경용
#
# 사용법:
#   make local-kind-apply

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Infrastructure (includes namespace)
  - ../../../../infrastructure/overlays/develop

  # Shared config & ingress
  - ../../../base/shared
  - ingress.yaml

  # Backend Services (base only, we override images here)
  - ../../../../services/auth-service/k8s/base
  - ../../../../services/user-service/k8s/base
  - ../../../../services/board-service/k8s/base
  - ../../../../services/chat-service/k8s/base
  - ../../../../services/noti-service/k8s/base
  - ../../../../services/storage-service/k8s/base
  - ../../../../services/video-service/k8s/base

  # Frontend
  - ../../../../services/frontend/k8s/base

# Override images to use local registry
images:
  - name: auth-service
    newName: localhost:5001/auth-service
    newTag: latest
  - name: user-service
    newName: localhost:5001/user-service
    newTag: latest
  - name: board-service
    newName: localhost:5001/board-service
    newTag: latest
  - name: chat-service
    newName: localhost:5001/chat-service
    newTag: latest
  - name: noti-service
    newName: localhost:5001/noti-service
    newTag: latest
  - name: storage-service
    newName: localhost:5001/storage-service
    newTag: latest
  - name: video-service
    newName: localhost:5001/video-service
    newTag: latest
  - name: frontend
    newName: localhost:5001/frontend
    newTag: latest

# Set namespace for all resources
namespace: wealist-dev

# Common labels
labels:
  - pairs:
      app.kubernetes.io/env: develop
      app.kubernetes.io/registry: local
      app.kubernetes.io/domain: local.wealist.co.kr
    includeSelectors: false

# Patches for local.wealist.co.kr domain
patches:
  # Auth service: OAuth2 redirect URLs
  - target:
      kind: ConfigMap
      name: auth-service-config
    patch: |-
      - op: replace
        path: /data/OAUTH2_REDIRECT_URL_ENV
        value: "http://local.wealist.co.kr/oauth/callback"
      - op: replace
        path: /data/OAUTH2_CLIENT_REDIRECT_URI
        value: "http://local.wealist.co.kr/login/oauth2/code/google"

  # Board service: Add SERVER_BASE_PATH for ingress routing
  - target:
      kind: ConfigMap
      name: board-service-config
    patch: |-
      - op: add
        path: /data/SERVER_BASE_PATH
        value: "/api/boards"

  # Chat service: Add SERVER_BASE_PATH for ingress routing
  - target:
      kind: ConfigMap
      name: chat-service-config
    patch: |-
      - op: add
        path: /data/SERVER_BASE_PATH
        value: "/api/chats"

  # User service: Add SERVER_BASE_PATH for ingress routing
  - target:
      kind: ConfigMap
      name: user-service-config
    patch: |-
      - op: add
        path: /data/SERVER_BASE_PATH
        value: "/api"

  # Storage service: S3_PUBLIC_ENDPOINT for local.wealist.co.kr domain
  - target:
      kind: ConfigMap
      name: storage-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://local.wealist.co.kr/minio"

  # User service: S3_PUBLIC_ENDPOINT for local.wealist.co.kr domain
  - target:
      kind: ConfigMap
      name: user-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://local.wealist.co.kr/minio"

  # Board service: S3_PUBLIC_ENDPOINT for local.wealist.co.kr domain
  - target:
      kind: ConfigMap
      name: board-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://local.wealist.co.kr/minio"
