# =============================================================================
# Kustomization - All Services (Local Registry + CDN Backend)
# =============================================================================
# 로컬 레지스트리(localhost:5001)를 사용하고 CloudFront CDN 백엔드로 동작
# __PUBLIC_DOMAIN__: 사용자 접속용 도메인 (OAuth, WebSocket 등)
# __API_DOMAIN__: CloudFront → 백엔드 Origin용 (자동 생성: api.PUBLIC_DOMAIN)
#
# 사용법:
#   make kind-apply                                    # 기본: dev.wealist.co.kr
#   make kind-apply PUBLIC_DOMAIN=prod.wealist.co.kr   # 커스텀 도메인

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Infrastructure (includes namespace)
  - ../../../../infrastructure/overlays/develop

  # Dev environment (configmap + secrets)
  - ../../../base/namespace-dev

  # Ingress
  - ingress.yaml

  # Backend Services (base only, we override images here)
  - ../../../../services/auth-service/k8s/base
  - ../../../../services/user-service/k8s/base
  - ../../../../services/board-service/k8s/base
  - ../../../../services/chat-service/k8s/base
  - ../../../../services/noti-service/k8s/base
  - ../../../../services/storage-service/k8s/base
  - ../../../../services/video-service/k8s/base

# Override images to use local registry
images:
  - name: auth-service
    newName: localhost:5001/auth-service
    newTag: latest
  - name: user-service
    newName: localhost:5001/user-service
    newTag: latest
  - name: board-service
    newName: localhost:5001/board-service
    newTag: latest
  - name: chat-service
    newName: localhost:5001/chat-service
    newTag: latest
  - name: noti-service
    newName: localhost:5001/noti-service
    newTag: latest
  - name: storage-service
    newName: localhost:5001/storage-service
    newTag: latest
  - name: video-service
    newName: localhost:5001/video-service
    newTag: latest

# Set namespace for all resources
namespace: wealist-dev

# Common labels
labels:
  - pairs:
      app.kubernetes.io/env: develop
      app.kubernetes.io/registry: local
      app.kubernetes.io/domain: __PUBLIC_DOMAIN__
    includeSelectors: false

# Patches for custom domain (use __PUBLIC_DOMAIN__ placeholder)
patches:
  # Auth service: OAuth2 redirect URLs
  - target:
      kind: ConfigMap
      name: auth-service-config
    patch: |-
      - op: replace
        path: /data/OAUTH2_REDIRECT_URL_ENV
        value: "https://__PUBLIC_DOMAIN__/oauth/callback"
      - op: replace
        path: /data/OAUTH2_CLIENT_REDIRECT_URI
        value: "https://__PUBLIC_DOMAIN__/oauth2/callback/google"

  # Chat service: Add SERVER_BASE_PATH for ingress routing
  - target:
      kind: ConfigMap
      name: chat-service-config
    patch: |-
      - op: add
        path: /data/SERVER_BASE_PATH
        value: "/api/chats"

  # Chat service: Update health check paths to match SERVER_BASE_PATH
  - target:
      kind: Deployment
      name: chat-service
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe/httpGet/path
        value: "/api/chats/health/live"
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe/httpGet/path
        value: "/api/chats/health/ready"

  # User service: Add SERVER_BASE_PATH for ingress routing
  - target:
      kind: ConfigMap
      name: user-service-config
    patch: |-
      - op: add
        path: /data/SERVER_BASE_PATH
        value: "/api"

  # User service: Update health check paths to match SERVER_BASE_PATH
  - target:
      kind: Deployment
      name: user-service
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe/httpGet/path
        value: "/api/health/live"
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe/httpGet/path
        value: "/api/health/ready"

  # Storage service: S3_PUBLIC_ENDPOINT for custom domain
  - target:
      kind: ConfigMap
      name: storage-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://__PUBLIC_DOMAIN__/minio"

  # User service: S3_PUBLIC_ENDPOINT for custom domain
  - target:
      kind: ConfigMap
      name: user-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://__PUBLIC_DOMAIN__/minio"

  # Board service: S3_PUBLIC_ENDPOINT for custom domain
  - target:
      kind: ConfigMap
      name: board-service-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://__PUBLIC_DOMAIN__/minio"

  # Shared config: S3_PUBLIC_ENDPOINT for custom domain
  - target:
      kind: ConfigMap
      name: wealist-config
    patch: |-
      - op: replace
        path: /data/S3_PUBLIC_ENDPOINT
        value: "https://__PUBLIC_DOMAIN__/minio"

  # Video service: LiveKit WebSocket URL for custom domain (through CloudFront)
  - target:
      kind: ConfigMap
      name: video-service-config
    patch: |-
      - op: replace
        path: /data/LIVEKIT_WS_URL
        value: "wss://__PUBLIC_DOMAIN__/svc/livekit"

  # LiveKit: Configure for external access with API domain
  # This patches the livekit.yaml embedded in the ConfigMap
  - target:
      kind: ConfigMap
      name: livekit-config
    patch: |-
      - op: replace
        path: /data/livekit.yaml
        value: |
          port: 7880
          rtc:
            port_range_start: 50000
            port_range_end: 60000
            tcp_port: 7881
            # For NAT/firewall environments, use external IP detection
            use_external_ip: true
            enable_loopback_candidate: false
          keys:
            devkey: devsecretkey1234567890abcdefghijk
          logging:
            level: debug
            json: false
          room:
            empty_timeout: 300
            max_participants: 100
          turn:
            enabled: true
            domain: __API_DOMAIN__
            tls_port: 0
            udp_port: 3478
