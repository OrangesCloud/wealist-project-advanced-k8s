# =============================================================================
# Dev Environment (Kind + ArgoCD Auto-Deploy)
# =============================================================================
# Dev environment with dev.wealist.co.kr domain
# Uses AWS ECR + ArgoCD for GitOps deployment (like prod EKS)
# Namespace: wealist-dev

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: dev
  domain: dev.wealist.co.kr
  # AWS ECR Registry
  imageRegistry: "290008131187.dkr.ecr.ap-northeast-2.amazonaws.com"

# imagePullSecrets (Kind + ECR)
imagePullSecrets:
  - name: ecr-secret

# -----------------------------------------------------------------------------
# cert-manager Configuration (Disabled - CloudFront handles SSL termination)
# -----------------------------------------------------------------------------
certManager:
  enabled: false

# -----------------------------------------------------------------------------
# Deployment Settings
# -----------------------------------------------------------------------------
image:
  pullPolicy: Always
  tag: "dev-latest"

# -----------------------------------------------------------------------------
# Security (Standard)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  readOnlyRootFilesystem: false

# -----------------------------------------------------------------------------
# External Secrets Operator (ESO)
# -----------------------------------------------------------------------------
# ESO가 AWS Secrets Manager에서 wealist-shared-secret을 자동 생성
# Helm chart에서 secret 생성을 건너뜀
externalSecrets:
  enabled: true

# -----------------------------------------------------------------------------
# Features
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false

serviceAccount:
  create: true

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------
shared:
  config:
    # Environment
    ENV: "dev"
    LOG_LEVEL: "info"
    CORS_ORIGINS: "https://dev.wealist.co.kr,https://api.dev.wealist.co.kr"

    # Database (외부 호스트 - Docker bridge gateway)
    DB_HOST: "172.17.0.1"
    POSTGRES_HOST: "172.17.0.1"
    DB_AUTO_MIGRATE: "true"

    # Redis (외부 호스트)
    REDIS_HOST: "172.17.0.1"
    SPRING_REDIS_HOST: "172.17.0.1"
    SPRING_DATA_REDIS_SSL_ENABLED: "false"

    # S3/MinIO Configuration
    S3_ENDPOINT: "http://minio:9000"
    S3_PUBLIC_ENDPOINT: "https://dev.wealist.co.kr/api/minio"
    S3_BUCKET: "wealist-files"
    S3_REGION: "ap-northeast-2"

    # OAuth2
    OAUTH2_CLIENT_REDIRECT_URI: "https://api.dev.wealist.co.kr/api/oauth2/callback/google"
    OAUTH2_REDIRECT_URL_ENV: "https://dev.wealist.co.kr/oauth/callback"

    # LiveKit
    LIVEKIT_WS_URL: "wss://dev.wealist.co.kr/api/svc/livekit"

    # OTEL (dev: 50% 샘플링)
    OTEL_TRACES_SAMPLER_ARG: "0.5"
    OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=dev"

# -----------------------------------------------------------------------------
# Ingress (Disabled - Istio Gateway)
# -----------------------------------------------------------------------------
ingress:
  enabled: false

# -----------------------------------------------------------------------------
# Database (External - Host machine or AWS RDS)
# -----------------------------------------------------------------------------
postgres:
  enabled: false
  external:
    enabled: true
    host: "172.17.0.1"
    port: 5432

redis:
  enabled: false
  external:
    enabled: true
    host: "172.17.0.1"
    port: 6379

# -----------------------------------------------------------------------------
# MinIO (S3 Compatible Object Storage)
# -----------------------------------------------------------------------------
minio:
  enabled: true
  image:
    repository: minio/minio
    tag: "latest"
  persistence:
    enabled: true
    hostPath:
      enabled: true
      path: /data/minio

# -----------------------------------------------------------------------------
# Frontend (CDN - S3/CloudFront)
# -----------------------------------------------------------------------------
frontend:
  enabled: false

# -----------------------------------------------------------------------------
# Istio Service Mesh
# -----------------------------------------------------------------------------
istio:
  enabled: true
  namespace: wealist-dev

  gateway:
    enabled: false
    name: wealist-gateway
    hosts:
      - "dev.wealist.co.kr"
      - "api.dev.wealist.co.kr"
      - "*"
    tls:
      enabled: false

  httpRoute:
    enabled: true
    gatewayRef:
      name: istio-ingressgateway
      namespace: istio-system
    hosts:
      - "dev.wealist.co.kr"
      - "api.dev.wealist.co.kr"
      - "localhost"
      - "*"  # Kind 로컬 접근용
    frontend:
      enabled: false
    minio:
      enabled: true
      host: minio
      port: 9000
    monitoring:
      enabled: true
      grafana:
        host: grafana
        port: 3000
      prometheus:
        host: prometheus
        port: 9090
      loki:
        host: loki
        port: 3100
      kiali:
        enabled: true
        host: kiali
        namespace: istio-system
        port: 20001
      jaeger:
        enabled: true
        host: tracing
        namespace: istio-system
        port: 80
    # ArgoCD UI (/api/argo)
    argocd:
      enabled: true
    # Ops Portal (dev에서는 비활성화)
    opsPortal:
      enabled: false

  mtls:
    enabled: true
    mode: STRICT

  database:
    postgres:
      disableMtls: false
    redis:
      disableMtls: false

  services:
    - name: auth-service
    - name: user-service
    - name: board-service
    - name: chat-service
    - name: noti-service
    - name: storage-service
    - name: video-service

  destinationRules:
    enabled: true
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

  authorizationPolicy:
    enabled: true
    denyAll: true
    allowSameNamespace: true

  serviceAuthorization:
    enabled: true

  jwtAuth:
    enabled: false

  ambient:
    enabled: true
    waypoint:
      enabled: true
      name: wealist-waypoint

  telemetry:
    tracing:
      enabled: true
      samplingPercentage: 50
    accessLogging:
      enabled: true

# =============================================================================
# Monitoring Stack
# =============================================================================
prometheus:
  enabled: true
  image:
    repository: prom/prometheus
    tag: "v2.48.0"
  config:
    externalUrl: "https://dev.wealist.co.kr/api/monitoring/prometheus"
    routePrefix: "/api/monitoring/prometheus"
  persistence:
    enabled: true
    hostPath:
      enabled: true
      path: /data/prometheus

loki:
  enabled: true
  image:
    repository: grafana/loki
    tag: "2.9.2"
  persistence:
    enabled: true
    hostPath:
      enabled: true
      path: /data/loki

promtail:
  enabled: true
  image:
    repository: grafana/promtail
    tag: "2.9.2"

grafana:
  enabled: true
  image:
    repository: grafana/grafana
    tag: "10.2.2"
  persistence:
    enabled: true
    hostPath:
      enabled: true
      path: /data/grafana
  config:
    allowSignUp: false
    rootUrl: "https://dev.wealist.co.kr/api/monitoring/grafana"
    serveFromSubPath: "true"

monitoringIngress:
  enabled: false

postgresExporter:
  enabled: true
  image:
    repository: prometheuscommunity/postgres-exporter
    tag: "v0.15.0"
  config:
    host: "172.17.0.1"
    port: 5432

redisExporter:
  enabled: true
  image:
    repository: oliver006/redis_exporter
    tag: "v1.55.0"
  config:
    host: "172.17.0.1"
    port: 6379

# =============================================================================
# Service-specific Database Configuration
# =============================================================================
# Dev: 모든 서비스가 공통 DB 사용 (wealist)
# 호스트 PostgreSQL에 wealist DB가 있어야 함
board-service:
  config:
    DB_NAME: "wealist"

user-service:
  config:
    DB_NAME: "wealist"

chat-service:
  config:
    DB_NAME: "wealist"

noti-service:
  config:
    DB_NAME: "wealist"

storage-service:
  config:
    DB_NAME: "wealist"

video-service:
  config:
    DB_NAME: "wealist"
