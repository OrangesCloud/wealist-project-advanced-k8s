# =============================================================================
# Development Server Environment
# =============================================================================
# Development environment with dev.wealist.co.kr domain
# Uses local registry (localhost:5001) for Kind cluster
# Namespace: wealist-dev

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: development
  domain: dev.wealist.co.kr
  imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# cert-manager Configuration (Disabled - CloudFront handles SSL termination)
# -----------------------------------------------------------------------------
certManager:
  enabled: false
  # Note: SSL is handled by CloudFront, K8s receives HTTP only

# -----------------------------------------------------------------------------
# Deployment Settings
# -----------------------------------------------------------------------------
replicaCount: 1

image:
  pullPolicy: Always
  tag: "latest" # Local registry uses :latest tag

# -----------------------------------------------------------------------------
# Resources (Development)
# -----------------------------------------------------------------------------
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# -----------------------------------------------------------------------------
# Health Check
# -----------------------------------------------------------------------------
healthCheck:
  liveness:
    initialDelaySeconds: 30
  readiness:
    initialDelaySeconds: 10

# -----------------------------------------------------------------------------
# Security (Standard)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  readOnlyRootFilesystem: false # Spring Boot (Tomcat) needs /tmp write access

# -----------------------------------------------------------------------------
# Features
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false

serviceAccount:
  create: true

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# Database Configuration (dev server specific)
# -----------------------------------------------------------------------------
# Use HOST PC's PostgreSQL and Redis instead of cluster's internal DB
# This ensures data persistence across cluster resets
#
# Prerequisites:
#   1. PostgreSQL installed on host: sudo apt install postgresql
#   2. Redis installed on host: sudo apt install redis-server
#   3. PostgreSQL pg_hba.conf allows connections from Docker network:
#      host    all    all    172.17.0.0/16    md5
#      host    all    all    172.18.0.0/16    md5
#   4. PostgreSQL postgresql.conf: listen_addresses = '*'
#   5. Redis redis.conf: bind 0.0.0.0, protected-mode no
#
# Note: Kind uses its own bridge network (172.18.0.0/16)
#       172.18.0.1 is the gateway IP that Kind pods use to reach the host

postgres:
  enabled: false  # Disable internal PostgreSQL StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 5432

redis:
  enabled: false  # Disable internal Redis StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 6379

# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------
shared:
  config:
    ENV: "development"
    LOG_LEVEL: "debug"
    DB_AUTO_MIGRATE: "false"  # Disabled - external DB has existing data
    CORS_ORIGINS: "https://dev.wealist.co.kr,https://api.dev.wealist.co.kr"
    S3_PUBLIC_ENDPOINT: "https://dev.wealist.co.kr/minio"
    LIVEKIT_WS_URL: "wss://dev.wealist.co.kr/svc/livekit"
    # OAuth2 Redirect URLs
    # Google redirects here after user authenticates (must match Google Console)
    OAUTH2_CLIENT_REDIRECT_URI: "https://api.dev.wealist.co.kr/oauth2/callback/google"
    # auth-service redirects here (frontend) after processing OAuth
    OAUTH2_REDIRECT_URL_ENV: "https://dev.wealist.co.kr/oauth/callback"

    # External Database Configuration (Host PC's PostgreSQL/Redis)
    DB_HOST: "postgres"       # K8s Service name (routes to 172.18.0.1)
    DB_PORT: "5432"
    DB_USER: "postgres"       # Host PC PostgreSQL superuser
    DB_SSLMODE: "disable"
    REDIS_HOST: "redis"       # K8s Service name (routes to 172.18.0.1)
    REDIS_PORT: "6379"

  # Secrets for dev environment (stored in K8s Secret)
  secrets:
    DB_PASSWORD: "postgres"   # Host PC PostgreSQL password
    REDIS_PASSWORD: ""        # No password for local Redis

# -----------------------------------------------------------------------------
# Ingress (HTTP only - CloudFront handles SSL termination)
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: nginx
  # Frontend is served via S3/CloudFront, not K8s
  includeFrontend: false
  annotations:
    # No cert-manager - CloudFront handles SSL
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # CloudFront with AllViewer policy forwards X-Forwarded-* headers
  hosts:
    # Main domain (CloudFront forwards with this Host header)
    - host: dev.wealist.co.kr
    # API endpoint
    - host: api.dev.wealist.co.kr
    # DDNS hostname for direct access (No-IP)
    - host: wonnyhome.myddns.me
  # No TLS - CloudFront handles SSL termination
  tls: []

# =============================================================================
# Monitoring Stack (wealist-monitoring chart values)
# =============================================================================
# 이 설정은 wealist-monitoring Helm 차트 배포 시 사용됩니다.
# helm-install-monitoring ENV=dev 명령 시 적용

# Prometheus - Metrics Collection
prometheus:
  enabled: true
  service:
    type: ClusterIP
    port: 9090
  persistence:
    enabled: true
    storageClass: "standard"
    size: 10Gi
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  config:
    scrapeInterval: 15s
    retentionTime: 7d

# Loki - Log Aggregation
loki:
  enabled: true
  service:
    type: ClusterIP
    port: 3100
  persistence:
    enabled: true
    storageClass: "standard"
    size: 10Gi
  config:
    retentionPeriod: 168h  # 7 days

# Promtail - Log Collector
promtail:
  enabled: true

# Grafana - Visualization Dashboard
grafana:
  enabled: true
  service:
    type: ClusterIP  # Ingress 사용하므로 ClusterIP
    port: 3000
  persistence:
    enabled: true
    size: 5Gi
  admin:
    user: admin
    password: admin  # TODO: 프로덕션에서는 시크릿으로 관리
  config:
    allowSignUp: false
    # Sub-path configuration for /monitoring/grafana access
    rootUrl: "https://dev.wealist.co.kr/monitoring/grafana"
    serveFromSubPath: "true"

# Ingress - External Access via https://dev.wealist.co.kr/monitoring/*
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"  # CloudFront handles SSL
  hosts:
    - host: dev.wealist.co.kr
    - host: api.dev.wealist.co.kr
    - host: wonnyhome.myddns.me
  tls: []  # No TLS - CloudFront handles SSL termination

# -----------------------------------------------------------------------------
# Database Exporters (for external DB monitoring)
# -----------------------------------------------------------------------------
postgresExporter:
  enabled: true
  image:
    repository: prometheuscommunity/postgres-exporter
    tag: v0.15.0
  service:
    port: 9187
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"
  # Connection to external PostgreSQL (host machine)
  config:
    host: "172.18.0.1"
    port: 5432
    user: "postgres"
    database: "postgres"
    sslmode: "disable"

redisExporter:
  enabled: true
  image:
    repository: oliver006/redis_exporter
    tag: v1.55.0
  service:
    port: 9121
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "64Mi"
      cpu: "50m"
  # Connection to external Redis (host machine)
  config:
    host: "172.18.0.1"
    port: 6379
