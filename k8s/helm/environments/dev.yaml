# =============================================================================
# Development Server Environment
# =============================================================================
# Development environment with dev.wealist.co.kr domain
# Uses AWS ECR + ArgoCD for deployment
# Namespace: wealist-dev

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: development
  domain: dev.wealist.co.kr
  # AWS ECR 레지스트리 (Kind-dev, EKS 모두 사용)
  # TODO: 290008131187를 실제 AWS 계정 ID로 교체하세요
  imageRegistry: "290008131187.dkr.ecr.ap-northeast-2.amazonaws.com"

# imagePullSecrets
# - Kind + ECR: ecr-secret 필요 (aws ecr get-login-password로 생성)
# - EKS + ECR: IRSA 사용 시 불필요 (빈 배열로 변경)
imagePullSecrets:
  - name: ecr-secret

# -----------------------------------------------------------------------------
# cert-manager Configuration (Disabled - CloudFront handles SSL termination)
# -----------------------------------------------------------------------------
certManager:
  enabled: false
  # Note: SSL is handled by CloudFront, K8s receives HTTP only

# -----------------------------------------------------------------------------
# Deployment Settings
# -----------------------------------------------------------------------------
# Note: Service-specific settings (replicaCount, resources, healthCheck)
# are defined in each service chart's values.yaml
# Do NOT define auth-service/board-service keys here to avoid parsing issues
# with wealist-infrastructure chart

image:
  # ECR 이미지 사용 - 항상 최신 pull
  pullPolicy: Always
  tag: "dev-latest"

# -----------------------------------------------------------------------------
# Security (Standard)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  readOnlyRootFilesystem: false  # Spring Boot (Tomcat) needs /tmp write access

# -----------------------------------------------------------------------------
# Features
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false

serviceAccount:
  create: true

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------
shared:
  config:
    ENV: "development"
    LOG_LEVEL: "debug"
    DB_AUTO_MIGRATE: "true"  # Create tables on startup
    CORS_ORIGINS: "https://dev.wealist.co.kr,https://api.dev.wealist.co.kr"
    # S3/MinIO Configuration
    S3_ENDPOINT: "http://minio:9000"
    S3_PUBLIC_ENDPOINT: "https://dev.wealist.co.kr/minio"
    S3_BUCKET: "wealist-files"
    S3_REGION: "ap-northeast-2"
    LIVEKIT_WS_URL: "wss://dev.wealist.co.kr/svc/livekit"
    # OAuth2 Redirect URLs
    # Google redirects here after user authenticates (must match Google Console)
    OAUTH2_CLIENT_REDIRECT_URI: "https://api.dev.wealist.co.kr/oauth2/callback/google"
    # auth-service redirects here (frontend) after processing OAuth
    OAUTH2_REDIRECT_URL_ENV: "https://dev.wealist.co.kr/oauth/callback"

# -----------------------------------------------------------------------------
# Ingress (nginx - 비활성화, Istio Gateway 사용)
# -----------------------------------------------------------------------------
ingress:
  enabled: false  # Istio HTTPRoute 사용

# -----------------------------------------------------------------------------
# 데이터베이스 설정 (외부 DB 사용 - AWS RDS/ElastiCache)
# -----------------------------------------------------------------------------
postgres:
  enabled: false   # 내부 PostgreSQL 비활성화
  external:
    enabled: true  # 외부 DB (AWS RDS 등) 사용
    # host/port는 secrets.yaml에서 설정

redis:
  enabled: false   # 내부 Redis 비활성화
  external:
    enabled: true  # 외부 Redis (AWS ElastiCache 등) 사용
    # host/port는 secrets.yaml에서 설정

# -----------------------------------------------------------------------------
# 프론트엔드 설정 (CDN 사용 - S3/CloudFront/Route53)
# -----------------------------------------------------------------------------
# dev.wealist.co.kr → CloudFront → S3 (정적 파일)
# api.dev.wealist.co.kr → CloudFront → ALB → EKS (API)
frontend:
  enabled: false  # Frontend pod 비활성화 (CDN 사용)

# -----------------------------------------------------------------------------
# Istio 서비스 메시 설정
# -----------------------------------------------------------------------------
istio:
  enabled: true
  namespace: wealist-dev

  gateway:
    enabled: false  # setup-cluster.sh에서 이미 생성됨
    name: wealist-gateway
    hosts:
      - "dev.wealist.co.kr"
      - "api.dev.wealist.co.kr"
      - "*"
    tls:
      enabled: false

  # HTTPRoute 설정 (Kubernetes Gateway API)
  httpRoute:
    enabled: true
    gatewayRef:
      name: istio-ingressgateway
      namespace: istio-system
    hosts:
      - "dev.wealist.co.kr"
      - "api.dev.wealist.co.kr"
    # Frontend Pod 라우팅 (비활성화 - CDN 사용)
    frontend:
      enabled: false
    # Monitoring routes (활성화 - dev.wealist.co.kr/monitoring/*)
    monitoring:
      enabled: true
      grafana:
        prefix: /monitoring/grafana
        host: grafana
        port: 3000
      prometheus:
        prefix: /monitoring/prometheus
        host: prometheus
        port: 9090
      loki:
        prefix: /monitoring/loki
        host: loki
        port: 3100

  # mTLS - 서비스 간 암호화
  mtls:
    enabled: true
    mode: STRICT  # dev 환경: mTLS 강제 (보안 강화)

  # Database mTLS 설정 (외부 DB 사용 - 해당 없음)
  database:
    postgres:
      disableMtls: false  # 내부 postgres pod 없음
    redis:
      disableMtls: false  # 내부 redis pod 없음

  # 서비스 목록 (DestinationRule 생성 대상)
  services:
    - name: auth-service
    - name: user-service
    - name: board-service
    - name: chat-service
    - name: noti-service
    - name: storage-service
    - name: video-service

  # 트래픽 제어 - Circuit Breaker, Connection Pool
  destinationRules:
    enabled: true
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
    # Circuit Breaker - 장애 서비스 격리
    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

  # 서비스 간 통신 제어
  # dev: Zero Trust 정책 적용
  authorizationPolicy:
    enabled: true
    denyAll: true  # dev: 기본 거부 (Zero Trust)

  # 서비스별 호출 권한 (L7 정책)
  serviceAuthorization:
    enabled: true  # dev: 활성화 (보안 강화)

  # JWT 인증
  # dev: Istio에서 JWT 검증
  jwtAuth:
    enabled: false  # 서비스에서 직접 처리 (추후 활성화 가능)

  # Ambient 모드 (Sidecar-less)
  ambient:
    enabled: true
    waypoint:
      enabled: true
      name: wealist-waypoint

  # 텔레메트리 - 트레이싱, 로깅
  telemetry:
    tracing:
      enabled: true
      samplingPercentage: 50  # dev 환경 50%
    accessLogging:
      enabled: true

# =============================================================================
# 모니터링 스택 설정
# =============================================================================
# Docker Hub 공식 이미지 사용 (EKS/Kind 모두 호환)
# ECR 사용 시: ArgoCD Application에서 오버라이드

# Prometheus - 메트릭 수집
prometheus:
  enabled: true
  image:
    repository: prom/prometheus
    tag: "v2.48.0"
  config:
    externalUrl: "https://api.dev.wealist.co.kr/monitoring/prometheus"

# Loki - 로그 수집
loki:
  enabled: true
  image:
    repository: grafana/loki
    tag: "2.9.2"

# Promtail - 로그 수집 에이전트
promtail:
  enabled: true
  image:
    repository: grafana/promtail
    tag: "2.9.2"

# Grafana - 시각화 대시보드
grafana:
  enabled: true
  image:
    repository: grafana/grafana
    tag: "10.2.2"
  config:
    allowSignUp: false
    rootUrl: "https://api.dev.wealist.co.kr/monitoring/grafana"
    serveFromSubPath: "true"

# 모니터링 Ingress (Istio HTTPRoute로 처리)
monitoringIngress:
  enabled: false

# -----------------------------------------------------------------------------
# 데이터베이스 Exporter (외부 DB 메트릭 수집)
# -----------------------------------------------------------------------------
# DB 호스트 설정:
#   - Mac/WSL (Docker Desktop): host.docker.internal
#   - Native Linux: 172.18.0.1 (Kind bridge gateway)
#   - EKS: RDS/ElastiCache 엔드포인트 (secrets.yaml에서 설정)
postgresExporter:
  enabled: true
  image:
    repository: prometheuscommunity/postgres-exporter
    tag: "v0.15.0"
  config:
    host: "host.docker.internal"  # Docker Desktop (Mac/WSL), Linux: 172.18.0.1
    port: 5432

redisExporter:
  enabled: true
  image:
    repository: oliver006/redis_exporter
    tag: "v1.55.0"
  config:
    host: "host.docker.internal"  # Docker Desktop (Mac/WSL), Linux: 172.18.0.1
    port: 6379
