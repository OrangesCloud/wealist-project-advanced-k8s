# =============================================================================
# 로컬 통합 환경 설정 (ENV=localhost)
# =============================================================================
# 도메인: localhost (Kind 클러스터)
# 네임스페이스: wealist-localhost
# 특징: 모든 컴포넌트가 클러스터 내부에서 실행 (DB, Frontend, Backend)
#
# 사용법:
#   make kind-localhost-setup
#   make helm-install-all ENV=localhost

# -----------------------------------------------------------------------------
# 전역 설정
# -----------------------------------------------------------------------------
global:
  namespace: wealist-localhost
  environment: development
  domain: localhost
  imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# cert-manager (localhost에서는 비활성화)
# -----------------------------------------------------------------------------
certManager:
  enabled: false

# -----------------------------------------------------------------------------
# 배포 설정
# -----------------------------------------------------------------------------
image:
  pullPolicy: Always
  tag: "latest"

# -----------------------------------------------------------------------------
# 보안 컨텍스트 (로컬 개발용 - 완화된 설정)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: false

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: false
  runAsUser: 0  # nginx(프론트엔드)가 chown 실행에 필요
  readOnlyRootFilesystem: false
  capabilities:
    drop: []  # 로컬 개발에서는 엄격한 권한 제한 불필요

# -----------------------------------------------------------------------------
# 기능 설정 (로컬 개발용 - 비활성화)
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false

serviceAccount:
  create: false

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# 데이터베이스 설정 (클러스터 내부 Pod로 실행)
# -----------------------------------------------------------------------------
postgres:
  enabled: true   # 클러스터 내부 PostgreSQL StatefulSet 활성화
  external:
    enabled: false

  image:
    repository: postgres
    tag: "15-alpine"
    pullPolicy: IfNotPresent

  replicas: 1

  persistence:
    enabled: true
    storageClass: ""
    size: 5Gi

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  config:
    superuser: "postgres"

redis:
  enabled: true   # 클러스터 내부 Redis StatefulSet 활성화
  external:
    enabled: false

  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent

  replicas: 1

  persistence:
    enabled: true
    storageClass: ""
    size: 2Gi

  config:
    password: ""

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# -----------------------------------------------------------------------------
# 프론트엔드 설정 (클러스터 내부 Pod로 실행)
# -----------------------------------------------------------------------------
frontend:
  enabled: true

  image:
    repository: frontend
    tag: "latest"
    pullPolicy: Always

  replicas: 1

  service:
    type: ClusterIP
    port: 80

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# -----------------------------------------------------------------------------
# 공유 설정
# -----------------------------------------------------------------------------
shared:
  config:
    # Environment
    ENV: "development"
    LOG_LEVEL: "debug"
    CORS_ORIGINS: "*"

    # Database (내부 Pod)
    DB_HOST: "postgres"
    POSTGRES_HOST: "postgres"
    DB_USER: "postgres"
    DB_SSLMODE: "disable"
    DB_AUTO_MIGRATE: "true"

    # Redis (내부 Pod)
    REDIS_HOST: "redis"
    # Spring Boot auth-service uses SPRING_REDIS_* naming convention
    SPRING_REDIS_HOST: "redis"
    SPRING_REDIS_PORT: "6379"
    SPRING_DATA_REDIS_SSL_ENABLED: "false"

    # S3/MinIO
    S3_ENDPOINT: "http://minio:9000"
    S3_PUBLIC_ENDPOINT: "http://localhost:8080/api/minio"
    S3_BUCKET: "wealist-files"
    S3_REGION: "ap-northeast-2"

    # OAuth2 리다이렉트 URL (localhost, Kind NodePort 8080)
    OAUTH2_CLIENT_REDIRECT_URI: "http://localhost:8080/api/oauth2/callback/google"
    OAUTH2_REDIRECT_URL_ENV: "http://localhost:8080/oauth/callback"

    # LiveKit (WebRTC)
    LIVEKIT_URL: "http://livekit:7880"
    LIVEKIT_WS_URL: "ws://localhost:8080/api/svc/livekit"

    # OTEL (개발: 100% 샘플링)
    OTEL_TRACES_SAMPLER_ARG: "1.0"
    OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=development"

  # 시크릿 (localhost 환경용)
  secrets:
    # Database
    DB_PASSWORD: "postgres"
    REDIS_PASSWORD: ""

    # S3/MinIO Credentials
    S3_ACCESS_KEY: "minioadmin"
    S3_SECRET_KEY: "minioadmin"

    # Security
    INTERNAL_API_KEY: "internal-key-change-me"
    JWT_SECRET: "dev-jwt-secret-change-in-production"

    # OAuth2 Credentials (placeholder for local)
    GOOGLE_CLIENT_ID: "placeholder-client-id.apps.googleusercontent.com"
    GOOGLE_CLIENT_SECRET: "placeholder-client-secret"

    # LiveKit Credentials
    LIVEKIT_API_KEY: "devkey"
    LIVEKIT_API_SECRET: "devsecret"

# -----------------------------------------------------------------------------
# Ingress 설정 (nginx - 비활성화, Istio Gateway 사용)
# -----------------------------------------------------------------------------
ingress:
  enabled: false  # Istio HTTPRoute 사용

# -----------------------------------------------------------------------------
# Istio 서비스 메시 설정
# -----------------------------------------------------------------------------
istio:
  enabled: true
  namespace: wealist-localhost

  gateway:
    enabled: false  # setup-cluster.sh에서 이미 생성됨
    name: wealist-gateway
    hosts:
      - "localhost"
      - "*"
    tls:
      enabled: false

  # HTTPRoute 설정 (Kubernetes Gateway API) - Disabled for Sidecar mode
  httpRoute:
    enabled: false  # Using VirtualService instead for Sidecar mode
    gatewayRef:
      name: istio-ingressgateway
      namespace: istio-system
    hosts:
      - "localhost"
      - "*"

  # VirtualService 설정 (Sidecar mode에서 활성화)
  virtualService:
    enabled: true
    hosts:
      - "*"
    canary:
      enabled: false
    # Frontend Pod 라우팅 (localhost 환경)
    frontend:
      enabled: true
    # MinIO 라우팅 (localhost에서는 비활성화)
    minio:
      enabled: false
      host: minio
      port: 9000
    # Monitoring routes (Grafana, Prometheus, Loki)
    # HTTPRoute에서 /api/monitoring/* 경로를 그대로 전달 (rewrite 없음)
    monitoring:
      enabled: true
      grafana:
        host: grafana
        port: 3000
      prometheus:
        host: prometheus
        port: 9090
      loki:
        host: loki
        port: 3100
      # Kiali: Istio Service Mesh 대시보드
      kiali:
        enabled: true
        host: kiali
        namespace: istio-system
        port: 20001
      # Jaeger: 분산 트레이싱 UI
      jaeger:
        enabled: true
        host: tracing
        namespace: istio-system
        port: 80

  # mTLS - 서비스 간 암호화
  mtls:
    enabled: true
    mode: PERMISSIVE  # 개발 환경: mTLS + 일반 HTTP 모두 허용

  # Database mTLS 설정 (PostgreSQL/Redis는 자체 프로토콜 사용)
  database:
    postgres:
      disableMtls: true  # postgres pod에 mTLS 비활성화
    redis:
      disableMtls: true  # redis pod에 mTLS 비활성화

  # 트래픽 제어 - Circuit Breaker, Connection Pool
  destinationRules:
    enabled: true
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
    # Circuit Breaker - 장애 서비스 격리
    outlierDetection:
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

  # 서비스 간 통신 제어
  # localhost: 개발 편의를 위해 완화된 정책
  # dev/prod: Zero Trust (denyAll: true) 적용
  authorizationPolicy:
    enabled: true
    denyAll: false  # localhost: 기본 허용 (개발 편의)
    allowSameNamespace: true  # localhost: 같은 네임스페이스 내 통신 허용

  # 서비스별 호출 권한 (L7 정책)
  serviceAuthorization:
    enabled: false  # localhost: 비활성화 (개발 편의)

  # JWT 인증
  # localhost: 비활성화 (서비스가 직접 처리)
  # dev/prod: Istio에서 JWT 검증
  jwtAuth:
    enabled: false

  # Sidecar Mode Configuration (2025 Best Practice)
  sidecar:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # 텔레메트리 - 트레이싱, 로깅
  telemetry:
    tracing:
      enabled: true
      samplingPercentage: 100  # 개발환경 100%, 프로덕션 1-10%
    accessLogging:
      enabled: true

# =============================================================================
# 모니터링 스택 설정 (wealist-monitoring 차트 값)
# =============================================================================

# Prometheus - 메트릭 수집
prometheus:
  enabled: true
  image:
    repository: localhost:5001/prometheus
    tag: "v2.48.0"
  config:
    externalUrl: "http://localhost:8080/api/monitoring/prometheus"
    routePrefix: "/api/monitoring/prometheus"
  # V3: OTEL Connectors → Prometheus (Span Metrics, Service Graph)
  remoteWriteReceiver:
    enabled: true
  # V3: Exemplars - Metrics → Traces 연결
  exemplarStorage:
    enabled: true

# Loki - 로그 수집
loki:
  enabled: true
  image:
    repository: localhost:5001/loki
    tag: "2.9.2"

# Promtail - 로그 수집 에이전트
promtail:
  enabled: true
  image:
    repository: localhost:5001/promtail
    tag: "2.9.2"

# Grafana - 시각화 대시보드
grafana:
  enabled: true
  image:
    repository: localhost:5001/grafana
    tag: "10.2.2"
  service:
    type: ClusterIP
    port: 3000
  config:
    allowSignUp: false
    rootUrl: "http://localhost:8080/api/monitoring/grafana"
    serveFromSubPath: "true"
  # V3 Dashboards - OTEL Native (2025-2026 best practices)
  dashboardsV3:
    enabled: true

# 모니터링 Ingress (nginx - 비활성화)
# NodePort로 직접 접근: Grafana(30001), Prometheus(30090)
monitoringIngress:
  enabled: false

# -----------------------------------------------------------------------------
# 데이터베이스 Exporter (내부 Pod 메트릭 수집)
# -----------------------------------------------------------------------------
postgresExporter:
  enabled: true
  image:
    repository: localhost:5001/postgres-exporter
    tag: "v0.15.0"
  config:
    host: "postgres"  # 내부 서비스명
    port: 5432
    user: "postgres"
    database: "postgres"
    sslmode: "disable"

redisExporter:
  enabled: true
  image:
    repository: localhost:5001/redis-exporter
    tag: "v1.55.0"
  config:
    host: "redis"  # 내부 서비스명
    port: 6379

# kube-state-metrics - Kubernetes 오브젝트 상태 메트릭
# Kubernetes Cluster 대시보드와 Service Health Overview에 필요
kubeStateMetrics:
  enabled: true
  image:
    repository: localhost:5001/kube-state-metrics
    tag: "v2.10.1"

# node-exporter - 노드 시스템 메트릭
# 노드 CPU/메모리 사용률 모니터링에 필요
nodeExporter:
  enabled: true
  image:
    repository: localhost:5001/node-exporter
    tag: "v1.7.0"

# =============================================================================
# OpenTelemetry 통합 (2025 Best Practice - Full OTEL Stack)
# =============================================================================
# 분산 추적(Traces) + 로그(Logs) + 메트릭(Metrics) 통합

# OTEL Collector - 트레이스/메트릭 수집 게이트웨이
otelCollector:
  enabled: true
  image:
    repository: localhost:5001/otel-collector-contrib
    tag: "0.114.0"  # 2025-12 최신 안정 버전
  replicas: 1
  service:
    otlpGrpcPort: 4317
    otlpHttpPort: 4318
    metricsPort: 8888
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  config:
    batchTimeout: 5s
    sendBatchSize: 1000
    memoryLimitMiB: 400
    spikeLimitMiB: 100
  # V3: Tail Sampling (localhost에서는 비활성화 - 100% 수집)
  tailSampling:
    enabled: false
  # =============================================================================
  # V3: OTEL Connectors (2025-2026 Best Practice)
  # =============================================================================
  # Span Metrics: traces → RED 메트릭 (Request, Error, Duration)
  # Service Graph: traces → 서비스 의존성 메트릭
  connectors:
    spanmetrics:
      enabled: true
    servicegraph:
      enabled: true
    prometheusRemoteWrite:
      # NOTE: Prometheus uses --web.route-prefix=/api/monitoring/prometheus
      endpoint: "http://prometheus:9090/api/monitoring/prometheus/api/v1/write"

# Tempo - 분산 추적 백엔드 (Jaeger 대안)
tempo:
  enabled: true
  image:
    repository: localhost:5001/tempo
    tag: "2.9.0"  # 2025-12 최신 안정 버전
  service:
    httpPort: 3200
    otlpGrpcPort: 4317
    otlpHttpPort: 4318
  persistence:
    enabled: true
    size: 5Gi
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  config:
    retentionPeriod: 168h  # 7 days
    backend: local
    s3:
      enabled: false
  # =============================================================================
  # V3: Metrics Generator (2025 Best Practice)
  # =============================================================================
  # Trace 데이터에서 자동으로 RED 메트릭 생성
  # OTEL Collector connectors와 함께 사용 가능 (중복 아닌 보완)
  metricsGenerator:
    enabled: true
    remoteWriteUrl: "http://prometheus:9090/api/v1/write"
    spanMetrics:
      enabled: true
    serviceGraphs:
      enabled: true
