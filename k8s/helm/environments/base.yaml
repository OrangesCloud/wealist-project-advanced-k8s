# =============================================================================
# Helm Base Configuration - Common defaults for all environments
# =============================================================================
# This file contains shared configuration inherited by all environments.
# Override specific values in environment-specific files (localhost.yaml, etc.)

# -----------------------------------------------------------------------------
# Global Settings (override per environment)
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: develop
  # domain: localhost
  # imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# Default Deployment Settings
# -----------------------------------------------------------------------------
# replicaCount: 1

image:
  pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# Default Resource Limits - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global resource override. Each service uses its own values:
# - Go services: 128Mi-256Mi (fast, low memory)
# - auth-service (Spring Boot): 512Mi-1Gi (JVM needs more memory)
# Overriding globally caused OOMKilled for Spring Boot services.

# -----------------------------------------------------------------------------
# Health Check Settings - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global healthCheck to allow each service to define its own values.
# This is important because:
# - Go services: Fast startup (~5-10s)
# - auth-service (Spring Boot): Slow startup (~40-60s)
# See each service's values.yaml for their healthCheck configuration.

# -----------------------------------------------------------------------------
# Autoscaling (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

# -----------------------------------------------------------------------------
# Argo Rollouts (Progressive Delivery)
# -----------------------------------------------------------------------------
# Enable rollout to use Argo Rollouts instead of Deployment
# When enabled, the service will use canary deployment strategy
rollout:
  enabled: false  # Disabled by default, enable per-service in prod
  revisionHistoryLimit: 3
  maxUnavailable: 0
  maxSurge: "25%"
  canary:
    steps:
      - setWeight: 10
      - pause: { duration: 2m }
      - setWeight: 30
      - pause: { duration: 2m }
      - setWeight: 50
      - pause: { duration: 2m }
  analysis:
    enabled: false  # Enable for automated rollback based on metrics
    startingStep: 1
    count: 5
    successThreshold: 0.95
    latencyThresholdMs: 500
    failureLimit: 3
    prometheusAddress: "http://prometheus:9090"

# -----------------------------------------------------------------------------
# Security Context Defaults (production-ready)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: false
  name: ""
  annotations: {}

# -----------------------------------------------------------------------------
# Network Policy (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: false

# -----------------------------------------------------------------------------
# Pod Disruption Budget (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
podDisruptionBudget:
  enabled: false
  minAvailable: 1

# -----------------------------------------------------------------------------
# Metrics & Monitoring
# -----------------------------------------------------------------------------
metrics:
  enabled: true
  port: 9090
  path: /metrics

# -----------------------------------------------------------------------------
# Pod Annotations
# -----------------------------------------------------------------------------
podAnnotations: {}

# -----------------------------------------------------------------------------
# Node Selector & Tolerations (for prod)
# -----------------------------------------------------------------------------
nodeSelector: {}
tolerations: []
affinity: {}

# -----------------------------------------------------------------------------
# Shared Configuration (used by config templates)
# -----------------------------------------------------------------------------
# These values are available to all services via shared.config (ConfigMap)
# Service-specific config in charts/*/values.yaml will override these
#
# IMPORTANT: Only truly global settings here!
# Environment-specific settings (ENV, LOG_LEVEL, DB_HOST, S3_*, OAuth2_*, etc.)
# should be in environment files (localhost.yaml, dev.yaml, prod.yaml)
shared:
  config:
    # Infrastructure Ports (모든 환경 동일)
    POSTGRES_PORT: "5432"
    DB_PORT: "5432"
    REDIS_PORT: "6379"

    # Service URLs (K8s 내부 통신, 모든 환경 동일)
    AUTH_SERVICE_URL: "http://auth-service:8080"
    USER_SERVICE_URL: "http://user-service:8081"
    BOARD_SERVICE_URL: "http://board-service:8000"
    CHAT_SERVICE_URL: "http://chat-service:8001"
    NOTI_SERVICE_URL: "http://noti-service:8002"
    STORAGE_SERVICE_URL: "http://storage-service:8003"

    # Database Migration (default: disabled for safety)
    DB_AUTO_MIGRATE: "false"

    # -------------------------------------------------------------------------
    # OpenTelemetry Configuration (고정 설정만)
    # -------------------------------------------------------------------------
    # OTLP Exporter - 서비스에서 OTEL Collector로 traces 전송
    # Protocol: HTTP/protobuf (OpenTelemetry 권장 - 모든 언어 호환)
    # - Go, Java, Python 등 모든 SDK에서 동일한 endpoint 사용
    # - Firewall 친화적, 디버깅 용이
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
    # Spring Boot OTLP exporter needs full path (SDK doesn't auto-append /v1/traces)
    OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://otel-collector:4318/v1/traces"
    OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"

    # Trace Sampler type (비율은 환경별 설정)
    OTEL_TRACES_SAMPLER: "parentbased_traceidratio"

    # Propagators - W3C Trace Context 전파
    OTEL_PROPAGATORS: "tracecontext,baggage"

  # ---------------------------------------------------------------------------
  # Shared Secrets - 환경별 파일에서 설정
  # ---------------------------------------------------------------------------
  # localhost.yaml, dev.yaml: secrets 섹션에서 직접 설정
  # prod.yaml: ExternalSecret (AWS Secrets Manager)로 주입
  # secrets: {} # 각 환경 파일에서 override
