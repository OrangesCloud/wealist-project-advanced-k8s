# =============================================================================
# Helm Base Configuration - Common defaults for all environments
# =============================================================================
# This file contains shared configuration inherited by all environments.
# Override specific values in environment-specific files (local-kind.yaml, etc.)

# -----------------------------------------------------------------------------
# Global Settings (override per environment)
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: develop
  domain: localhost
  imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# Default Deployment Settings
# -----------------------------------------------------------------------------
# replicaCount: 1

image:
  pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# Default Resource Limits - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global resource override. Each service uses its own values:
# - Go services: 128Mi-256Mi (fast, low memory)
# - auth-service (Spring Boot): 512Mi-1Gi (JVM needs more memory)
# Overriding globally caused OOMKilled for Spring Boot services.

# -----------------------------------------------------------------------------
# Health Check Settings - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global healthCheck to allow each service to define its own values.
# This is important because:
# - Go services: Fast startup (~5-10s)
# - auth-service (Spring Boot): Slow startup (~40-60s)
# See each service's values.yaml for their healthCheck configuration.

# -----------------------------------------------------------------------------
# Autoscaling (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

# -----------------------------------------------------------------------------
# Security Context Defaults (production-ready)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: false
  name: ""
  annotations: {}

# -----------------------------------------------------------------------------
# Network Policy (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: false

# -----------------------------------------------------------------------------
# Pod Disruption Budget (disabled by default, enable in prod)
# -----------------------------------------------------------------------------
podDisruptionBudget:
  enabled: false
  minAvailable: 1

# -----------------------------------------------------------------------------
# Metrics & Monitoring
# -----------------------------------------------------------------------------
metrics:
  enabled: true
  port: 9090
  path: /metrics

# -----------------------------------------------------------------------------
# Pod Annotations
# -----------------------------------------------------------------------------
podAnnotations: {}

# -----------------------------------------------------------------------------
# Node Selector & Tolerations (for prod)
# -----------------------------------------------------------------------------
nodeSelector: {}
tolerations: []
affinity: {}

# -----------------------------------------------------------------------------
# Shared Configuration (used by config templates)
# -----------------------------------------------------------------------------
# These values are available to all services via shared.config (ConfigMap)
# Service-specific config in charts/*/values.yaml will override these
#
# IMPORTANT: Sensitive data goes to shared.secrets (Secret), not here!
shared:
  config:
    # Environment
    ENV: "production"
    LOG_LEVEL: "info"

    # Infrastructure URLs (K8s internal DNS)
    POSTGRES_HOST: "postgres"
    POSTGRES_PORT: "5432"
    DB_HOST: "postgres"
    DB_PORT: "5432"
    DB_USER: "postgres"
    DB_SSLMODE: "disable"
    REDIS_HOST: "redis"
    REDIS_PORT: "6379"

    # Service URLs
    AUTH_SERVICE_URL: "http://auth-service:8080"
    USER_SERVICE_URL: "http://user-service:8081"
    BOARD_SERVICE_URL: "http://board-service:8000"
    CHAT_SERVICE_URL: "http://chat-service:8001"
    NOTI_SERVICE_URL: "http://noti-service:8002"
    STORAGE_SERVICE_URL: "http://storage-service:8003"
    VIDEO_SERVICE_URL: "http://video-service:8004"

    # S3/MinIO Configuration (non-sensitive)
    S3_ENDPOINT: "http://minio:9000"
    S3_PUBLIC_ENDPOINT: "http://minio:9000"
    S3_BUCKET: "wealist-files"
    S3_REGION: "ap-northeast-2"

    # CORS
    CORS_ORIGINS: "*"

    # OAuth2 Redirect URLs (override per environment)
    OAUTH2_CLIENT_REDIRECT_URI: "http://localhost/login/oauth2/code/google"
    OAUTH2_REDIRECT_URL_ENV: "http://localhost/oauth/callback"

    # LiveKit (WebRTC) - non-sensitive
    LIVEKIT_URL: "http://livekit:7880"
    LIVEKIT_WS_URL: "ws://localhost/svc/livekit"

    # Database Migration (default: disabled for safety)
    DB_AUTO_MIGRATE: "false"

  # ---------------------------------------------------------------------------
  # Shared Secrets (stored in K8s Secret, base64 encoded)
  # ---------------------------------------------------------------------------
  # Override in environment-specific files or use External Secrets Operator
  # For production: use helm/environments/secrets-prod.yaml (gitignored)
  secrets:
    # Database
    DB_PASSWORD: "postgres"
    REDIS_PASSWORD: ""

    # S3/MinIO Credentials
    S3_ACCESS_KEY: "minioadmin"
    S3_SECRET_KEY: "minioadmin"

    # Security
    INTERNAL_API_KEY: "internal-key-change-me"
    JWT_SECRET: "dev-jwt-secret-change-in-production"

    # OAuth2 Credentials (placeholder for local)
    GOOGLE_CLIENT_ID: "placeholder-client-id.apps.googleusercontent.com"
    GOOGLE_CLIENT_SECRET: "placeholder-client-secret"

    # LiveKit Credentials
    LIVEKIT_API_KEY: "devkey"
    LIVEKIT_API_SECRET: "devsecret"

# -----------------------------------------------------------------------------
# Istio Service Mesh Configuration
# -----------------------------------------------------------------------------
istio:
  # Enable/disable Istio configuration deployment
  enabled: false  # Enable per environment

  # Target namespace (override per environment)
  namespace: wealist-dev

  # Gateway configuration
  gateway:
    enabled: true
    name: wealist-gateway
    selector:
      istio: ingressgateway
    hosts:
      - "*"
    tls:
      enabled: false
      credentialName: wealist-tls
      mode: SIMPLE

  # mTLS configuration
  mtls:
    enabled: true
    mode: PERMISSIVE  # STRICT or PERMISSIVE (start with PERMISSIVE)

  # VirtualService routing
  virtualService:
    enabled: true
    hosts:
      - "*"
    routes:
      auth:
        prefix: /svc/auth
        host: auth-service
        port: 8080
        timeout: 30s
      user:
        prefix: /svc/user
        host: user-service
        port: 8081
        timeout: 30s
      board:
        prefix: /svc/board
        host: board-service
        port: 8000
        timeout: 3600s
      chat:
        prefix: /svc/chat
        host: chat-service
        port: 8001
        timeout: 3600s
      noti:
        prefix: /svc/noti
        host: noti-service
        port: 8002
        timeout: 3600s
      storage:
        prefix: /svc/storage
        host: storage-service
        port: 8003
        timeout: 300s
      video:
        prefix: /svc/video
        host: video-service
        port: 8004
        timeout: 3600s

  # DestinationRules
  destinationRules:
    enabled: true
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

  # Retry policy
  retryPolicy:
    attempts: 3
    perTryTimeout: 2s
    retryOn: gateway-error,connect-failure,refused-stream

  # Authorization Policy
  authorizationPolicy:
    enabled: true
    denyAll: false

  # JWT Authentication (disabled by default)
  jwtAuth:
    enabled: false
    issuer: wealist-auth-service
    jwksUri: ""

  # Telemetry
  telemetry:
    tracing:
      enabled: true
      samplingPercentage: 100
      provider: jaeger
    accessLogging:
      enabled: true
      provider: envoy

  # Service list for DestinationRules
  services:
    - name: auth-service
      port: 8080
    - name: user-service
      port: 8081
    - name: board-service
      port: 8000
    - name: chat-service
      port: 8001
    - name: noti-service
      port: 8002
    - name: storage-service
      port: 8003
    - name: video-service
      port: 8004
    - name: frontend
      port: 80
