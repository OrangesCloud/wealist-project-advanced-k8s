{{- if and .Values.istio.enabled .Values.istio.httpRoute.enabled }}
{{- if and .Values.istio.httpRoute.argocd .Values.istio.httpRoute.argocd.enabled }}
{{- if .Values.istio.httpRoute.argocd.host }}
# =============================================================================
# ReferenceGrant - ArgoCD 크로스 네임스페이스 라우팅 허용
# =============================================================================
# wealist-prod 네임스페이스의 HTTPRoute가 argocd 네임스페이스의
# argocd-server Service를 참조할 수 있도록 허용
#
# Gateway API 보안 모델:
#   - HTTPRoute는 다른 네임스페이스의 Service를 직접 참조할 수 없음
#   - ReferenceGrant가 대상 네임스페이스에서 명시적으로 허용해야 함
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-httproute-to-argocd
  namespace: argocd  # 대상 네임스페이스 (argocd-server가 있는 곳)
  labels:
    {{- include "istio-config.labels" . | nindent 4 }}
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: {{ .Values.global.namespace }}  # wealist-prod
  to:
    - group: ""
      kind: Service
      name: argocd-server
{{- end }}
{{- end }}
{{- end }}
