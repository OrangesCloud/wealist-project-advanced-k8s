{{- if and .Values.istio.enabled .Values.istio.k8sGateway.enabled }}
# =============================================================================
# Kubernetes Gateway API - Ingress Gateway
# Istio automatically provisions Deployment and Service for this Gateway
# The infrastructure.annotations are applied to the auto-generated Service
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ .Values.istio.k8sGateway.name }}
  namespace: {{ .Values.istio.k8sGateway.namespace | default "istio-system" }}
  labels:
    {{- include "istio-config.labels" . | nindent 4 }}
  {{- with .Values.istio.k8sGateway.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.istio.k8sGateway.gatewayClassName | default "istio" }}
  {{- if .Values.istio.k8sGateway.infrastructure }}
  infrastructure:
    {{- if .Values.istio.k8sGateway.infrastructure.annotations }}
    annotations:
      {{- toYaml .Values.istio.k8sGateway.infrastructure.annotations | nindent 6 }}
    {{- end }}
    {{- if .Values.istio.k8sGateway.infrastructure.labels }}
    labels:
      {{- toYaml .Values.istio.k8sGateway.infrastructure.labels | nindent 6 }}
    {{- end }}
  {{- end }}
  listeners:
    - name: http
      port: {{ .Values.istio.k8sGateway.listeners.http.port | default 80 }}
      protocol: HTTP
      {{- if .Values.istio.k8sGateway.listeners.http.hostname }}
      hostname: {{ .Values.istio.k8sGateway.listeners.http.hostname | quote }}
      {{- end }}
      allowedRoutes:
        namespaces:
          from: {{ .Values.istio.k8sGateway.listeners.http.allowedRoutes.from | default "All" }}
          {{- if eq .Values.istio.k8sGateway.listeners.http.allowedRoutes.from "Selector" }}
          selector:
            matchLabels:
              {{- toYaml .Values.istio.k8sGateway.listeners.http.allowedRoutes.selector | nindent 14 }}
          {{- end }}
    {{- if .Values.istio.k8sGateway.listeners.https.enabled }}
    - name: https
      port: {{ .Values.istio.k8sGateway.listeners.https.port | default 443 }}
      {{- if .Values.istio.k8sGateway.listeners.https.nlbTermination }}
      # NLB TLS termination: NLB handles TLS, Gateway receives HTTP
      protocol: HTTP
      {{- else }}
      # Gateway TLS termination: Gateway handles TLS with certificate
      protocol: HTTPS
      {{- if .Values.istio.k8sGateway.listeners.https.hostname }}
      hostname: {{ .Values.istio.k8sGateway.listeners.https.hostname | quote }}
      {{- end }}
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: {{ .Values.istio.k8sGateway.listeners.https.certificateRef }}
      {{- end }}
      allowedRoutes:
        namespaces:
          from: {{ .Values.istio.k8sGateway.listeners.https.allowedRoutes.from | default "All" }}
    {{- end }}
{{- end }}
