# =============================================================================
# frontend - Service Configuration
# =============================================================================
# React 18 + Vite application served by NGINX
#
# Global settings (namespace, environment, imageRegistry, domain) are defined
# in helm/environments/*.yaml files.

# -----------------------------------------------------------------------------
# Image Configuration
# -----------------------------------------------------------------------------
image:
  repository: frontend
  # pullPolicy and tag are set in helm/environments/*.yaml

imagePullSecrets: []

# -----------------------------------------------------------------------------
# Deployment Configuration
# -----------------------------------------------------------------------------
replicaCount: 1

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# -----------------------------------------------------------------------------
# Service Configuration
# -----------------------------------------------------------------------------
service:
  type: ClusterIP
  port: 3000
  targetPort: 80  # NGINX internal port
  annotations: {}

# -----------------------------------------------------------------------------
# Application Configuration (Service-Specific Only)
# -----------------------------------------------------------------------------
# Note: Common config (ENV, LOG_LEVEL, CORS_ORIGINS, etc.) comes from
# helm/environments/*.yaml via shared.config section.
# Only service-specific values should be defined here.
config:
  # Build-time environment variables (injected during Docker build)
  VITE_API_URL: "/api"
  VITE_WS_URL: "/ws"

  # Runtime configuration (config.js)
  runtimeConfig:
    # Empty string = relative paths, requests go through ingress (same origin)
    API_BASE_URL: ""

# -----------------------------------------------------------------------------
# Health Check Configuration (NGINX)
# -----------------------------------------------------------------------------
healthCheck:
  liveness:
    path: /
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3
  readiness:
    path: /
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 2
    successThreshold: 1
    failureThreshold: 3

# -----------------------------------------------------------------------------
# Resource Management
# -----------------------------------------------------------------------------
resources:
  requests:
    memory: "64Mi"
    cpu: "50m"
  limits:
    memory: "128Mi"
    cpu: "200m"

# -----------------------------------------------------------------------------
# Autoscaling
# -----------------------------------------------------------------------------
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
      selectPolicy: Min
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
      selectPolicy: Max

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
# NGINX needs root to set up cache directory permissions on startup
# Override environment defaults for nginx compatibility
podSecurityContext:
  runAsNonRoot: false

securityContext:
  runAsNonRoot: false
  runAsUser: 0  # Run as root for nginx
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false
  capabilities:
    drop: []  # Don't drop capabilities - nginx needs CAP_CHOWN for cache dirs
    add:
      - CHOWN

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automount: false  # Frontend doesn't need K8s API access

# -----------------------------------------------------------------------------
# Pod Disruption Budget
# -----------------------------------------------------------------------------
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# -----------------------------------------------------------------------------
# Network Policy
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: wealist
      ports:
        - protocol: TCP
          port: 80

# -----------------------------------------------------------------------------
# Monitoring
# -----------------------------------------------------------------------------
metrics:
  enabled: false  # Frontend doesn't expose metrics by default

podAnnotations: {}

nodeSelector: {}
tolerations: []
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - frontend
          topologyKey: kubernetes.io/hostname

# -----------------------------------------------------------------------------
# NGINX Specific
# -----------------------------------------------------------------------------
nginx:
  # Additional NGINX configuration can be added via ConfigMap
  cacheControl: "public, max-age=31536000, immutable"

extraEnv: []

# -----------------------------------------------------------------------------
# Volume Configuration (for runtime config injection)
# -----------------------------------------------------------------------------
# Mount the runtime-config ConfigMap as config.js
# This overrides the default config.js baked into the Docker image
volumes:
  - name: runtime-config
    configMap:
      name: frontend-runtime-config

volumeMounts:
  - name: runtime-config
    mountPath: /usr/share/nginx/html/config.js
    subPath: config.js
