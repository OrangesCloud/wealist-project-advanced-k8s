{{- if .Values.promtail.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: {{ .Values.global.namespace }}
  labels:
    app: promtail
    app.kubernetes.io/name: promtail
    app.kubernetes.io/component: logging
data:
  promtail-config.yaml: |
    # =============================================================================
    # Promtail Configuration for weAlist (Kubernetes)
    # =============================================================================
    # Kubernetes Pod 로그를 수집하여 Loki로 전송

    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: {{ .Values.promtail.config.lokiUrl }}

    scrape_configs:
      # Kubernetes Pod 로그 수집
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Values.global.namespace }}

        relabel_configs:
          # Pod 이름을 라벨로 추가
          - source_labels: ['__meta_kubernetes_pod_name']
            target_label: 'pod'

          # 네임스페이스 라벨 추가
          - source_labels: ['__meta_kubernetes_namespace']
            target_label: 'namespace'

          # 컨테이너 이름 라벨 추가
          - source_labels: ['__meta_kubernetes_pod_container_name']
            target_label: 'container'

          # App 라벨 추가 (서비스 구분용)
          - source_labels: ['__meta_kubernetes_pod_label_app']
            target_label: 'app'

          # 서비스명 추출
          - source_labels: ['__meta_kubernetes_pod_label_app_kubernetes_io_name']
            target_label: 'service'

          # 로그 파일 경로 설정
          - source_labels: ['__meta_kubernetes_pod_uid', '__meta_kubernetes_pod_container_name']
            target_label: '__path__'
            separator: /
            replacement: /var/log/pods/*$1/$2/*.log

        pipeline_stages:
          # JSON 로그 파싱 (Go 서비스들은 zap JSON 로그 출력)
          # zap 로거 필드: timestamp, level, message, caller, stacktrace, request_id 등
          # OpenTelemetry 필드: trace_id, span_id (2025 OTEL 통합)
          - json:
              expressions:
                level: level
                message: message
                timestamp: timestamp
                error: error
                caller: caller
                request_id: request_id
                service: service
                method: method
                path: path
                status: status
                duration: duration
                # OpenTelemetry Trace Context (Phase 3.3)
                trace_id: trace_id
                span_id: span_id
                # OTEL Semantic Convention 필드
                http_method: '"http.method"'
                http_status_code: '"http.status_code"'
                enduser_id: '"enduser.id"'

          # 로그 레벨 라벨 추가
          # trace_id를 라벨로 추가하여 Grafana에서 Tempo 연동 가능
          # 주의: span_id는 high-cardinality이므로 라벨로 추가하지 않음
          - labels:
              level:
              trace_id:

          # 타임스탬프 파싱 (zap ISO8601 형식)
          - timestamp:
              source: timestamp
              format: "2006-01-02T15:04:05.000Z0700"
              fallback_formats:
                - RFC3339Nano
                - RFC3339
                - "2006-01-02T15:04:05.999999999Z07:00"
                - "2006-01-02T15:04:05Z07:00"

          # 출력 포맷 설정
          - output:
              source: message
{{- end }}
