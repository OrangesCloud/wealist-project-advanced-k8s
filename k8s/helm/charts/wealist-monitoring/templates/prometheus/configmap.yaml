{{- if .Values.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: {{ .Values.global.namespace }}
  labels:
    app: prometheus
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
data:
  prometheus.yml: |
    # =============================================================================
    # Prometheus Configuration for weAlist (Kubernetes)
    # =============================================================================

    global:
      scrape_interval: {{ .Values.prometheus.config.scrapeInterval }}
      evaluation_interval: {{ .Values.prometheus.config.evaluationInterval }}
      external_labels:
        monitor: 'wealist-k8s-monitor'

    {{- if .Values.prometheus.alerting.enabled }}
    # Alert Rules 경로
    rule_files:
      - /etc/prometheus/rules/*.yml

    # Alertmanager 설정 (선택 사항)
    {{- if .Values.prometheus.alerting.alertmanager.enabled }}
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - {{ .Values.prometheus.alerting.alertmanager.host }}:{{ .Values.prometheus.alerting.alertmanager.port }}
    {{- end }}
    {{- end }}

    scrape_configs:
      # Prometheus 자체 메트릭
      # routePrefix 설정으로 인해 /api/monitoring/prometheus/metrics 경로 사용
      - job_name: 'prometheus'
        metrics_path: '{{ .Values.prometheus.config.routePrefix }}/metrics'
        static_configs:
          - targets: ['localhost:9090']

      # ==========================================================================
      # Go Services
      # ==========================================================================
      {{- if .Values.prometheus.scrapeTargets.userService.enabled }}
      - job_name: 'user-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.userService.host }}:{{ .Values.prometheus.scrapeTargets.userService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.userService.path }}'
      {{- end }}

      {{- if .Values.prometheus.scrapeTargets.boardService.enabled }}
      - job_name: 'board-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.boardService.host }}:{{ .Values.prometheus.scrapeTargets.boardService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.boardService.path }}'
      {{- end }}

      {{- if .Values.prometheus.scrapeTargets.chatService.enabled }}
      - job_name: 'chat-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.chatService.host }}:{{ .Values.prometheus.scrapeTargets.chatService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.chatService.path }}'
      {{- end }}

      {{- if .Values.prometheus.scrapeTargets.notiService.enabled }}
      - job_name: 'noti-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.notiService.host }}:{{ .Values.prometheus.scrapeTargets.notiService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.notiService.path }}'
      {{- end }}

      {{- if .Values.prometheus.scrapeTargets.storageService.enabled }}
      - job_name: 'storage-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.storageService.host }}:{{ .Values.prometheus.scrapeTargets.storageService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.storageService.path }}'
      {{- end }}

      # ==========================================================================
      # Spring Boot Service (auth-service)
      # ==========================================================================
      {{- if .Values.prometheus.scrapeTargets.authService.enabled }}
      - job_name: 'auth-service'
        static_configs:
          - targets: ['{{ .Values.prometheus.scrapeTargets.authService.host }}:{{ .Values.prometheus.scrapeTargets.authService.port }}']
        metrics_path: '{{ .Values.prometheus.scrapeTargets.authService.path }}'
      {{- end }}

      # ==========================================================================
      # Database Exporters
      # ==========================================================================
      {{- if .Values.postgresExporter.enabled }}
      - job_name: 'postgres-exporter'
        static_configs:
          - targets: ['postgres-exporter:{{ .Values.postgresExporter.service.port }}']
        metrics_path: '/metrics'
      {{- end }}

      {{- if .Values.redisExporter.enabled }}
      - job_name: 'redis-exporter'
        static_configs:
          - targets: ['redis-exporter:{{ .Values.redisExporter.service.port }}']
        metrics_path: '/metrics'
      {{- end }}

      # ==========================================================================
      # Pushgateway (GitHub Actions CI/CD Metrics)
      # ==========================================================================
      {{- if .Values.pushgateway.enabled }}
      - job_name: 'pushgateway'
        honor_labels: true  # Push된 메트릭의 라벨 유지
        static_configs:
          - targets: ['pushgateway:{{ .Values.pushgateway.service.port }}']
        metrics_path: '/metrics'
      {{- end }}

      # ==========================================================================
      # kube-state-metrics (Kubernetes Objects State)
      # ==========================================================================
      {{- if .Values.kubeStateMetrics.enabled }}
      - job_name: 'kube-state-metrics'
        static_configs:
          - targets: ['kube-state-metrics:{{ .Values.kubeStateMetrics.service.port }}']
        metrics_path: '/metrics'
      {{- end }}

      # ==========================================================================
      # node-exporter (Node System Metrics)
      # ==========================================================================
      {{- if .Values.nodeExporter.enabled }}
      - job_name: 'node-exporter'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: node-exporter
          - source_labels: [__meta_kubernetes_pod_node_name]
            action: replace
            target_label: node
          - source_labels: [__meta_kubernetes_pod_host_ip]
            action: replace
            regex: (.+)
            replacement: $1:{{ .Values.nodeExporter.service.port }}
            target_label: __address__
      {{- end }}

      # ==========================================================================
      # kubelet cAdvisor (Container Metrics)
      # ==========================================================================
      - job_name: 'kubelet-cadvisor'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor

      # ==========================================================================
      # Kubernetes Service Discovery (Pod Annotations)
      # ==========================================================================
      # Note: Excludes services with dedicated static scrape jobs above
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Values.global.namespace }}
        relabel_configs:
          # prometheus.io/scrape 어노테이션이 있는 Pod만 스크래핑
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          # Exclude services that have dedicated static scrape jobs
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: drop
            regex: (auth-service|user-service|board-service|chat-service|noti-service|storage-service)
          # prometheus.io/path 어노테이션으로 메트릭 경로 설정
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          # prometheus.io/port 어노테이션으로 포트 설정
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          # Pod 라벨 추가
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ==========================================================================
      # Istio 메트릭 수집
      # ==========================================================================

      # istiod 컨트롤 플레인 메트릭 (모든 모드에서 사용)
      - job_name: 'istiod'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - istio-system
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: istiod
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: "15014"
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ==========================================================================
      # Istio Sidecar 메트릭
      # ==========================================================================

      # Envoy Sidecar 메트릭 (istio-proxy 컨테이너)
      - job_name: 'envoy-stats'
        metrics_path: /stats/prometheus
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Values.global.namespace }}
        relabel_configs:
          # istio-proxy 컨테이너가 있는 Pod만 스크래핑
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: keep
            regex: istio-proxy
          # Envoy 메트릭 포트 (15090)로 변경
          - source_labels: [__address__]
            action: replace
            regex: ([^:]+)(?::\d+)?
            replacement: $1:15090
            target_label: __address__
          # Pod 메타데이터 라벨 추가
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: replace
            target_label: app

      # ==========================================================================
      # Argo Rollouts 메트릭 수집
      # ==========================================================================
      - job_name: 'argo-rollouts'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argo-rollouts
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argo-rollouts
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ==========================================================================
      # ArgoCD 메트릭 수집 (Pod 직접 스크래핑)
      # ==========================================================================
      # ArgoCD Helm에서 metrics 서비스가 비활성화된 경우 Pod를 직접 스크래핑
      {{- if .Values.argocd.metrics.enabled }}
      # ArgoCD Application Controller (port: 8082)
      - job_name: 'argocd-application-controller'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argocd
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argocd-application-controller
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ArgoCD Server (port: 8083)
      - job_name: 'argocd-server'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argocd
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argocd-server
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ArgoCD Repo Server (port: 8084)
      - job_name: 'argocd-repo-server'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argocd
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argocd-repo-server
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ArgoCD ApplicationSet Controller (port: 8080)
      - job_name: 'argocd-applicationset-controller'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argocd
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argocd-applicationset-controller
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod

      # ArgoCD Notifications Controller (port: 9001)
      - job_name: 'argocd-notifications-controller'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - argocd
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: argocd-notifications-controller
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod
      {{- end }}
{{- end }}
