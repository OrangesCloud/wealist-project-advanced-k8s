{{- if .Values.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: {{ .Values.global.namespace }}
  labels:
    app: grafana
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
data:
  datasources.yaml: |
    # =============================================================================
    # Grafana Datasources Configuration
    # =============================================================================
    apiVersion: 1

    datasources:
      # Prometheus - ë©”íŠ¸ë¦­ ë°ì´í„°
      # routePrefix ì„¤ì •ìœ¼ë¡œ ì¸í•´ /api/monitoring/prometheus ê²½ë¡œ í•„ìš”
      - name: Prometheus
        type: prometheus
        uid: prometheus
        access: proxy
        url: http://prometheus:9090{{ .Values.prometheus.config.routePrefix }}
        isDefault: true
        editable: false
        jsonData:
          httpMethod: POST
          manageAlerts: true
          prometheusType: Prometheus
          {{- if .Values.prometheus.exemplarStorage.enabled }}
          # =============================================================================
          # Exemplars (2025 Best Practice)
          # =============================================================================
          # Prometheus ë©”íŠ¸ë¦­ì—ì„œ Tempo íŠ¸ë ˆì´ìŠ¤ë¡œ ì§ì ‘ ì—°ê²°
          exemplarTraceIdDestinations:
            - name: traceID
              datasourceUid: tempo
          {{- end }}

      # Loki - ë¡œê·¸ ë°ì´í„° (Tempo ì—°ë™ í¬í•¨)
      - name: Loki
        type: loki
        uid: loki
        access: proxy
        url: http://loki:3100
        editable: false
        jsonData:
          maxLines: 1000
          {{- if .Values.tempo.enabled }}
          # Traces-Logs Correlation: trace_idë¡œ Tempo íŠ¸ë ˆì´ìŠ¤ ì—°ê²°
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: '"trace_id":"([a-f0-9]+)"'
              name: TraceID
              url: '$${__value.raw}'
              urlDisplayLabel: 'View Trace'
            - datasourceUid: tempo
              matcherRegex: 'trace_id=([a-f0-9]+)'
              name: TraceID
              url: '$${__value.raw}'
              urlDisplayLabel: 'View Trace'
          {{- end }}

      {{- if .Values.tempo.enabled }}
      # Tempo - ë¶„ì‚° ì¶”ì  (2025 OTEL í†µí•©)
      - name: Tempo
        type: tempo
        uid: tempo
        access: proxy
        url: http://tempo:{{ .Values.tempo.service.httpPort }}
        editable: false
        jsonData:
          httpMethod: GET
          # Traces to Logs: íŠ¸ë ˆì´ìŠ¤ì—ì„œ ê´€ë ¨ ë¡œê·¸ë¡œ ì´ë™
          tracesToLogsV2:
            datasourceUid: 'loki'
            filterByTraceID: true
            filterBySpanID: false
            spanStartTimeShift: '-1m'
            spanEndTimeShift: '1m'
            tags:
              - key: 'service.name'
                value: 'app'
            customQuery: true
            query: '{trace_id="${__span.traceId}"} | json'
          # Traces to Metrics: íŠ¸ë ˆì´ìŠ¤ì—ì„œ ë©”íŠ¸ë¦­ìœ¼ë¡œ ì—°ê²°
          tracesToMetrics:
            datasourceUid: 'prometheus'
            spanStartTimeShift: '-5m'
            spanEndTimeShift: '5m'
            tags:
              - key: 'service.name'
                value: 'app'
            queries:
              - name: 'Request Rate'
                query: 'sum(rate(http_server_request_duration_seconds_count{app="${__span.tags["service.name"]}"}[5m]))'
              - name: 'Error Rate'
                query: 'sum(rate(http_server_request_duration_seconds_count{app="${__span.tags["service.name"]}", http_status_code=~"5.."}[5m]))'
          # Service Graph: ì„œë¹„ìŠ¤ ê°„ ê´€ê³„ ì‹œê°í™”
          serviceMap:
            datasourceUid: 'prometheus'
          # Node Graph: íŠ¸ë ˆì´ìŠ¤ ìŠ¤íŒ¬ ê·¸ë˜í”„
          nodeGraph:
            enabled: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: 'loki'
      {{- end }}

      {{- if .Values.grafana.additionalDatasources.elasticsearch.enabled }}
      # Elasticsearch - ELK ìŠ¤íƒ ë¡œê·¸/ê²€ìƒ‰ ë°ì´í„°
      - name: Elasticsearch
        type: elasticsearch
        uid: elasticsearch
        access: proxy
        url: {{ .Values.grafana.additionalDatasources.elasticsearch.url }}
        editable: false
        jsonData:
          index: {{ .Values.grafana.additionalDatasources.elasticsearch.index | default "logstash-*" }}
          timeField: "@timestamp"
          esVersion: "8.0.0"
          logMessageField: message
          logLevelField: level
      {{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: {{ .Values.global.namespace }}
  labels:
    app: grafana
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
data:
  dashboards.yaml: |
    # =============================================================================
    # Grafana Dashboard Provisioning Configuration (V4 - Role-based Folders)
    # =============================================================================
    # 2026 Best Practice: ì—­í• ë³„ í´ë”ë¡œ êµ¬ë¶„í•˜ì—¬ íƒìƒ‰ ìš©ì´ì„± í–¥ìƒ
    # =============================================================================
    apiVersion: 1

    providers:
      # 00. Landing - ì „ì²´ ì‹œìŠ¤í…œ ì§„ì…ì 
      - name: 'landing'
        orgId: 1
        folder: 'ğŸ  Landing'
        folderUid: 'landing'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/00-landing

      # 01. CI/CD - CI/CD ë‹´ë‹¹ììš©
      - name: 'cicd'
        orgId: 1
        folder: 'ğŸš€ CI/CD'
        folderUid: 'cicd'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/01-cicd

      # 02. LoadTest - QA/ì„±ëŠ¥ í…ŒìŠ¤í„°ìš©
      - name: 'loadtest'
        orgId: 1
        folder: 'âš¡ Load Test'
        folderUid: 'loadtest'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/02-loadtest

      # 03. Developer - ê°œë°œììš©
      - name: 'developer'
        orgId: 1
        folder: 'ğŸ’» Developer'
        folderUid: 'developer'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/03-developer

      # 04. PM - PM/ê¸°íšììš©
      - name: 'pm'
        orgId: 1
        folder: 'ğŸ“Š PM'
        folderUid: 'pm'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/04-pm

      # 05. Operations - DevOps/SREìš©
      - name: 'operations'
        orgId: 1
        folder: 'ğŸ”§ Operations'
        folderUid: 'operations'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/05-operations

      # 06. Advanced - ê³ ê¸‰ ì‚¬ìš©ììš© (OTEL ìƒì„¸)
      - name: 'advanced'
        orgId: 1
        folder: 'ğŸ”¬ Advanced'
        folderUid: 'advanced'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards/v4/06-advanced
{{- end }}
