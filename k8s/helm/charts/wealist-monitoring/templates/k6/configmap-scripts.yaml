{{- if .Values.k6.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: {{ .Values.global.namespace }}
  labels:
    app: k6
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: performance-testing
data:
  load-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    const errorRate = new Rate('errors');

    export const options = {
      scenarios: {
        load_test: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '{{ .Values.k6.scenarios.load.duration | default "1m" }}', target: {{ .Values.k6.scenarios.load.vus | default 20 }} },
            { duration: '3m', target: {{ .Values.k6.scenarios.load.vus | default 20 }} },
            { duration: '1m', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<{{ .Values.k6.thresholds.latencyP95Ms | default 500 }}'],
        http_req_failed: ['rate<{{ div .Values.k6.thresholds.errorRatePercent 100 | default 0.01 }}'],
      },
    };

    const BASE_URL = '{{ .Values.k6.endpoints.baseUrl }}';
    const HOST_HEADER = '{{ .Values.k6.endpoints.hostHeader | default "api.wealist.co.kr" }}';
    const params = { headers: { 'Host': HOST_HEADER } };

    export default function () {
      {{- range .Values.k6.endpoints.services }}
      const {{ .name }}Res = http.get(`${BASE_URL}{{ .path }}{{ .healthPath }}`, params);
      check({{ .name }}Res, { '{{ .name }} health ok': (r) => r.status === 200 });
      errorRate.add({{ .name }}Res.status !== 200);
      {{- end }}
      sleep(1);
    }

  stress-test.js: |
    import http from 'k6/http';
    import { check, sleep, group } from 'k6';
    import { Rate, Counter, Trend } from 'k6/metrics';

    // Custom metrics
    const errorRate = new Rate('errors');
    const authErrors = new Counter('auth_errors');
    const apiLatency = new Trend('api_latency', true);

    export const options = {
      scenarios: {
        stress_test: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '1m', target: 50 },
            { duration: '1m', target: 50 },
            { duration: '1m', target: 100 },
            { duration: '1m', target: 100 },
            { duration: '1m', target: 200 },
            { duration: '1m', target: 200 },
            { duration: '1m', target: {{ .Values.k6.scenarios.stress.maxVUs | default 300 }} },
            { duration: '2m', target: {{ .Values.k6.scenarios.stress.maxVUs | default 300 }} },
            { duration: '1m', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<2000'],
        http_req_failed: ['rate<0.1'],
        errors: ['rate<0.15'],
      },
    };

    const BASE_URL = '{{ .Values.k6.endpoints.baseUrl }}';
    const HOST_HEADER = '{{ .Values.k6.endpoints.hostHeader | default "api.wealist.co.kr" }}';

    // Setup: 테스트 토큰 발급
    export function setup() {
      console.log('=== Stress Test Setup: Getting test token ===');

      const tokenRes = http.post(
        `${BASE_URL}/api/svc/auth/api/test/token`,
        JSON.stringify({ userId: '00000000-0000-0000-0000-000000000001' }),
        {
          headers: {
            'Host': HOST_HEADER,
            'Content-Type': 'application/json',
          },
        }
      );

      if (tokenRes.status !== 200) {
        console.error(`Failed to get test token: ${tokenRes.status} - ${tokenRes.body}`);
        console.error('Make sure ENABLE_TEST_AUTH=true is set in auth-service');
        return { token: null };
      }

      const data = tokenRes.json();
      console.log(`Test token acquired for user: ${data.userId}`);
      return { token: data.accessToken };
    }

    export default function (data) {
      const token = data.token;

      // 토큰 없으면 health check만
      if (!token) {
        const healthRes = http.get(`${BASE_URL}/api/svc/board/health/live`, {
          headers: { 'Host': HOST_HEADER },
        });
        errorRate.add(healthRes.status !== 200);
        sleep(0.3);
        return;
      }

      const authHeaders = {
        'Host': HOST_HEADER,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      };

      // 1. Board Service - 실제 API 호출
      group('board-service', function () {
        const boardsRes = http.get(`${BASE_URL}/api/svc/board/api/boards`, {
          headers: authHeaders,
          tags: { name: 'get-boards' },
        });
        apiLatency.add(boardsRes.timings.duration);

        const success = boardsRes.status === 200 || boardsRes.status === 401;
        check(boardsRes, { 'boards API ok': (r) => r.status === 200 });
        errorRate.add(!success);
        if (boardsRes.status === 401) authErrors.add(1);
      });

      // 2. User Service - 현재 사용자 정보
      group('user-service', function () {
        const userRes = http.get(`${BASE_URL}/api/svc/user/api/users/me`, {
          headers: authHeaders,
          tags: { name: 'get-user-me' },
        });
        apiLatency.add(userRes.timings.duration);

        const success = userRes.status === 200 || userRes.status === 401 || userRes.status === 404;
        check(userRes, { 'user API ok': (r) => r.status === 200 || r.status === 404 });
        errorRate.add(userRes.status >= 500);
        if (userRes.status === 401) authErrors.add(1);
      });

      // 3. Chat Service - 채팅 목록
      group('chat-service', function () {
        const chatRes = http.get(`${BASE_URL}/api/svc/chat/api/chats`, {
          headers: authHeaders,
          tags: { name: 'get-chats' },
        });
        apiLatency.add(chatRes.timings.duration);

        const success = chatRes.status === 200 || chatRes.status === 401;
        check(chatRes, { 'chat API ok': (r) => r.status === 200 });
        errorRate.add(chatRes.status >= 500);
        if (chatRes.status === 401) authErrors.add(1);
      });

      // 4. Noti Service - 알림 목록
      group('noti-service', function () {
        const notiRes = http.get(`${BASE_URL}/api/svc/noti/api/notifications`, {
          headers: authHeaders,
          tags: { name: 'get-notifications' },
        });
        apiLatency.add(notiRes.timings.duration);

        const success = notiRes.status === 200 || notiRes.status === 401;
        check(notiRes, { 'noti API ok': (r) => r.status === 200 });
        errorRate.add(notiRes.status >= 500);
        if (notiRes.status === 401) authErrors.add(1);
      });

      // 5. Storage Service - Health (인증 불필요)
      group('storage-service', function () {
        const storageRes = http.get(`${BASE_URL}/api/svc/storage/health/live`, {
          headers: { 'Host': HOST_HEADER },
          tags: { name: 'storage-health' },
        });
        check(storageRes, { 'storage health ok': (r) => r.status === 200 });
        errorRate.add(storageRes.status !== 200);
      });

      sleep(0.3);
    }

    export function teardown(data) {
      console.log('=== Stress Test Completed ===');
      if (!data.token) {
        console.warn('Test ran without authentication - only health checks were performed');
      }
    }

  spike-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    const errorRate = new Rate('errors');

    export const options = {
      scenarios: {
        spike_test: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 20 },
            { duration: '1m', target: 20 },
            { duration: '10s', target: {{ .Values.k6.scenarios.spike.peakVUs | default 500 }} },
            { duration: '1m', target: {{ .Values.k6.scenarios.spike.peakVUs | default 500 }} },
            { duration: '10s', target: 20 },
            { duration: '2m', target: 20 },
            { duration: '30s', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<3000'],
        http_req_failed: ['rate<0.2'],
      },
    };

    const BASE_URL = '{{ .Values.k6.endpoints.baseUrl }}';
    const HOST_HEADER = '{{ .Values.k6.endpoints.hostHeader | default "api.wealist.co.kr" }}';
    const params = { headers: { 'Host': HOST_HEADER } };

    export default function () {
      const res = http.get(`${BASE_URL}{{ (index .Values.k6.endpoints.services 0).path }}{{ (index .Values.k6.endpoints.services 0).healthPath }}`, params);
      errorRate.add(res.status !== 200);
      check(res, { 'status is 200': (r) => r.status === 200 });
      sleep(0.1);
    }

  user-service-test.js: |
    /**
     * k6 User Service Test - weAlist
     * user-service 전용 트래픽 생성 (카나리 배포 관측용)
     */
    import http from 'k6/http';
    import { check, sleep, group } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';

    const errorRate = new Rate('errors');
    const userLatency = new Trend('user_latency', true);
    const healthLatency = new Trend('health_latency', true);
    const requestCount = new Counter('request_count');

    export const options = {
      scenarios: {
        user_service_test: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 10 },
            { duration: '2m', target: 10 },
            { duration: '30s', target: 0 },
          ],
          gracefulRampDown: '10s',
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<500', 'p(99)<1000'],
        http_req_failed: ['rate<0.05'],
        errors: ['rate<0.05'],
        user_latency: ['p(95)<400'],
      },
    };

    const BASE_URL = '{{ .Values.k6.endpoints.baseUrl }}';
    const HOST_HEADER = '{{ .Values.k6.endpoints.hostHeader | default "api.wealist.co.kr" }}';
    const params = { headers: { 'Host': HOST_HEADER, 'Content-Type': 'application/json' } };

    function handleResponse(res, metricTrend, name) {
      const success = res.status >= 200 && res.status < 400;
      errorRate.add(!success);
      requestCount.add(1);
      if (metricTrend) metricTrend.add(res.timings.duration);
      check(res, {
        [`${name} status ok`]: (r) => r.status >= 200 && r.status < 400,
        [`${name} < 500ms`]: (r) => r.timings.duration < 500,
      });
      return success;
    }

    export default function () {
      group('User Service Health', function () {
        const liveRes = http.get(`${BASE_URL}/api/svc/user/health/live`, params);
        handleResponse(liveRes, healthLatency, 'user health live');
        const readyRes = http.get(`${BASE_URL}/api/svc/user/health/ready`, params);
        handleResponse(readyRes, healthLatency, 'user health ready');
      });
      sleep(0.3);

      group('User Profile', function () {
        const profileRes = http.get(`${BASE_URL}/api/svc/user/api/users/me`, params);
        const success = profileRes.status === 200 || profileRes.status === 401;
        errorRate.add(!success);
        userLatency.add(profileRes.timings.duration);
      });
      sleep(0.3);

      group('User Workspaces', function () {
        const workspacesRes = http.get(`${BASE_URL}/api/svc/user/api/workspaces`, params);
        const success = workspacesRes.status === 200 || workspacesRes.status === 401;
        errorRate.add(!success);
        userLatency.add(workspacesRes.timings.duration);
      });
      sleep(0.5);
    }

    export function setup() {
      console.log(`Starting User Service Test against ${BASE_URL}`);
      const healthRes = http.get(`${BASE_URL}/api/svc/user/health/live`, params);
      if (healthRes.status !== 200) console.error('User service is not healthy!');
      return { startTime: new Date().toISOString() };
    }

    export function teardown(data) {
      console.log(`User Service Test completed. Started at: ${data.startTime}`);
    }
{{- end }}
