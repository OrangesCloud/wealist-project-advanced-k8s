# =============================================================================
# weAlist Monitoring Stack - Default Values
# =============================================================================
# Prometheus, Grafana, Loki, Promtail 기반 모니터링 스택
#
# 환경별 설정은 values-develop-registry-local.yaml 등에서 오버라이드

# Global settings
global:
  namespace: wealist

# =============================================================================
# External Secrets (ESO) Configuration
# =============================================================================
# enabled: true → ExternalSecret에서 시크릿 가져옴 (staging/prod)
# enabled: false → values 또는 로컬 Secret 사용 (dev/localhost)
externalSecrets:
  enabled: false

# =============================================================================
# Prometheus - Metrics Collection
# =============================================================================
prometheus:
  enabled: true

  image:
    repository: prom/prometheus
    tag: "v2.48.0"
    pullPolicy: IfNotPresent

  replicas: 1

  service:
    type: ClusterIP
    port: 9090

  persistence:
    enabled: true
    storageClass: ""
    size: 10Gi
    # Kind/로컬 환경용 hostPath 설정
    hostPath:
      enabled: false
      path: /data/prometheus

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  config:
    scrapeInterval: 15s
    evaluationInterval: 15s
    retentionTime: 7d
    # Sub-path configuration (for Gateway access via /monitoring/prometheus)
    externalUrl: "/monitoring/prometheus"

  # Alert 규칙 및 Alertmanager 설정
  alerting:
    enabled: false  # Enable in production
    alertmanager:
      enabled: false
      host: alertmanager
      port: 9093

  # 스크래핑 대상 서비스들
  scrapeTargets:
    # Go Services
    userService:
      enabled: true
      host: user-service
      port: 8081
      path: /metrics
    boardService:
      enabled: true
      host: board-service
      port: 8000
      path: /metrics
    chatService:
      enabled: true
      host: chat-service
      port: 8001
      path: /metrics
    notiService:
      enabled: true
      host: noti-service
      port: 8002
      path: /metrics
    storageService:
      enabled: true
      host: storage-service
      port: 8003
      path: /metrics
    videoService:
      enabled: true
      host: video-service
      port: 8004
      path: /metrics
    # Spring Boot Service
    authService:
      enabled: true
      host: auth-service
      port: 8080
      path: /actuator/prometheus

# =============================================================================
# Loki - Log Aggregation
# =============================================================================
loki:
  enabled: true

  image:
    repository: grafana/loki
    tag: "2.9.2"
    pullPolicy: IfNotPresent

  replicas: 1

  service:
    type: ClusterIP
    port: 3100

  persistence:
    enabled: true
    storageClass: ""
    size: 10Gi

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  config:
    retentionPeriod: 168h  # 7 days
    ingestionRateMB: 10
    ingestionBurstSizeMB: 20

# =============================================================================
# Promtail - Log Collector
# =============================================================================
promtail:
  enabled: true

  image:
    repository: grafana/promtail
    tag: "2.9.2"
    pullPolicy: IfNotPresent

  resources:
    requests:
      memory: "64Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  config:
    # Loki endpoint
    lokiUrl: http://loki:3100/loki/api/v1/push

# =============================================================================
# Grafana - Visualization Dashboard
# =============================================================================
grafana:
  enabled: true

  image:
    repository: grafana/grafana
    tag: "10.2.2"
    pullPolicy: IfNotPresent

  replicas: 1

  service:
    type: ClusterIP
    port: 3000
    # NodePort for local access (Kind)
    nodePort: 30001

  persistence:
    enabled: true
    storageClass: ""
    size: 5Gi

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  # Admin credentials
  admin:
    user: admin
    password: admin  # Override in production!

  config:
    allowSignUp: false
    # Sub-path configuration (for Gateway access via /monitoring/grafana)
    # %(protocol)s://%(domain)s:%(http_port)s 는 Grafana가 자동으로 치환
    rootUrl: "%(protocol)s://%(domain)s:%(http_port)s/monitoring/grafana"
    serveFromSubPath: "true"

  # Additional Datasources (확장용)
  additionalDatasources:
    # Elasticsearch (ELK 스택 연동용)
    elasticsearch:
      enabled: false  # ELK 배포 시 true로 변경
      url: "http://elasticsearch:9200"
      index: "logstash-*"
      # Production에서는 AWS OpenSearch 사용 가능
      # url: "https://search-xxx.ap-northeast-2.es.amazonaws.com"

# =============================================================================
# Monitoring Ingress - External Access via domain/monitoring/*
# =============================================================================
# Note: Named 'monitoringIngress' to avoid conflict with infrastructure 'ingress'
monitoringIngress:
  enabled: false  # Enable in environments with Ingress controller
  className: nginx
  annotations: {}
  hosts: []
  # - host: dev.wealist.co.kr
  tls: []

# =============================================================================
# PostgreSQL Exporter - External PostgreSQL Metrics
# =============================================================================
postgresExporter:
  enabled: false  # Enable in environments with external PostgreSQL

  image:
    repository: prometheuscommunity/postgres-exporter
    tag: v0.15.0

  service:
    port: 9187

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  # Connection to external PostgreSQL
  config:
    host: "172.18.0.1"
    port: 5432
    user: "postgres"
    database: "postgres"
    sslmode: "disable"

# =============================================================================
# Redis Exporter - External Redis Metrics
# =============================================================================
redisExporter:
  enabled: false  # Enable in environments with external Redis

  image:
    repository: oliver006/redis_exporter
    tag: v1.55.0

  service:
    port: 9121

  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "64Mi"
      cpu: "50m"

  # Connection to external Redis
  config:
    host: "172.18.0.1"
    port: 6379

# =============================================================================
# ArgoCD Metrics
# =============================================================================
argocd:
  metrics:
    enabled: false  # Enable in prod environment

# =============================================================================
# Shared Secrets (for exporters)
# =============================================================================
shared:
  secrets:
    DB_PASSWORD: ""
    REDIS_PASSWORD: ""

# =============================================================================
# k6 Performance Testing Configuration
# =============================================================================
# k6 성능 테스트를 Kubernetes에서 실행하기 위한 설정
# 참고: https://grafana.com/docs/k6/latest/
k6:
  enabled: false  # Production에서만 true

  image:
    repository: grafana/k6
    tag: "0.49.0"
    pullPolicy: IfNotPresent

  # k6 Job 리소스 제한
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Prometheus Remote Write 설정
  # k6 실행 시 --out experimental-prometheus-rw 옵션 사용
  prometheus:
    remoteWriteUrl: "http://prometheus:9090/api/v1/write"

  # 테스트 시나리오 기본 설정
  scenarios:
    load:
      enabled: true
      duration: "5m"
      vus: 20
      description: "Normal load test"
    stress:
      enabled: true
      maxVUs: 300
      duration: "30m"
      description: "Stress test to find breaking point"
    spike:
      enabled: true
      peakVUs: 500
      duration: "10m"
      description: "Spike test for sudden traffic bursts"

  # 테스트 대상 서비스 엔드포인트
  endpoints:
    baseUrl: "http://istio-ingressgateway.istio-system.svc.cluster.local"
    services:
      - name: board
        path: /svc/board
        healthPath: /health/live
      - name: user
        path: /svc/user
        healthPath: /health/live
      - name: chat
        path: /svc/chat
        healthPath: /health/live
      - name: noti
        path: /svc/noti
        healthPath: /health/live
      - name: storage
        path: /svc/storage
        healthPath: /health/live
      - name: video
        path: /svc/video
        healthPath: /health/live

  # SLA 임계값 (Alert과 연동)
  thresholds:
    latencyP95Ms: 500
    latencyP99Ms: 1000
    errorRatePercent: 1
    availabilityPercent: 99.9
