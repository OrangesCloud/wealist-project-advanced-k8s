# =============================================================================
# ExternalSecret - Dev Shared Application Secrets
# =============================================================================
# AWS Secrets Manager에서 시크릿을 가져와 K8s Secret으로 생성
# Terraform으로 AWS Secrets Manager에 값 저장 후 ESO가 자동 동기화

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: wealist-shared-secret
  namespace: wealist-dev
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: wealist-shared-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # DATABASE_URL - Go 서비스용 (템플릿으로 자동 생성)
        DATABASE_URL: "postgresql://{{ .DB_USER }}:{{ .DB_PASSWORD }}@{{ .DB_HOST }}:{{ .DB_PORT }}/wealist?sslmode=disable"
        # 기존 값들도 그대로 전달
        DB_HOST: "{{ .DB_HOST }}"
        DB_PORT: "{{ .DB_PORT }}"
        DB_USER: "{{ .DB_USER }}"
        DB_USERNAME: "{{ .DB_USERNAME }}"
        DB_PASSWORD: "{{ .DB_PASSWORD }}"
        POSTGRES_HOST: "{{ .POSTGRES_HOST }}"
        REDIS_HOST: "{{ .REDIS_HOST }}"
        SPRING_REDIS_HOST: "{{ .SPRING_REDIS_HOST }}"
        REDIS_PASSWORD: "{{ .REDIS_PASSWORD }}"
        SPRING_REDIS_PASSWORD: "{{ .SPRING_REDIS_PASSWORD }}"
        JWT_SECRET: "{{ .JWT_SECRET }}"
        INTERNAL_API_KEY: "{{ .INTERNAL_API_KEY }}"
        GOOGLE_CLIENT_ID: "{{ .GOOGLE_CLIENT_ID }}"
        GOOGLE_CLIENT_SECRET: "{{ .GOOGLE_CLIENT_SECRET }}"
        LIVEKIT_API_KEY: "{{ .LIVEKIT_API_KEY }}"
        LIVEKIT_API_SECRET: "{{ .LIVEKIT_API_SECRET }}"
        S3_ACCESS_KEY: "{{ .S3_ACCESS_KEY }}"
        S3_SECRET_KEY: "{{ .S3_SECRET_KEY }}"
        # AWS SDK 표준 환경변수 (Go SDK가 이걸 찾음)
        AWS_ACCESS_KEY_ID: "{{ .S3_ACCESS_KEY }}"
        AWS_SECRET_ACCESS_KEY: "{{ .S3_SECRET_KEY }}"
        AWS_REGION: "ap-northeast-2"
        GRAFANA_ADMIN_USER: "{{ .GRAFANA_ADMIN_USER }}"
        GRAFANA_ADMIN_PASSWORD: "{{ .GRAFANA_ADMIN_PASSWORD }}"

  data:
    # -------------------------------------------------------------------------
    # Database Connection (External - RDS or Host)
    # -------------------------------------------------------------------------
    - secretKey: DB_HOST
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: host

    - secretKey: POSTGRES_HOST
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: host

    - secretKey: DB_PASSWORD
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: password

    - secretKey: DB_USERNAME
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: username

    # DB_USER는 DB_USERNAME과 동일 (서비스 호환성)
    - secretKey: DB_USER
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: username

    - secretKey: DB_PORT
      remoteRef:
        key: "wealist/dev/database/endpoint"
        property: port

    # -------------------------------------------------------------------------
    # Redis Connection (External - ElastiCache or Host)
    # -------------------------------------------------------------------------
    - secretKey: REDIS_HOST
      remoteRef:
        key: "wealist/dev/redis/endpoint"
        property: host

    - secretKey: SPRING_REDIS_HOST
      remoteRef:
        key: "wealist/dev/redis/endpoint"
        property: host

    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: "wealist/dev/redis/auth-token"

    - secretKey: SPRING_REDIS_PASSWORD
      remoteRef:
        key: "wealist/dev/redis/auth-token"

    # -------------------------------------------------------------------------
    # Application Secrets
    # -------------------------------------------------------------------------
    - secretKey: JWT_SECRET
      remoteRef:
        key: "wealist/dev/app/jwt-secret"

    - secretKey: INTERNAL_API_KEY
      remoteRef:
        key: "wealist/dev/app/internal-api-key"

    # -------------------------------------------------------------------------
    # OAuth2 Google
    # -------------------------------------------------------------------------
    - secretKey: GOOGLE_CLIENT_ID
      remoteRef:
        key: "wealist/dev/oauth/google"
        property: client_id

    - secretKey: GOOGLE_CLIENT_SECRET
      remoteRef:
        key: "wealist/dev/oauth/google"
        property: client_secret

    # -------------------------------------------------------------------------
    # LiveKit
    # -------------------------------------------------------------------------
    - secretKey: LIVEKIT_API_KEY
      remoteRef:
        key: "wealist/dev/livekit/credentials"
        property: api_key

    - secretKey: LIVEKIT_API_SECRET
      remoteRef:
        key: "wealist/dev/livekit/credentials"
        property: api_secret

    # -------------------------------------------------------------------------
    # MinIO / S3
    # -------------------------------------------------------------------------
    - secretKey: S3_ACCESS_KEY
      remoteRef:
        key: "wealist/dev/minio/credentials"
        property: access_key

    - secretKey: S3_SECRET_KEY
      remoteRef:
        key: "wealist/dev/minio/credentials"
        property: secret_key

    # -------------------------------------------------------------------------
    # Grafana Admin
    # -------------------------------------------------------------------------
    - secretKey: GRAFANA_ADMIN_USER
      remoteRef:
        key: "wealist/dev/monitoring/grafana"
        property: admin_user

    - secretKey: GRAFANA_ADMIN_PASSWORD
      remoteRef:
        key: "wealist/dev/monitoring/grafana"
        property: admin_password
