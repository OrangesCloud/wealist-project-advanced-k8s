# =============================================================================
# ExternalSecret - Shared Application Secrets
# =============================================================================
# AWS Secrets Manager에서 시크릿을 가져와 K8s Secret으로 생성
# 이 Secret은 모든 서비스에서 공유됨

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: wealist-shared-secret
  namespace: wealist-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: wealist-shared-secret
    creationPolicy: Owner

  data:
    # -------------------------------------------------------------------------
    # Database Connection (RDS)
    # -------------------------------------------------------------------------
    - secretKey: DB_HOST
      remoteRef:
        key: "wealist/prod/database/endpoint"
        property: host

    - secretKey: POSTGRES_HOST
      remoteRef:
        key: "wealist/prod/database/endpoint"
        property: host

    - secretKey: DB_PASSWORD
      remoteRef:
        key: "wealist/prod/database/endpoint"
        property: password

    - secretKey: DB_USERNAME
      remoteRef:
        key: "wealist/prod/database/endpoint"
        property: username

    # -------------------------------------------------------------------------
    # Redis Connection (ElastiCache)
    # -------------------------------------------------------------------------
    - secretKey: REDIS_HOST
      remoteRef:
        key: "wealist/prod/redis/endpoint"
        property: host

    # Spring Boot uses SPRING_REDIS_HOST
    - secretKey: SPRING_REDIS_HOST
      remoteRef:
        key: "wealist/prod/redis/endpoint"
        property: host

    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: "wealist/prod/redis/auth-token"

    # Spring Boot uses SPRING_REDIS_PASSWORD
    - secretKey: SPRING_REDIS_PASSWORD
      remoteRef:
        key: "wealist/prod/redis/auth-token"

    # -------------------------------------------------------------------------
    # Application Secrets (Terraform 자동 생성)
    # -------------------------------------------------------------------------
    - secretKey: JWT_SECRET
      remoteRef:
        key: "wealist/prod/app/jwt-secret"

    - secretKey: INTERNAL_API_KEY
      remoteRef:
        key: "wealist/prod/app/internal-api-key"

    # -------------------------------------------------------------------------
    # OAuth2 Google (Terraform placeholder → 수동 업데이트 필요)
    # -------------------------------------------------------------------------
    - secretKey: GOOGLE_CLIENT_ID
      remoteRef:
        key: "wealist/prod/oauth/google"
        property: client_id

    - secretKey: GOOGLE_CLIENT_SECRET
      remoteRef:
        key: "wealist/prod/oauth/google"
        property: client_secret

    # -------------------------------------------------------------------------
    # LiveKit (Terraform placeholder → 수동 업데이트 필요)
    # -------------------------------------------------------------------------
    - secretKey: LIVEKIT_API_KEY
      remoteRef:
        key: "wealist/prod/livekit/credentials"
        property: api_key

    - secretKey: LIVEKIT_API_SECRET
      remoteRef:
        key: "wealist/prod/livekit/credentials"
        property: api_secret

    # -------------------------------------------------------------------------
    # Grafana Admin (Terraform 자동 생성)
    # -------------------------------------------------------------------------
    - secretKey: GRAFANA_ADMIN_USER
      remoteRef:
        key: "wealist/prod/monitoring/grafana"
        property: admin_user

    - secretKey: GRAFANA_ADMIN_PASSWORD
      remoteRef:
        key: "wealist/prod/monitoring/grafana"
        property: admin_password
