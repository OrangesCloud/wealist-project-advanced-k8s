# =============================================================================
# ExternalSecret - ArgoCD Core Secret (argocd-secret)
# =============================================================================
# ArgoCD의 핵심 Secret을 ExternalSecret으로 관리
#
# 왜 ExternalSecret이 직접 생성해야 하는가?
#   1. Helm이 argocd-secret 생성 → ArgoCD가 prune으로 삭제 → Pod crash
#   2. creationPolicy: Owner로 ExternalSecret이 직접 관리하여 순환 문제 해결
#   3. Helm의 configs.secret.createSecret=false로 설정 필요
#
# AWS Secrets Manager 키:
#   - wealist/prod/argocd/server: { secretkey: "..." }
#   - wealist/prod/oauth/argocd: { client_id: "...", client_secret: "..." }
#
# Google Cloud Console OAuth 설정:
#   Redirect URI: https://argocd.wealist.co.kr/api/dex/callback

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-oauth-secret
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    # Dex는 argocd-secret에서만 $variable 참조 가능
    name: argocd-secret
    creationPolicy: Owner  # ExternalSecret이 Secret 생성/관리
    template:
      metadata:
        labels:
          app.kubernetes.io/name: argocd-secret
          app.kubernetes.io/part-of: argocd
      data:
        # server.secretkey는 ArgoCD 서버 인증에 필수
        server.secretkey: "{{ .server_secretkey }}"
        # Dex OAuth credentials
        dex.google.clientID: "{{ .dex_google_clientID }}"
        dex.google.clientSecret: "{{ .dex_google_clientSecret }}"

  data:
    # ArgoCD server secret key (AWS Secrets Manager에서 가져옴)
    - secretKey: server_secretkey
      remoteRef:
        key: "wealist/prod/argocd/server"
        property: secretkey
    # Dex OAuth credentials
    - secretKey: dex_google_clientID
      remoteRef:
        key: "wealist/prod/oauth/argocd"
        property: client_id

    - secretKey: dex_google_clientSecret
      remoteRef:
        key: "wealist/prod/oauth/argocd"
        property: client_secret
