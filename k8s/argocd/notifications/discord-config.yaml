apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Discord ì„œë¹„ìŠ¤ ì„¤ì •
  service.discord: |
    token: $discord-token
  
  # ë°°í¬ ì„±ê³µ í…œí”Œë¦¿
  template.app-deployed: |
    discord:
      title: "ğŸš€ ë°°í¬ ì™„ë£Œ"
      description: |
        **ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}
        **í™˜ê²½**: {{.app.metadata.labels.environment}}
        **ìƒíƒœ**: {{.app.status.health.status}}
        **ë™ê¸°í™”**: {{.app.status.sync.status}}
        **ë¦¬ë¹„ì „**: {{.app.status.sync.revision}}
        **ì‹œê°„**: {{.app.status.operationState.finishedAt}}
      color: 3066993
      fields:
      - name: "ğŸ”— ArgoCD"
        value: "[ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ê¸°]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})"
        inline: true
      - name: "ğŸ“Š ëª¨ë‹ˆí„°ë§"
        value: "[Grafana ëŒ€ì‹œë³´ë“œ](https://{{.app.metadata.labels.domain}}/api/monitoring/grafana)"
        inline: true

  # ë°°í¬ ì‹¤íŒ¨ í…œí”Œë¦¿
  template.app-sync-failed: |
    discord:
      title: "âŒ ë°°í¬ ì‹¤íŒ¨"
      description: |
        **ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}
        **í™˜ê²½**: {{.app.metadata.labels.environment}}
        **ì˜¤ë¥˜**: {{.app.status.operationState.message}}
        **ì‹œê°„**: {{.app.status.operationState.finishedAt}}
      color: 15158332
      fields:
      - name: "ğŸ”— ArgoCD"
        value: "[ë¬¸ì œ í™•ì¸í•˜ê¸°]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})"
        inline: true

  # ë°°í¬ ì‹œì‘ í…œí”Œë¦¿
  template.app-sync-running: |
    discord:
      title: "â³ ë°°í¬ ì‹œì‘"
      description: |
        **ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}
        **í™˜ê²½**: {{.app.metadata.labels.environment}}
        **ì‹œì‘ ì‹œê°„**: {{.app.status.operationState.startedAt}}
      color: 16776960

  # íŠ¸ë¦¬ê±° ì„¤ì •
  trigger.on-deployed: |
    - description: ë°°í¬ ì™„ë£Œ ì‹œ ì•Œë¦¼
      send:
      - app-deployed
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
  
  trigger.on-sync-failed: |
    - description: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']
  
  trigger.on-sync-running: |
    - description: ë°°í¬ ì‹œì‘ ì‹œ ì•Œë¦¼
      send:
      - app-sync-running
      when: app.status.operationState.phase in ['Running']

  # êµ¬ë… ì„¤ì • (Production ì•±ì—ë§Œ ì ìš©)
  subscriptions: |
    - recipients:
      - discord:prod-deployment-alerts
      triggers:
      - on-deployed
      - on-sync-failed
      - on-sync-running
      selector: metadata.labels.environment == 'production'
---
apiVersion: v1
kind: Secret
metadata:
  name: argocd-notifications-secret
  namespace: argocd
type: Opaque
stringData:
  # Discord Bot Token (GitHub Secretsì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
  discord-token: "YOUR_DISCORD_BOT_TOKEN"