apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # ArgoCD URL ì„¤ì •
  context: |
    argocdUrl: https://argocd.wealist.co.kr
  
  # Discord Webhook ì„œë¹„ìŠ¤ ì„¤ì • (ìˆ˜ì •ë¨!)
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json
  
  # ë°°í¬ ì„±ê³µ í…œí”Œë¦¿ (Discord webhook í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •)
  template.app-deployed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": "ğŸš€ **ë°°í¬ ì™„ë£Œ**\n\n**ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}\n**í™˜ê²½**: {{.app.metadata.namespace}}\n**ìƒíƒœ**: {{.app.status.health.status}}\n**ë™ê¸°í™”**: {{.app.status.sync.status}}\n**ë¦¬ë¹„ì „**: {{.app.status.sync.revision}}\n**ì‹œê°„**: {{.app.status.operationState.finishedAt}}"
          }
  
  # ë°°í¬ ì‹¤íŒ¨ í…œí”Œë¦¿ (Discord webhook í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •)
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": "âŒ **ë°°í¬ ì‹¤íŒ¨**\n\n**ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}\n**í™˜ê²½**: {{.app.metadata.namespace}}\n**ì˜¤ë¥˜**: {{.app.status.operationState.message}}\n**ì‹œê°„**: {{.app.status.operationState.finishedAt}}"
          }
  
  # ë°°í¬ ì‹œì‘ í…œí”Œë¦¿ (Discord webhook í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •)
  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": "â³ **ë°°í¬ ì‹œì‘**\n\n**ì• í”Œë¦¬ì¼€ì´ì…˜**: {{.app.metadata.name}}\n**í™˜ê²½**: {{.app.metadata.namespace}}\n**ì‹œì‘ ì‹œê°„**: {{.app.status.operationState.startedAt}}"
          }
  
  # íŠ¸ë¦¬ê±° ì„¤ì •
  trigger.on-deployed: |
    - description: ë°°í¬ ì™„ë£Œ ì‹œ ì•Œë¦¼
      send:
      - app-deployed
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
  
  trigger.on-sync-failed: |
    - description: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']
  
  trigger.on-sync-running: |
    - description: ë°°í¬ ì‹œì‘ ì‹œ ì•Œë¦¼
      send:
      - app-sync-running
      when: app.status.operationState.phase in ['Running']
# Note: ExternalSecret for discord webhook is defined in:
# k8s/argocd/base/external-secrets/prod/argocd-notifications-secret.yaml
# This ensures ESO is ready before creating the ExternalSecret