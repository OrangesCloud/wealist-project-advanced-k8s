# =============================================================================
# LiveKit Server - WebRTC SFU (Selective Forwarding Unit)
# =============================================================================
# video-service가 사용하는 실시간 비디오 통화 인프라
#
# 배포 순서:
# 1. external-secrets가 livekit-secrets 생성 (sync-wave: 1)
# 2. LiveKit 서버 배포 (sync-wave: 2)
# 3. video-service에서 LIVEKIT_HOST로 연결 (sync-wave: 5)
#
# 아키텍처:
# - video-service → LiveKit API (토큰 생성 불필요, SDK에서 직접)
# - Frontend → LiveKit WebSocket (wss://livekit.wealist.co.kr)
# - WebRTC Media → UDP 50000-60000
# =============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: livekit-prod
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    environment: production
    component: video-infrastructure
spec:
  project: wealist-prod
  source:
    # LiveKit 공식 Helm Chart
    repoURL: https://helm.livekit.io
    chart: livekit-server
    targetRevision: "1.7.2"  # 2024-12 stable
    helm:
      valuesObject:
        # =======================================================================
        # Deployment Configuration
        # =======================================================================
        replicaCount: 1

        # hostNetwork 필수: WebRTC UDP 트래픽을 직접 처리
        hostNetwork: true

        # Graceful Shutdown: 활성 세션 보호 (5시간)
        terminationGracePeriodSeconds: 18000

        # =======================================================================
        # API Keys Configuration
        # =======================================================================
        # wealist-livekit-keys 시크릿에서 API 키 로드
        storeKeysInSecret:
          enabled: true
          existingSecret: wealist-livekit-keys

        # =======================================================================
        # LiveKit Configuration
        # =======================================================================
        livekit:
          log_level: info

          # RTC 설정 (WebRTC 미디어 트래픽)
          rtc:
            use_external_ip: true
            port_range_start: 50000
            port_range_end: 60000
            tcp_port: 7881

          # Redis 설정 (ElastiCache)
          # envFrom으로 주입된 REDIS_HOST 환경변수 사용
          redis:
            address: "${REDIS_HOST}:6379"
            use_tls: true

          # Room 설정
          room:
            empty_timeout: 300
            max_participants: 100

        # =======================================================================
        # Kubernetes Resources
        # =======================================================================
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi

        # =======================================================================
        # Service Configuration
        # =======================================================================
        service:
          type: ClusterIP
          port: 7880

        # =======================================================================
        # Environment Variables (from Secrets)
        # =======================================================================
        # wealist-shared-secret에서 LiveKit 관련 환경변수 주입
        # - LIVEKIT_API_KEY
        # - LIVEKIT_API_SECRET
        # - REDIS_HOST
        envFrom:
          - secretRef:
              name: wealist-shared-secret

        # TURN 서버는 비활성화 (NAT 환경에서 필요시 별도 설정)
        turn:
          enabled: false

        # =======================================================================
        # Node Selector (hostNetwork 사용 시 노드당 1개만 배포 가능)
        # =======================================================================
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - livekit-server
                topologyKey: kubernetes.io/hostname

  destination:
    server: https://kubernetes.default.svc
    namespace: wealist-prod
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
