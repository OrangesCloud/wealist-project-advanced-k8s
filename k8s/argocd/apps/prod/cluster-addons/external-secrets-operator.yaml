# =============================================================================
# External Secrets Operator (sync-wave: -2)
# =============================================================================
# AWS Secrets Manager → Kubernetes Secrets 동기화
# 서비스가 시작되기 전에 완전히 준비되어야 함
# =============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-secrets-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: wealist-prod
  source:
    repoURL: https://charts.external-secrets.io
    chart: external-secrets
    targetRevision: "1.2.0"  # K8s 1.34 호환
    helm:
      valuesObject:
        # CRDs를 Helm으로 관리
        installCRDs: true
        crds:
          conversion:
            enabled: false  # v1beta1 → v1 conversion webhook 비활성화
        serviceAccount:
          create: true
          name: external-secrets
        # Webhook 안정화를 위한 리소스 설정
        webhook:
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
        certController:
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
  destination:
    server: https://kubernetes.default.svc
    namespace: external-secrets
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - Replace=true  # CRD 업그레이드 시 강제 교체
    retry:
      limit: 10
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 5m
