# =============================================================================
# Local Kind Cluster Environment
# =============================================================================
# For team members running on local Kind cluster (localhost)
# Namespace: wealist-kind-local

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  namespace: wealist-kind-local
  environment: local
  domain: localhost
  imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# cert-manager Configuration (Disabled for localhost)
# -----------------------------------------------------------------------------
certManager:
  enabled: false

# -----------------------------------------------------------------------------
# Deployment Settings
# -----------------------------------------------------------------------------

image:
  pullPolicy: Always  # Always pull for development
  tag: "latest"       # Local images use :latest tag

# -----------------------------------------------------------------------------
# Resources - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global resource override. Each service uses its own values:
# - Go services: 128Mi-256Mi (fast, low memory)
# - auth-service (Spring Boot): 512Mi-1Gi (JVM needs more memory)
# Overriding globally caused OOMKilled for Spring Boot services.

# -----------------------------------------------------------------------------
# Health Check - Use service-specific defaults
# -----------------------------------------------------------------------------
# Note: Removed global healthCheck override. Each service uses its own values:
# - Go services: 30s liveness, 10s readiness (fast startup)
# - auth-service (Spring Boot): 60s liveness, 45s readiness (slow startup)

# -----------------------------------------------------------------------------
# Security (Relaxed for local development)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: false

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: false
  runAsUser: 0  # Required for nginx (frontend) to run chown
  readOnlyRootFilesystem: false
  capabilities:
    drop: []  # Override base.yaml's drop ALL - local dev doesn't need strict caps

# -----------------------------------------------------------------------------
# Features Disabled for Local 로컬 환경에서의 설정
# -----------------------------------------------------------------------------
# 로컬 개발환경에서 서비스별 replica 설정
# 기본값은 각 서비스의 values.yaml에 정의됨 (현재 모두 1)
# 필요에 따라 여기서 오버라이드 가능

# 예시: auth-service만 2개로 늘리기
auth-service:
  replicaCount: 1
board-service:
  replicaCount: 1

# 예시: frontend 3개로 늘리기  
# frontend:
#   replicaCount: 3



autoscaling:
  enabled: false

serviceAccount:
  create: false

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# Database Configuration (local-kind specific)
# -----------------------------------------------------------------------------
# Use HOST PC's PostgreSQL and Redis instead of cluster's internal DB
# This ensures data persistence across cluster resets
#
# Prerequisites:
#   1. PostgreSQL installed on host (brew install postgresql / apt install postgresql)
#   2. Redis installed on host (brew install redis / apt install redis-server)
#   3. PostgreSQL pg_hba.conf allows connections from Docker network:
#      host    all    all    172.17.0.0/16    trust
#      host    all    all    172.18.0.0/16    trust
#   4. PostgreSQL postgresql.conf: listen_addresses = '*'
#   5. Redis redis.conf: bind 0.0.0.0, protected-mode no
#
# Note: Kind uses Docker bridge network (172.18.0.0/16)
#       172.18.0.1 is the gateway IP that Kind pods use to reach the host

postgres:
  enabled: false  # Disable internal PostgreSQL StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 5432

redis:
  enabled: false  # Disable internal Redis StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 6379

# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------
shared:
  config:
    ENV: "local"
    LOG_LEVEL: "debug"
    CORS_ORIGINS: "*"
    S3_PUBLIC_ENDPOINT: "http://localhost/minio"
    LIVEKIT_WS_URL: "ws://localhost/svc/livekit"
    # OAuth2 Redirect URLs (localhost, no TLS)
    OAUTH2_CLIENT_REDIRECT_URI: "http://localhost/oauth2/callback/google"
    OAUTH2_REDIRECT_URL_ENV: "http://localhost/oauth/callback"
    # Auto-migrate DB schema (local dev only)
    DB_AUTO_MIGRATE: "false"  # Disabled - external DB has existing data

    # External Database Configuration (Host PC's PostgreSQL/Redis)
    DB_HOST: "postgres"       # K8s Service name (routes to 172.18.0.1)
    DB_PORT: "5432"
    DB_USER: "postgres"
    DB_SSLMODE: "disable"
    REDIS_HOST: "redis"       # K8s Service name (routes to 172.18.0.1)
    REDIS_PORT: "6379"

  # Secrets for local-kind environment
  secrets:
    DB_PASSWORD: "postgres"
    REDIS_PASSWORD: ""

# -----------------------------------------------------------------------------
# Ingress (localhost, no TLS)
# Will be disabled when Istio is fully enabled
# -----------------------------------------------------------------------------
ingress:
  enabled: true  # Set to false when using Istio Gateway
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
  hosts:
    - host: localhost
  tls: []

# -----------------------------------------------------------------------------
# Istio Service Mesh (local-kind specific)
# -----------------------------------------------------------------------------
istio:
  enabled: true  # Enable Istio config deployment
  namespace: wealist-kind-local

  gateway:
    enabled: true
    name: wealist-gateway
    hosts:
      - "localhost"
      - "*"
    tls:
      enabled: false

  mtls:
    enabled: true
    mode: PERMISSIVE  # Allow both mTLS and plain HTTP during migration

  destinationRules:
    enabled: true

  authorizationPolicy:
    enabled: true
    denyAll: false  # Don't enforce deny-all in local

  jwtAuth:
    enabled: false  # Enable after JWKS endpoint is ready

  telemetry:
    tracing:
      enabled: true
      samplingPercentage: 100  # 100% for local debugging
    accessLogging:
      enabled: true

# =============================================================================
# Monitoring Stack (wealist-monitoring chart values)
# =============================================================================

# Grafana - Visualization Dashboard
grafana:
  enabled: true
  service:
    type: ClusterIP
    port: 3000
  config:
    allowSignUp: false
    # localhost 접속용 (sub-path 사용)
    rootUrl: "http://localhost/monitoring/grafana"
    serveFromSubPath: "true"

# Monitoring Ingress - localhost/monitoring/* 접근
monitoringIngress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
  hosts:
    - host: localhost
  tls: []
