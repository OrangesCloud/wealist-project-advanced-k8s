# Istio Configuration Chart
# Values are expected under 'istio:' key when using environment files

# Direct values (used when not using environment files)
enabled: true
namespace: wealist-kind-local

gateway:
  enabled: true
  name: wealist-gateway
  selector:
    istio: ingressgateway
  hosts:
    - "*"
  tls:
    enabled: false
    credentialName: wealist-tls
    mode: SIMPLE

virtualService:
  enabled: true
  hosts:
    - "*"
  routes:
    auth:
      prefix: /svc/auth
      host: auth-service
      port: 8080
      timeout: 30s
    user:
      prefix: /svc/user
      host: user-service
      port: 8081
      timeout: 30s
    board:
      prefix: /svc/board
      host: board-service
      port: 8000
      timeout: 3600s
    chat:
      prefix: /svc/chat
      host: chat-service
      port: 8001
      timeout: 3600s
    noti:
      prefix: /svc/noti
      host: noti-service
      port: 8002
      timeout: 3600s
    storage:
      prefix: /svc/storage
      host: storage-service
      port: 8003
      timeout: 300s
    video:
      prefix: /svc/video
      host: video-service
      port: 8004
      timeout: 3600s

mtls:
  enabled: true
  mode: STRICT

destinationRules:
  enabled: true
  loadBalancer:
    simple: ROUND_ROBIN  # ROUND_ROBIN, LEAST_CONN, RANDOM, PASSTHROUGH
  connectionPool:
    tcp:
      maxConnections: 100
      connectTimeout: 10s
    http:
      h2UpgradePolicy: UPGRADE
      http1MaxPendingRequests: 100
      http2MaxRequests: 1000
      maxRequestsPerConnection: 100
      maxRetries: 3
  outlierDetection:
    consecutive5xxErrors: 5
    consecutiveGatewayErrors: 5
    interval: 10s
    baseEjectionTime: 30s
    maxEjectionPercent: 50
    minHealthPercent: 30

retryPolicy:
  enabled: true
  attempts: 3
  perTryTimeout: 5s
  retryOn: gateway-error,connect-failure,refused-stream,retriable-4xx,reset

authorizationPolicy:
  enabled: true
  denyAll: true  # Zero Trust: deny by default, allow explicitly
  # Service-level authorization rules
  rules:
    # Which services each service can call
    board:
      allowedCallers:
        - user-service    # workspace validation
        - auth-service    # token validation
      allowedPaths:
        - /api/*
        - /health/*
        - /internal/*
    chat:
      allowedCallers:
        - user-service
        - auth-service
        - noti-service    # notification on new message
      allowedPaths:
        - /api/*
        - /health/*
        - /ws/*
    noti:
      allowedCallers:
        - user-service
        - auth-service
        - board-service   # board notifications
        - chat-service    # chat notifications
      allowedPaths:
        - /api/*
        - /health/*
        - /internal/*
        - /sse/*
    storage:
      allowedCallers:
        - user-service
        - auth-service
        - board-service   # file attachments
        - chat-service    # media uploads
      allowedPaths:
        - /api/*
        - /health/*
    video:
      allowedCallers:
        - user-service
        - auth-service
      allowedPaths:
        - /api/*
        - /health/*

jwtAuth:
  # Set to true when auth-service exposes JWKS endpoint
  # Current: Each service validates JWT in middleware
  enabled: false
  issuer: wealist-auth-service
  # JWKS endpoint from auth-service (Spring Boot)
  # TODO: Configure auth-service to expose JWKS endpoint
  jwksUri: "http://auth-service.wealist-kind-local.svc.cluster.local:8080/.well-known/jwks.json"
  # Alternative: local JWKS URI if auth-service supports it
  # jwksUri: "http://auth-service:8080/.well-known/jwks.json"
  # Public paths that don't require JWT
  excludePaths:
    - /health/*
    - /actuator/health/*
    - /oauth2/*
    - /login/oauth2/*
    - /api/auth/login
    - /api/auth/register
    - /api/auth/refresh
    - /api/auth/oauth2/*
    - /  # Frontend static files

telemetry:
  tracing:
    enabled: true
    samplingPercentage: 100
    provider: jaeger
  accessLogging:
    enabled: true
    provider: envoy

services:
  - name: auth-service
    port: 8080
  - name: user-service
    port: 8081
  - name: board-service
    port: 8000
  - name: chat-service
    port: 8001
  - name: noti-service
    port: 8002
  - name: storage-service
    port: 8003
  - name: video-service
    port: 8004
  - name: frontend
    port: 80
