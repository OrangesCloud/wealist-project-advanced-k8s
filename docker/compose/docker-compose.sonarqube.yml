# =============================================================================
# weAlist Project - SonarQube Standalone Environment
# =============================================================================
# SonarQube 코드 품질 분석만을 위한 경량화된 Docker Compose 설정입니다.
#
# 사용법:
#   ./docker/scripts/sonar.sh up
#   또는
#   make sonar-up
# =============================================================================

services:
  # ===========================================================================
  # SonarQube - Code Quality & Security Analysis
  # ===========================================================================
  sonarqube:
    image: sonarqube:10.3-community
    container_name: wealist-sonarqube-standalone
    hostname: sonarqube
    ports:
      - "${SONARQUBE_PORT:-9000}:9000"

    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://postgres:5432/${SONARQUBE_DB_NAME}
      - SONAR_JDBC_USERNAME=${SONARQUBE_DB_USER}
      - SONAR_JDBC_PASSWORD=${SONARQUBE_DB_PASSWORD}
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true

    volumes:
      - sonarqube-data:/opt/sonarqube/data
      - sonarqube-extensions:/opt/sonarqube/extensions
      - sonarqube-logs:/opt/sonarqube/logs

    networks:
      - sonarqube-standalone-net

    depends_on:
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/api/system/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # PostgreSQL Database (SonarQube 전용)
  # ===========================================================================
  postgres:
    image: postgres:17-alpine
    container_name: wealist-postgres-sonarqube
    hostname: postgres
    ports:
      - "5433:5432"  # 기존 환경과 포트 충돌 방지 (호스트:컨테이너)

    environment:
      - POSTGRES_USER=${POSTGRES_SUPERUSER}
      - POSTGRES_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - POSTGRES_INITDB_ARGS=--locale-provider=icu --icu-locale=en-US
      - POSTGRES_HOST_AUTH_METHOD=trust
      - SONARQUBE_DB_NAME=${SONARQUBE_DB_NAME}
      - SONARQUBE_DB_USER=${SONARQUBE_DB_USER}
      - SONARQUBE_DB_PASSWORD=${SONARQUBE_DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata

    volumes:
      - postgres-sonarqube-data:/var/lib/postgresql/data
      - ../init/postgres/init-sonarqube-db.sh:/docker-entrypoint-initdb.d/init-sonarqube-db.sh:ro

    networks:
      - sonarqube-standalone-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    user: postgres

# =============================================================================
# Networks (독립적인 네트워크)
# =============================================================================
networks:
  sonarqube-standalone-net:
    driver: bridge
    name: wealist-sonarqube-standalone-net

# =============================================================================
# Volumes (기존 볼륨 재사용)
# =============================================================================
volumes:
  postgres-sonarqube-data:
    name: wealist-postgres-sonarqube-data
    external: true  # SonarQube 전용 PostgreSQL 볼륨

  sonarqube-data:
    name: wealist-sonarqube-data
    external: true  # 기존 볼륨 재사용

  sonarqube-extensions:
    name: wealist-sonarqube-extensions
    external: true  # 기존 볼륨 재사용

  sonarqube-logs:
    name: wealist-sonarqube-logs
    external: true  # 기존 볼륨 재사용