server {
    listen 80;
    server_name localhost;

    # Docker DNS resolver (127.0.0.11) with short cache TTL
    # This allows nginx to re-resolve service names when containers restart
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    # ===================================
    # Health Check Endpoint (NGINX 자체)
    # ===================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ===================================
    # API Gateway Routes
    # ===================================

    # Auth Service (토큰 관리 전용)
    location /api/auth {
        proxy_pass http://auth-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OAuth2 Login (auth-service)
    location /oauth2 {
        proxy_pass http://auth-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OAuth2 Callback (auth-service)
    location /oauth2/callback {
        proxy_pass http://auth-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # User Service
    location /api/users {
        proxy_pass http://user-service:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Board Service (WebSocket 전용 - /api/boards prefix 제거)
    location /api/boards/ws/ {
        rewrite ^/api/boards(.*)$ $1 break;
        proxy_pass http://board-service:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;  # 24시간
    }

    # Board Service (HTTP API)
    location /api/boards {
        rewrite ^/api/boards(.*)$ /api$1 break;
        proxy_pass http://board-service:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Chat Service
    location /api/chats {
        proxy_pass http://chat-service:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 지원 (중요!)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;  # 24시간
    }

    # Notification Service
    location /api/notifications {
        proxy_pass http://noti-service:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 지원 (중요!)
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;  # 24시간 (SSE 연결 유지)
        chunked_transfer_encoding off;
    }

    # Notification Service - Internal API (서비스 간 통신)
    location /api/internal/notifications {
        proxy_pass http://noti-service:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Storage Service (Google Drive like storage)
    location /api/storage {
        proxy_pass http://storage-service:8003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 파일 업로드를 위한 설정
        client_max_body_size 100M;
    }

    # Storage Service - Public API (공유 링크 접근)
    location /api/public/storage {
        proxy_pass http://storage-service:8003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Video Service (Video Call Room Management)
    location /api/video {
        proxy_pass http://video-service:8004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # LiveKit WebSocket Proxy (for video calls)
    location /livekit {
        proxy_pass http://livekit:7880;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 지원 (필수!)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;  # 24시간
    }

    # ===================================
    # MinIO Proxy (S3 Compatible Storage)
    # Presigned URL 접근용 (브라우저 → nginx → MinIO)
    # ===================================
    location /minio/ {
        # /minio/bucket/key → minio:9000/bucket/key
        rewrite ^/minio/(.*)$ /$1 break;
        proxy_pass http://minio:9000;
        proxy_set_header Host minio:9000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 파일 다운로드/업로드를 위한 설정
        client_max_body_size 100M;
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Default response
    location / {
        return 404 '{"error":"Not Found"}\n';
        add_header Content-Type application/json;
    }
}
