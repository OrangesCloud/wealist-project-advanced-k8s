# 아키텍처 개요

## 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              EXTERNAL                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │CloudFront│  │  Google  │  │   S3     │  │ LiveKit  │  │  Secrets │       │
│  │  (CDN)   │  │  OAuth   │  │          │  │  (SFU)   │  │  Manager │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
└───────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┘
        │             │             │             │             │
        ▼             │             │             │             │
┌─────────────────────┼─────────────┼─────────────┼─────────────┼─────────────┐
│  AWS Cloud          │             │             │             │             │
│  ┌──────────────────┼─────────────┼─────────────┼─────────────┼───────────┐ │
│  │  VPC             │             │             │             │           │ │
│  │  ┌───────────────▼─────────────▼─────────────▼─────────────▼─────────┐ │ │
│  │  │              Network Load Balancer (NLB)                          │ │ │
│  │  │              - TLS Termination                                    │ │ │
│  │  │              - Health Check                                       │ │ │
│  │  └───────────────────────────────┬───────────────────────────────────┘ │ │
│  │                                  │                                     │ │
│  │  ┌───────────────────────────────▼───────────────────────────────────┐ │ │
│  │  │              Istio Ingress Gateway                                │ │ │
│  │  │              - Path-based Routing                                 │ │ │
│  │  │              - JWT Validation                                     │ │ │
│  │  └───────────────────────────────┬───────────────────────────────────┘ │ │
│  │                                  │                                     │ │
│  │  ┌───────────────────────────────▼───────────────────────────────────┐ │ │
│  │  │                    EKS CLUSTER                                    │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐  │ │ │
│  │  │  │                  SERVICE MESH (Istio Sidecar)               │  │ │ │
│  │  │  │                                                             │  │ │ │
│  │  │  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐            │  │ │ │
│  │  │  │  │  auth  │  │  user  │  │ board  │  │  chat  │            │  │ │ │
│  │  │  │  │ :8080  │  │ :8081  │  │ :8000  │  │ :8001  │            │  │ │ │
│  │  │  │  │ (Java) │  │  (Go)  │  │  (Go)  │  │  (Go)  │            │  │ │ │
│  │  │  │  └────────┘  └────────┘  └────────┘  └────────┘            │  │ │ │
│  │  │  │                                                             │  │ │ │
│  │  │  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐            │  │ │ │
│  │  │  │  │  noti  │  │storage │  │  ops   │  │  ops-  │            │  │ │ │
│  │  │  │  │ :8002  │  │ :8003  │  │ :8005  │  │ portal │            │  │ │ │
│  │  │  │  │  (Go)  │  │  (Go)  │  │ (Java) │  │(React) │            │  │ │ │
│  │  │  │  └────────┘  └────────┘  └────────┘  └────────┘            │  │ │ │
│  │  │  │                                                             │  │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘  │ │ │
│  │  │                                │                                  │ │ │
│  │  │  ┌─────────────────────────────▼─────────────────────────────────┐│ │ │
│  │  │  │                   DATA LAYER                                  ││ │ │
│  │  │  │  ┌────────────────────┐  ┌────────────────────┐               ││ │ │
│  │  │  │  │   PostgreSQL RDS   │  │   ElastiCache      │               ││ │ │
│  │  │  │  │   (5 databases)    │  │   (Redis)          │               ││ │ │
│  │  │  │  └────────────────────┘  └────────────────────┘               ││ │ │
│  │  │  └───────────────────────────────────────────────────────────────┘│ │ │
│  │  │                         wealist-prod namespace                    │ │ │
│  │  └───────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 서비스 아키텍처

### 마이크로서비스 구성

| 서비스 | 기술 | 포트 | 역할 |
|--------|------|------|------|
| **auth-service** | Spring Boot 3.4 | 8080 | JWT 발급/검증, OAuth2 |
| **user-service** | Go + Gin | 8081 | 사용자, 워크스페이스 관리 |
| **board-service** | Go + Gin | 8000 | 프로젝트, 보드, 태스크 |
| **chat-service** | Go + Gin | 8001 | 실시간 채팅 (WebSocket) |
| **noti-service** | Go + Gin | 8002 | 실시간 알림 (SSE) |
| **storage-service** | Go + Gin | 8003 | 파일 업로드/다운로드 |
| **ops-service** | Spring Boot 3.4 | 8005 | 운영 API |
| **ops-portal** | React | 3001 | 운영 대시보드 UI |

### 데이터베이스 구성

| 데이터베이스 | 서비스 | 용도 |
|-------------|--------|------|
| user_db | user-service | 사용자, 워크스페이스 |
| board_db | board-service | 프로젝트, 보드, 태스크, 댓글 |
| chat_db | chat-service | 채팅방, 메시지 |
| noti_db | noti-service | 알림 |
| storage_db | storage-service | 파일 메타데이터 |

---

## 서비스 의존성 매트릭스

| From \ To | auth | user | board | chat | noti | storage | S3 | Redis | DB |
|-----------|:----:|:----:|:-----:|:----:|:----:|:-------:|:---:|:-----:|:--:|
| **auth**  | -    |      |       |      |      |         |     | ✓     |    |
| **user**  | ✓    | -    |       |      |      |         | ✓   | ✓     | ✓  |
| **board** | ✓    | ✓    | -     |      | ✓    |         | ✓   | ✓     | ✓  |
| **chat**  |      | ✓    |       | -    | ✓    |         |     | ✓     | ✓  |
| **noti**  |      |      |       |      | -    |         |     | ✓     | ✓  |
| **storage**|     | ✓    |       |      |      | -       | ✓   | ✓     | ✓  |
| **ops**   |      |      |       |      |      |         |     |       | ✓  |

### 의존성 설명

- **auth → Redis**: JWT 토큰 블랙리스트, 세션 관리
- **user → auth**: JWT 검증 (JWKS)
- **user → S3**: 프로필 이미지 저장
- **board → user**: 사용자 정보 조회, 권한 확인
- **board → noti**: 태스크 변경 알림 발송
- **chat → noti**: 새 메시지 알림 발송
- **storage → user**: 워크스페이스 멤버십 확인
- **storage → S3**: 파일 저장/조회

---

## 통신 패턴

### 동기 통신 (HTTP/REST)

```
┌────────────┐     HTTP      ┌────────────┐
│   Client   │ ───────────▶  │  Service   │
│            │ ◀───────────  │            │
└────────────┘   Response    └────────────┘
```

- **용도**: CRUD 작업, 데이터 조회
- **프로토콜**: HTTP/1.1, HTTP/2 (Istio)
- **인증**: JWT Bearer Token

### 비동기 통신 (WebSocket)

```
┌────────────┐   WebSocket   ┌────────────┐
│   Client   │ ◀═══════════▶ │chat-service│
└────────────┘   Full-duplex └────────────┘
```

- **용도**: 실시간 채팅
- **프로토콜**: WebSocket
- **연결 유지**: Redis Pub/Sub

### 서버 전송 이벤트 (SSE)

```
┌────────────┐      SSE      ┌────────────┐
│   Client   │ ◀───────────  │noti-service│
└────────────┘   One-way     └────────────┘
```

- **용도**: 실시간 알림
- **프로토콜**: Server-Sent Events
- **장점**: HTTP 호환, 자동 재연결

---

## 인증 흐름

### JWT 발급 및 검증

```
┌─────────┐    ┌──────────────┐    ┌─────────────┐
│ Client  │    │ auth-service │    │ Google OAuth│
└────┬────┘    └──────┬───────┘    └──────┬──────┘
     │                │                    │
     │ 1. OAuth Login │                    │
     │───────────────▶│                    │
     │                │ 2. Redirect        │
     │                │───────────────────▶│
     │                │                    │
     │                │ 3. Auth Code       │
     │                │◀───────────────────│
     │                │                    │
     │ 4. JWT Token   │                    │
     │◀───────────────│                    │
     │                │                    │
```

### Istio JWT 모드

```
┌─────────┐    ┌─────────────┐    ┌────────────┐    ┌─────────────┐
│ Client  │    │Istio Gateway│    │Go Service  │    │auth-service │
└────┬────┘    └──────┬──────┘    └─────┬──────┘    └──────┬──────┘
     │                │                 │                  │
     │ Request+JWT    │                 │                  │
     │───────────────▶│                 │                  │
     │                │ 1. Validate JWT │                  │
     │                │─────────────────│──────────────────▶
     │                │   (JWKS)        │                  │
     │                │                 │                  │
     │                │ 2. Forward      │                  │
     │                │ (claims header) │                  │
     │                │────────────────▶│                  │
     │                │                 │                  │
     │                │                 │ 3. Parse claims  │
     │                │                 │ (no validation)  │
     │                │                 │                  │
```

---

## 배포 아키텍처

### GitOps 워크플로우

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  GitHub  │───▶│  GitHub  │───▶│   ECR    │───▶│  ArgoCD  │
│   Push   │    │ Actions  │    │  Push    │    │   Sync   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                      │
                                                      ▼
                                                ┌──────────┐
                                                │   EKS    │
                                                │ Cluster  │
                                                └──────────┘
```

### 환경별 구성

| 환경 | 네임스페이스 | 특징 |
|------|-------------|------|
| localhost | wealist-localhost | Kind 클러스터, 내부 DB |
| dev | wealist-dev | EKS, AWS 인프라 |
| prod | wealist-prod | EKS, RDS, ElastiCache |

---

## 관련 문서

- [기술 스택 상세](./tech-stack.md)
- [서비스 다이어그램](./service-diagram.drawio)
- [API 명세서](../02-api-spec/README.md)
