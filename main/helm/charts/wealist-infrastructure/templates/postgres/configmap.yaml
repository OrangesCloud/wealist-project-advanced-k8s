{{- if .Values.postgres.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "wealist-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres
data:
  init-db.sh: |
    #!/bin/bash
    set -e

    # Create databases for each service
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
        -- Create databases
        {{- range .Values.postgres.config.databases }}
        CREATE DATABASE {{ .name }};
        {{- end }}

        -- Create users for each service
        {{- range .Values.postgres.config.databases }}
        CREATE USER {{ .user }} WITH PASSWORD '{{ .password }}';
        {{- end }}

        -- Grant privileges
        {{- range .Values.postgres.config.databases }}
        GRANT ALL PRIVILEGES ON DATABASE {{ .name }} TO {{ .user }};
        {{- end }}
    EOSQL

    # Grant schema privileges for each database
    {{- range .Values.postgres.config.databases }}
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -d "{{ .name }}" <<-EOSQL
        GRANT ALL ON SCHEMA public TO {{ .user }};
        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO {{ .user }};
        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO {{ .user }};
    EOSQL
    {{- end }}

    echo "Database initialization completed!"
{{- end }}
