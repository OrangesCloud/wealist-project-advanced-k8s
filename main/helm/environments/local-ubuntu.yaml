# =============================================================================
# Local Ubuntu Development Environment
# =============================================================================
# For local PC Ubuntu with local.wealist.co.kr domain
# Namespace: wealist-dev

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  namespace: wealist-dev
  environment: develop
  domain: local.wealist.co.kr
  imageRegistry: localhost:5001

# -----------------------------------------------------------------------------
# cert-manager Configuration (TLS with Let's Encrypt)
# -----------------------------------------------------------------------------
# Uses HTTP01 challenge - no AWS credentials needed!
# Just requires port 80 accessible from internet
certManager:
  enabled: true
  installCertManager: true

  issuer:
    name: letsencrypt-prod
    email: ressk4149@gmail.com
    server: "https://acme-v02.api.letsencrypt.org/directory"

  solver:
    type: http01  # Simple! No AWS keys needed
    http01:
      ingressClass: nginx

# -----------------------------------------------------------------------------
# Deployment Settings
# -----------------------------------------------------------------------------
replicaCount: 1

image:
  pullPolicy: Always  # Always pull for development
  tag: "latest"       # Local images use :latest tag

# -----------------------------------------------------------------------------
# Resources (Development-friendly)
# -----------------------------------------------------------------------------
resources:
  requests:
    memory: "128Mi"
    cpu: "50m"
  limits:
    memory: "256Mi"
    cpu: "200m"

# -----------------------------------------------------------------------------
# Health Check (Faster startup in dev)
# -----------------------------------------------------------------------------
healthCheck:
  liveness:
    initialDelaySeconds: 15
  readiness:
    initialDelaySeconds: 5

# -----------------------------------------------------------------------------
# Security (Relaxed for development)
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: false

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: false
  runAsUser: 0  # Required for nginx to run setgid
  readOnlyRootFilesystem: false
  capabilities:
    drop: []  # Override base.yaml's drop ALL - nginx needs SETGID

# -----------------------------------------------------------------------------
# Features Disabled for Development
# -----------------------------------------------------------------------------
autoscaling:
  enabled: false

serviceAccount:
  create: false

networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false

# -----------------------------------------------------------------------------
# Database Configuration (local-ubuntu specific)
# -----------------------------------------------------------------------------
# Use LOCAL PC's PostgreSQL and Redis instead of cluster's internal DB
# This ensures data persistence across cluster resets
#
# Prerequisites:
#   1. PostgreSQL installed on host: sudo apt install postgresql
#   2. Redis installed on host: sudo apt install redis-server
#   3. PostgreSQL pg_hba.conf allows connections from Docker network:
#      host    all    all    172.17.0.0/16    md5
#   4. PostgreSQL postgresql.conf: listen_addresses = '*'
#   5. Redis redis.conf: bind 0.0.0.0, protected-mode no
#
# Note: Kind uses its own bridge network (172.18.0.0/16)
#       172.18.0.1 is the gateway IP that Kind pods use to reach the host
#       (Check with: docker exec wealist-control-plane ip route | grep default)

postgres:
  enabled: false  # Disable internal PostgreSQL StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 5432

redis:
  enabled: false  # Disable internal Redis StatefulSet
  external:
    enabled: true
    host: "172.18.0.1"  # Kind bridge gateway (host machine)
    port: 6379

# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------
shared:
  config:
    ENV: "dev"
    LOG_LEVEL: "debug"
    CORS_ORIGINS: "https://local.wealist.co.kr,http://localhost:3000"
    S3_PUBLIC_ENDPOINT: "https://local.wealist.co.kr/minio"
    LIVEKIT_WS_URL: "wss://local.wealist.co.kr/svc/livekit"
    # OAuth2 Redirect URLs (local.wealist.co.kr with TLS)
    OAUTH2_CLIENT_REDIRECT_URI: "https://local.wealist.co.kr/login/oauth2/code/google"
    OAUTH2_REDIRECT_URL_ENV: "https://local.wealist.co.kr/oauth/callback"
    # Database Migration (disabled - external DB has existing data)
    # 최초 배포 시만: helm install ... --set shared.config.DB_AUTO_MIGRATE=true
    DB_AUTO_MIGRATE: "false"

    # External Database Configuration (Local PC's PostgreSQL/Redis)
    # Services connect to "postgres" and "redis" K8s services which route to host
    DB_HOST: "postgres"       # K8s Service name (routes to 172.17.0.1)
    DB_PORT: "5432"
    DB_USER: "postgres"       # Local PC PostgreSQL superuser
    DB_SSLMODE: "disable"
    REDIS_HOST: "redis"       # K8s Service name (routes to 172.17.0.1)
    REDIS_PORT: "6379"

  # Secrets for local-ubuntu environment (stored in K8s Secret)
  secrets:
    DB_PASSWORD: "postgres"   # Local PC PostgreSQL password
    REDIS_PASSWORD: ""        # No password for local Redis

# -----------------------------------------------------------------------------
# Ingress (local.wealist.co.kr with TLS via cert-manager)
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: local.wealist.co.kr
  tls:
    - secretName: local-wealist-tls
      hosts:
        - local.wealist.co.kr
